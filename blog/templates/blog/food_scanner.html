<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üçé Ovqat Skaneri - AI Tahlil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .back-btn {
            color: #4ade80;
            text-decoration: none;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-right {
            width: 60px;
        }
        
        /* Camera Container */
        .camera-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: #000;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #capturedImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        /* Instruction Text */
        .instruction-box {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            padding: 15px 25px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
        }
        
        .instruction-box h2 {
            font-size: 1.3rem;
            margin-bottom: 8px;
        }
        
        .instruction-box p {
            font-size: 0.9rem;
            color: #9ca3af;
            line-height: 1.5;
        }
        
        /* Bottom Controls */
        .bottom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 20px 50px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
        }
        
        /* Mode Switcher */
        .mode-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .mode-toggle {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 4px;
        }
        
        .mode-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 0.9rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .mode-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* Capture Button */
        .capture-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .side-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .capture-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: transparent;
            border: 4px solid #4ade80;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .capture-btn:active {
            transform: scale(0.95);
        }
        
        .capture-btn-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #4ade80;
            transition: all 0.2s;
        }
        
        .capture-btn:hover .capture-btn-inner {
            background: #22c55e;
        }
        
        /* Retake button */
        .retake-btn {
            display: none;
            padding: 12px 30px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 15px;
        }
        
        .analyze-btn {
            display: none;
            padding: 12px 30px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            color: white;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .action-row {
            display: none;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Result Panel */
        .result-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            z-index: 200;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s ease;
        }
        
        .result-panel.show {
            transform: translateY(0);
        }
        
        .result-header {
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, #0a0a0a, transparent);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }
        
        .result-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
        }
        
        .result-content {
            padding: 0 20px 100px;
        }
        
        /* Product Card */
        .product-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .product-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .product-image-box {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .product-image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-info h1 {
            font-size: 1.4rem;
            margin-bottom: 8px;
        }
        
        .product-info .category {
            display: inline-block;
            padding: 5px 12px;
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .product-info .description {
            color: #9ca3af;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Nutri-Score */
        .nutriscore-bar {
            display: flex;
            gap: 5px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .ns-item {
            width: 45px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border-radius: 10px;
            opacity: 0.3;
            transition: all 0.3s;
        }
        
        .ns-item.active {
            opacity: 1;
            transform: scale(1.2);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
        
        .ns-a { background: #038141; color: white; }
        .ns-b { background: #85bb2f; color: white; }
        .ns-c { background: #fecb02; color: #333; }
        .ns-d { background: #ee8100; color: white; }
        .ns-e { background: #e63e11; color: white; }
        
        /* Calorie Circle */
        .calorie-section {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .calorie-circle {
            position: relative;
            width: 180px;
            height: 180px;
        }
        
        .calorie-circle svg {
            transform: rotate(-90deg);
        }
        
        .cal-bg {
            fill: none;
            stroke: rgba(255,255,255,0.1);
            stroke-width: 15;
        }
        
        .cal-progress {
            fill: none;
            stroke: url(#calGradient);
            stroke-width: 15;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }
        
        .calorie-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .calorie-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .calorie-label {
            color: #9ca3af;
            font-size: 0.9rem;
        }
        
        /* Macros */
        .macros-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        
        .macro-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }
        
        .macro-circle {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
        }
        
        .macro-circle svg {
            transform: rotate(-90deg);
        }
        
        .macro-bg {
            fill: none;
            stroke: rgba(255,255,255,0.1);
            stroke-width: 6;
        }
        
        .macro-progress {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
        }
        
        .macro-progress.protein { stroke: #10b981; }
        .macro-progress.carbs { stroke: #f59e0b; }
        .macro-progress.fat { stroke: #ef4444; }
        
        .macro-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .macro-name {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        
        .macro-name.protein { color: #10b981; }
        .macro-name.carbs { color: #f59e0b; }
        .macro-name.fat { color: #ef4444; }
        
        .macro-percent {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        /* Info Sections */
        .info-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .info-section h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-section h3 .icon {
            font-size: 1.3rem;
        }
        
        /* Benefits & Risks */
        .benefit-item, .risk-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .benefit-item:last-child, .risk-item:last-child {
            border-bottom: none;
        }
        
        .benefit-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            background: rgba(34, 197, 94, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .risk-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .benefit-text, .risk-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Storage Info */
        .storage-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .storage-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
        }
        
        .storage-item .label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .storage-item .value {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        /* Nutrition Details */
        .nutrition-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .nutrition-row:last-child {
            border-bottom: none;
        }
        
        .nutrition-row .name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nutrition-row .icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .nutrition-row .value {
            font-weight: 600;
        }
        
        .nutrition-row .daily {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        /* Time Recommendation */
        .time-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            font-size: 0.95rem;
        }
        
        /* Tags */
        .tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tag {
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .tag.organic { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .tag.vegan { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .tag.gluten-free { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.1rem;
            color: #9ca3af;
        }
        
        .loading-subtext {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 10px;
        }
        
        /* Error */
        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px;
        }
        
        .error-box .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .error-box h3 {
            margin-bottom: 10px;
            color: #fca5a5;
        }
        
        .error-box p {
            color: #9ca3af;
            font-size: 0.9rem;
        }
        
        /* Hidden file input */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <a href="/" class="back-btn">
            <span>‚Äπ</span> Orqaga
        </a>
        <div class="header-title">Ovqat Skaneri</div>
        <div class="header-right"></div>
    </div>
    
    <!-- Camera Container -->
    <div class="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <img id="capturedImage" alt="Captured">
        
        <div class="camera-overlay">
            <!-- Instruction -->
            <div class="instruction-box" id="instructionBox">
                <h2>üì∑ Rasm oling</h2>
                <p>Ovqat yoki mahsulotni kameraga ko'rsating,<br>AI tahlil qilib beradi</p>
            </div>
        </div>
        
        <!-- Bottom Controls -->
        <div class="bottom-controls">
            <!-- Mode Switcher -->
            <div class="mode-switcher">
                <div class="mode-toggle">
                    <button class="mode-btn active" id="cameraMode">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 15.2c1.77 0 3.2-1.43 3.2-3.2S13.77 8.8 12 8.8 8.8 10.23 8.8 12s1.43 3.2 3.2 3.2zm9-9.2h-3.79l-2.21-2H9l-2.21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                        </svg>
                        Kamera
                    </button>
                    <button class="mode-btn" id="barcodeMode">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2 6h2v12H2V6zm3 0h1v12H5V6zm2 0h3v12H7V6zm4 0h1v12h-1V6zm3 0h2v12h-2V6zm3 0h1v12h-1V6zm2 0h3v12h-3V6z"/>
                        </svg>
                        Shtrix kod
                    </button>
                </div>
            </div>
            
            <!-- Capture Row -->
            <div class="capture-row" id="captureRow">
                <button class="side-btn" id="galleryBtn">üñºÔ∏è</button>
                <button class="capture-btn" id="captureBtn">
                    <div class="capture-btn-inner"></div>
                </button>
                <button class="side-btn" id="flashBtn">‚ö°</button>
            </div>
            
            <!-- Action Row (after capture) -->
            <div class="action-row" id="actionRow">
                <button class="retake-btn" id="retakeBtn">‚Ü©Ô∏è Qayta olish</button>
                <button class="analyze-btn" id="analyzeBtn">üîç Tahlil qilish</button>
            </div>
        </div>
    </div>
    
    <!-- Result Panel -->
    <div class="result-panel" id="resultPanel">
        <div class="result-header">
            <button class="result-close" id="closeResult">‚úï</button>
            <h2>Tahlil natijasi</h2>
        </div>
        <div class="result-content" id="resultContent">
            <!-- Dynamic content -->
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">AI tahlil qilmoqda...</div>
        <div class="loading-subtext">Ozuqaviy qiymatlar aniqlanmoqda</div>
    </div>
    
    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept="image/*">
    
    <script>
        // Elements
        const video = document.getElementById('video');
        const capturedImage = document.getElementById('capturedImage');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const captureRow = document.getElementById('captureRow');
        const actionRow = document.getElementById('actionRow');
        const instructionBox = document.getElementById('instructionBox');
        const resultPanel = document.getElementById('resultPanel');
        const resultContent = document.getElementById('resultContent');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const galleryBtn = document.getElementById('galleryBtn');
        const fileInput = document.getElementById('fileInput');
        const closeResult = document.getElementById('closeResult');
        const cameraMode = document.getElementById('cameraMode');
        const barcodeMode = document.getElementById('barcodeMode');
        
        let stream = null;
        let capturedImageData = null;
        
        // API URL
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://127.0.0.1:8000'
            : '';
        
        // Initialize camera
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });
                video.srcObject = stream;
            } catch (err) {
                console.error('Kamera xatosi:', err);
                instructionBox.innerHTML = `
                    <h2>‚ö†Ô∏è Kamera xatosi</h2>
                    <p>Kamera ruxsatini bering yoki<br>galereyadan rasm tanlang</p>
                `;
            }
        }
        
        // Capture photo
        function capturePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
            capturedImage.src = capturedImageData;
            
            // Switch to captured view
            video.style.display = 'none';
            capturedImage.style.display = 'block';
            captureRow.style.display = 'none';
            actionRow.style.display = 'flex';
            instructionBox.style.display = 'none';
        }
        
        // Retake photo
        function retakePhoto() {
            capturedImageData = null;
            video.style.display = 'block';
            capturedImage.style.display = 'none';
            captureRow.style.display = 'flex';
            actionRow.style.display = 'none';
            instructionBox.style.display = 'block';
        }
        
        // Analyze image
        async function analyzeImage() {
            if (!capturedImageData) return;
            
            loadingOverlay.classList.add('show');
            
            try {
                const formData = new FormData();
                
                // Base64 ni blob ga aylantirish
                const response = await fetch(capturedImageData);
                const blob = await response.blob();
                formData.append('image', blob, 'food.jpg');
                
                const result = await fetch(`${API_URL}/api/analyze-food/`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await result.json();
                
                loadingOverlay.classList.remove('show');
                
                if (data.success) {
                    showResult(data.data);
                } else {
                    showError(data.error || 'Tahlil qilishda xatolik');
                }
            } catch (err) {
                console.error('Xatolik:', err);
                loadingOverlay.classList.remove('show');
                showError('Server bilan bog\'lanib bo\'lmadi');
            }
        }
        
        // Show result
        function showResult(data) {
            const n = data.nutrition_per_100g || {};
            const calories = Math.round(n.calories || 0);
            const proteins = parseFloat(n.proteins) || 0;
            const carbs = parseFloat(n.carbohydrates) || 0;
            const fat = parseFloat(n.fat) || 0;
            const sugars = parseFloat(n.sugars) || 0;
            const salt = parseFloat(n.salt) || 0;
            const fiber = parseFloat(n.fiber) || 0;
            
            // Nutri-score
            const nutriscore = (data.nutriscore || 'C').toUpperCase();
            
            // Kunlik foizlar
            const dailyCal = Math.min(100, Math.round((calories / 2000) * 100));
            const dailyProtein = Math.min(100, Math.round((proteins / 50) * 100));
            const dailyCarbs = Math.min(100, Math.round((carbs / 300) * 100));
            const dailyFat = Math.min(100, Math.round((fat / 65) * 100));
            
            // SVG aylana hisoblash
            const calCircumference = 2 * Math.PI * 75;
            const calOffset = calCircumference - (dailyCal / 100) * calCircumference;
            
            const macroCircumference = 2 * Math.PI * 24;
            const proteinOffset = macroCircumference - (dailyProtein / 100) * macroCircumference;
            const carbsOffset = macroCircumference - (dailyCarbs / 100) * macroCircumference;
            const fatOffset = macroCircumference - (dailyFat / 100) * macroCircumference;
            
            // Benefits HTML
            let benefitsHtml = '';
            if (data.health_benefits && data.health_benefits.length > 0) {
                benefitsHtml = data.health_benefits.map(b => `
                    <div class="benefit-item">
                        <div class="benefit-icon">‚úì</div>
                        <div class="benefit-text">${b}</div>
                    </div>
                `).join('');
            }
            
            // Risks HTML
            let risksHtml = '';
            if (data.health_risks && data.health_risks.length > 0) {
                risksHtml = data.health_risks.map(r => `
                    <div class="risk-item">
                        <div class="risk-icon">!</div>
                        <div class="risk-text">${r}</div>
                    </div>
                `).join('');
            }
            
            // Storage info
            const storage = data.storage || {};
            
            // Tags
            let tagsHtml = '';
            if (data.is_organic) tagsHtml += '<span class="tag organic">üå± Organik</span>';
            if (data.is_vegan) tagsHtml += '<span class="tag vegan">ü•¨ Vegan</span>';
            if (data.is_gluten_free) tagsHtml += '<span class="tag gluten-free">üåæ Glutensiz</span>';
            
            resultContent.innerHTML = `
                <!-- Product Card -->
                <div class="product-card">
                    <div class="product-header">
                        <div class="product-image-box">
                            <img src="${capturedImageData}" alt="${data.name}">
                        </div>
                        <div class="product-info">
                            <h1>${data.name || 'Noma\'lum mahsulot'}</h1>
                            ${data.category ? `<span class="category">${data.category}</span>` : ''}
                            ${data.description ? `<p class="description">${data.description}</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- Nutri-Score -->
                    <div class="nutriscore-bar">
                        <div class="ns-item ns-a ${nutriscore === 'A' ? 'active' : ''}">A</div>
                        <div class="ns-item ns-b ${nutriscore === 'B' ? 'active' : ''}">B</div>
                        <div class="ns-item ns-c ${nutriscore === 'C' ? 'active' : ''}">C</div>
                        <div class="ns-item ns-d ${nutriscore === 'D' ? 'active' : ''}">D</div>
                        <div class="ns-item ns-e ${nutriscore === 'E' ? 'active' : ''}">E</div>
                    </div>
                    
                    ${tagsHtml ? `<div class="tags-row">${tagsHtml}</div>` : ''}
                </div>
                
                <!-- Calorie Circle -->
                <div class="info-section">
                    <h3><span class="icon">üî•</span> Kaloriya (100g)</h3>
                    <div class="calorie-section">
                        <div class="calorie-circle">
                            <svg width="180" height="180">
                                <defs>
                                    <linearGradient id="calGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#ff6b6b"/>
                                        <stop offset="50%" stop-color="#feca57"/>
                                        <stop offset="100%" stop-color="#48dbfb"/>
                                    </linearGradient>
                                </defs>
                                <circle class="cal-bg" cx="90" cy="90" r="75"/>
                                <circle class="cal-progress" cx="90" cy="90" r="75"
                                    stroke-dasharray="${calCircumference}"
                                    stroke-dashoffset="${calOffset}"/>
                            </svg>
                            <div class="calorie-text">
                                <div class="calorie-value">${calories}</div>
                                <div class="calorie-label">kkal</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Macros -->
                    <div class="macros-grid">
                        <div class="macro-card">
                            <div class="macro-circle">
                                <svg width="60" height="60">
                                    <circle class="macro-bg" cx="30" cy="30" r="24"/>
                                    <circle class="macro-progress protein" cx="30" cy="30" r="24"
                                        stroke-dasharray="${macroCircumference}"
                                        stroke-dashoffset="${proteinOffset}"
                                        style="transform: rotate(-90deg); transform-origin: center;"/>
                                </svg>
                                <div class="macro-value">${proteins}g</div>
                            </div>
                            <div class="macro-name protein">Oqsil</div>
                            <div class="macro-percent">${dailyProtein}% kunlik</div>
                        </div>
                        
                        <div class="macro-card">
                            <div class="macro-circle">
                                <svg width="60" height="60">
                                    <circle class="macro-bg" cx="30" cy="30" r="24"/>
                                    <circle class="macro-progress carbs" cx="30" cy="30" r="24"
                                        stroke-dasharray="${macroCircumference}"
                                        stroke-dashoffset="${carbsOffset}"
                                        style="transform: rotate(-90deg); transform-origin: center;"/>
                                </svg>
                                <div class="macro-value">${carbs}g</div>
                            </div>
                            <div class="macro-name carbs">Uglevod</div>
                            <div class="macro-percent">${dailyCarbs}% kunlik</div>
                        </div>
                        
                        <div class="macro-card">
                            <div class="macro-circle">
                                <svg width="60" height="60">
                                    <circle class="macro-bg" cx="30" cy="30" r="24"/>
                                    <circle class="macro-progress fat" cx="30" cy="30" r="24"
                                        stroke-dasharray="${macroCircumference}"
                                        stroke-dashoffset="${fatOffset}"
                                        style="transform: rotate(-90deg); transform-origin: center;"/>
                                </svg>
                                <div class="macro-value">${fat}g</div>
                            </div>
                            <div class="macro-name fat">Yog'</div>
                            <div class="macro-percent">${dailyFat}% kunlik</div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Nutrition -->
                <div class="info-section">
                    <h3><span class="icon">üìä</span> Batafsil (100g)</h3>
                    <div class="nutrition-row">
                        <div class="name">
                            <div class="icon" style="background: rgba(251, 191, 36, 0.2);">üç¨</div>
                            <span>Shakar</span>
                        </div>
                        <div>
                            <span class="value">${sugars}g</span>
                            <span class="daily">(${Math.round(sugars / 25 * 100)}%)</span>
                        </div>
                    </div>
                    <div class="nutrition-row">
                        <div class="name">
                            <div class="icon" style="background: rgba(59, 130, 246, 0.2);">üßÇ</div>
                            <span>Tuz</span>
                        </div>
                        <div>
                            <span class="value">${salt}g</span>
                            <span class="daily">(${Math.round(salt / 5 * 100)}%)</span>
                        </div>
                    </div>
                    <div class="nutrition-row">
                        <div class="name">
                            <div class="icon" style="background: rgba(34, 197, 94, 0.2);">üåæ</div>
                            <span>Tola</span>
                        </div>
                        <div>
                            <span class="value">${fiber}g</span>
                            <span class="daily">(${Math.round(fiber / 25 * 100)}%)</span>
                        </div>
                    </div>
                </div>
                
                ${benefitsHtml ? `
                <!-- Benefits -->
                <div class="info-section">
                    <h3><span class="icon">üíö</span> Foydalari</h3>
                    ${benefitsHtml}
                </div>
                ` : ''}
                
                ${risksHtml ? `
                <!-- Risks -->
                <div class="info-section">
                    <h3><span class="icon">‚ö†Ô∏è</span> Ogohlantirishlar</h3>
                    ${risksHtml}
                </div>
                ` : ''}
                
                <!-- Best Time -->
                ${data.best_time_to_eat ? `
                <div class="info-section">
                    <h3><span class="icon">‚è∞</span> Qachon iste'mol qilish</h3>
                    <div class="time-badge">
                        üïê ${data.best_time_to_eat}
                    </div>
                    ${data.who_should_avoid ? `<p style="margin-top: 15px; color: #fca5a5; font-size: 0.9rem;">‚ö†Ô∏è ${data.who_should_avoid}</p>` : ''}
                </div>
                ` : ''}
                
                <!-- Storage -->
                ${storage.method ? `
                <div class="info-section">
                    <h3><span class="icon">üì¶</span> Saqlash sharoitlari</h3>
                    <div class="storage-grid">
                        <div class="storage-item">
                            <div class="label">Usul</div>
                            <div class="value">${storage.method || '-'}</div>
                        </div>
                        <div class="storage-item">
                            <div class="label">Harorat</div>
                            <div class="value">${storage.temperature || '-'}</div>
                        </div>
                        <div class="storage-item">
                            <div class="label">Muddat</div>
                            <div class="value">${storage.duration || '-'}</div>
                        </div>
                        <div class="storage-item">
                            <div class="label">Maslahat</div>
                            <div class="value" style="font-size: 0.8rem;">${storage.tips || '-'}</div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Serving Suggestion -->
                ${data.serving_suggestion ? `
                <div class="info-section">
                    <h3><span class="icon">üçΩÔ∏è</span> Iste'mol tavsiyasi</h3>
                    <p style="line-height: 1.6; color: #e5e7eb;">${data.serving_suggestion}</p>
                    
                    ${data.pairs_well_with && data.pairs_well_with.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 10px;">Nima bilan yaxshi ketadi:</p>
                        <div class="tags-row">
                            ${data.pairs_well_with.map(p => `<span class="tag" style="background: rgba(99, 102, 241, 0.2); color: #a5b4fc;">üç¥ ${p}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;
            
            resultPanel.classList.add('show');
        }
        
        // Show error
        function showError(message) {
            resultContent.innerHTML = `
                <div class="error-box">
                    <div class="icon">üòï</div>
                    <h3>Tahlil qilib bo'lmadi</h3>
                    <p>${message}</p>
                    <button onclick="closeResultPanel()" style="margin-top: 20px; padding: 12px 30px; background: #4ade80; border: none; color: white; border-radius: 25px; font-size: 1rem; cursor: pointer;">
                        Qayta urinish
                    </button>
                </div>
            `;
            resultPanel.classList.add('show');
        }
        
        // Close result panel
        function closeResultPanel() {
            resultPanel.classList.remove('show');
            retakePhoto();
        }
        
        // Event listeners
        captureBtn.addEventListener('click', capturePhoto);
        retakeBtn.addEventListener('click', retakePhoto);
        analyzeBtn.addEventListener('click', analyzeImage);
        closeResult.addEventListener('click', closeResultPanel);
        
        galleryBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    capturedImageData = ev.target.result;
                    capturedImage.src = capturedImageData;
                    video.style.display = 'none';
                    capturedImage.style.display = 'block';
                    captureRow.style.display = 'none';
                    actionRow.style.display = 'flex';
                    instructionBox.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Mode switch
        barcodeMode.addEventListener('click', () => {
            window.location.href = '/scanner/';
        });
        
        // Initialize
        initCamera();
    </script>
</body>
</html>
