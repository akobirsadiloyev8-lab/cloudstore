<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fayl Yuklash va Konvertatsiya</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
        }

        .logo i {
            font-size: 2rem;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 500;
            margin-left: 2rem;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            color: white;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Upload Section */
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 16px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf3 100%);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e8ecf3 0%, #dce1e8 100%);
            transform: scale(1.01);
        }

        .upload-area.dragover {
            border-color: #43e97b;
            background: rgba(67, 233, 123, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 1.5rem;
        }

        .upload-area h3 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .upload-area p {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        #fileInput {
            display: none;
        }

        /* Files List */
        .files-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }

        .files-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .clear-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: #ee5a24;
        }

        /* File Item */
        .file-item {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border-radius: 16px;
            margin-bottom: 1rem;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transform: translateX(5px);
        }

        .file-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-right: 1.5rem;
        }

        .file-icon.pdf { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        .file-icon.doc { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .file-icon.xls { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .file-icon.ppt { background: linear-gradient(135deg, #fa709a, #fee140); }
        .file-icon.img { background: linear-gradient(135deg, #a18cd1, #fbc2eb); }
        .file-icon.txt { background: linear-gradient(135deg, #667eea, #764ba2); }
        .file-icon.default { background: linear-gradient(135deg, #868f96, #596164); }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.3rem;
        }

        .file-size {
            font-size: 0.85rem;
            color: #888;
        }

        .file-actions {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-word {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-excel {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: white;
        }

        .btn-ppt {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
        }

        .btn-txt {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-delete {
            background: #f1f3f4;
            color: #666;
        }

        .btn-delete:hover {
            background: #ff6b6b;
            color: white;
        }

        .btn-preview {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        /* Preview Modal */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 2rem;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-container {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .preview-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .close-preview {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-preview:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }

        .preview-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: #f8f9fa;
        }

        .preview-text {
            padding: 2rem;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 100%;
            margin: 0;
        }

        .preview-text.html-content {
            background: white;
            color: #333;
            font-family: 'Inter', sans-serif;
            padding: 2rem;
        }

        .preview-image {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            padding: 2rem;
            background: #2d2d2d;
        }

        .preview-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .preview-pdf {
            width: 100%;
            height: 100%;
        }

        .preview-pdf iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .preview-document {
            padding: 2rem;
            background: white;
            color: #333;
            line-height: 1.8;
            font-size: 15px;
        }

        .preview-document p {
            margin-bottom: 1rem;
        }

        /* Word document stilari */
        .word-document {
            padding: 2rem;
            background: white;
            color: #333;
            font-family: 'Calibri', 'Arial', sans-serif;
            line-height: 1.6;
        }

        .word-document h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin: 1.5rem 0 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .word-document h2 {
            font-size: 1.5rem;
            color: #34495e;
            margin: 1.2rem 0 0.8rem;
        }

        .word-document h3 {
            font-size: 1.2rem;
            color: #4a5568;
            margin: 1rem 0 0.6rem;
        }

        .word-document h4 {
            font-size: 1rem;
            color: #667eea;
            margin: 0.8rem 0 0.5rem;
        }

        .word-document p {
            margin-bottom: 0.8rem;
            text-align: justify;
        }

        .word-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 14px;
        }

        .word-table th,
        .word-table td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: left;
        }

        .word-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .word-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .word-table tr:hover {
            background: #e8ecf3;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .excel-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .excel-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .excel-table tr:hover {
            background: #f5f7fa;
        }

        .preview-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            text-align: center;
            padding: 2rem;
        }

        .preview-error i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Status */
        .status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status.success {
            background: rgba(67, 233, 123, 0.2);
            color: #00a854;
        }

        .status.loading {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .status.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #888;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loader {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .toast.error { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            .nav-links a {
                font-size: 0.85rem;
                padding: 6px 12px !important;
            }
            .container {
                padding: 1rem;
                margin: 1rem auto;
            }
            .upload-section {
                padding: 1.5rem;
            }
            .upload-area h3 {
                font-size: 1.1rem;
            }
            .file-item {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }
            .file-icon {
                margin: 0 0 1rem 0;
            }
            .file-actions {
                justify-content: center;
                margin-top: 1rem;
                flex-wrap: wrap;
            }
            .action-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .files-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            .preview-container {
                width: 95%;
                max-height: 90vh;
            }
        }
        
        @media (max-width: 480px) {
            .logo span {
                font-size: 1.2rem;
            }
            .upload-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="logo">
            <i class="fas fa-file-pdf"></i>
            <span>FileConverter</span>
        </a>
        <div class="nav-links">
            <a href="/ai-chat/" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 16px; border-radius: 8px;"><i class="fas fa-robot"></i> AI Chat</a>
            <a href="/"><i class="fas fa-home"></i> Bosh sahifa</a>
        </div>
    </nav>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-area" id="dropZone">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <h3>Fayllarni bu yerga tashlang</h3>
                <p>yoki</p>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-file"></i> Fayl tanlash
                    </button>
                    <button class="upload-btn" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="document.getElementById('folderInput').click()">
                        <i class="fas fa-folder"></i> Papka tanlash
                    </button>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.html,.jpg,.jpeg,.png,.gif,.bmp">
                <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
                <p style="margin-top: 1rem; font-size: 0.85rem;">PDF, Word, Excel, PowerPoint, HTML, Text, Rasmlar</p>
                <p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;"><i class="fas fa-folder"></i> Papka ichidagi barcha fayllar yuklanadi</p>
            </div>
        </div>

        <!-- Files Section -->
        <div class="files-section">
            <div class="files-header">
                <h2><i class="fas fa-file-alt"></i> Yuklangan fayllar</h2>
                <button class="clear-btn" onclick="clearAllFiles()">
                    <i class="fas fa-trash"></i> Hammasini o'chirish
                </button>
            </div>
            <div id="filesList">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>Hali fayl yuklanmagan</h3>
                    <p>Fayllarni yuqoriga tashlang yoki tanlang</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader">
            <div class="spinner"></div>
            <p>Konvertatsiya qilinmoqda...</p>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-container">
            <div class="preview-header">
                <h3><i class="fas fa-eye"></i> <span id="previewFileName">Fayl nomi</span></h3>
                <button class="close-preview" onclick="closePreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="preview-content" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Mavjud fayllarni yuklash
        let uploadedFiles = [
            {% for file in existing_files %}
            {
                id: "{{ file.id }}",
                name: "{{ file.name }}",
                path: "{{ file.path|escapejs }}",
                size: "{{ file.size|filesizeformat }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Sahifa yuklanganda fayllarni ko'rsatish
        document.addEventListener('DOMContentLoaded', function() {
            renderFiles();
        });

        // Drag and Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Papka yuklash
        const folderInput = document.getElementById('folderInput');
        folderInput.addEventListener('change', (e) => {
            handleFolderFiles(e.target.files);
        });

        // Yuklangan papkalar ro'yxati
        let uploadedFolders = [];

        function handleFiles(files) {
            for (let file of files) {
                uploadFile(file);
            }
        }

        async function handleFolderFiles(files) {
            if (files.length === 0) return;
            
            // Papka nomini aniqlash
            const firstFilePath = files[0].webkitRelativePath;
            const folderName = firstFilePath.split('/')[0];
            
            // Fayllarni filtrlash (faqat PDF, Word, Excel, PowerPoint, HTML, Text)
            const supportedExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.txt', '.html', '.htm'];
            
            let validFiles = [];
            for (let file of files) {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (supportedExtensions.includes(ext)) {
                    validFiles.push(file);
                }
            }
            
            // Maksimum 10 ta fayl tekshiruvi
            if (validFiles.length === 0) {
                showToast('Papkada qo\'llab-quvvatlanadigan fayl topilmadi!', 'error');
                return;
            }
            
            if (validFiles.length > 10) {
                showToast(`Papkada ${validFiles.length} ta fayl bor. Maksimum 10 ta fayl yuklanadi!`, 'error');
                validFiles = validFiles.slice(0, 10);
            }
            
            showToast(`"${folderName}" papkasidan ${validFiles.length} ta fayl yuklanmoqda...`, 'success');
            
            // Papka ma'lumotlarini saqlash
            const folderData = {
                name: folderName,
                files: [],
                totalSize: 0
            };
            
            for (let file of validFiles) {
                const result = await uploadFolderFile(file, file.webkitRelativePath, folderName);
                if (result) {
                    folderData.files.push(result);
                    folderData.totalSize += result.size;
                }
            }
            
            if (folderData.files.length > 0) {
                uploadedFolders.push(folderData);
                renderFiles();
                showToast(`"${folderName}" papkasi yuklandi (${folderData.files.length} ta fayl)`, 'success');
            }
        }

        async function uploadFolderFile(file, relativePath, folderName) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('relative_path', relativePath);
            formData.append('is_folder_upload', 'true');
            formData.append('folder_name', folderName);

            try {
                const response = await fetch('/upload/', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    return {
                        id: data.file_id,
                        name: data.filename,
                        path: data.filepath,
                        size: data.size,
                        relativePath: relativePath
                    };
                }
            } catch (error) {
                console.error('Yuklashda xatolik:', error);
            }
            return null;
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload/', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    uploadedFiles.push({
                        id: data.file_id,
                        name: data.filename,
                        path: data.filepath,
                        size: formatFileSize(data.size)
                    });
                    renderFiles();
                    showToast('Fayl yuklandi va bazaga saqlandi!', 'success');
                } else {
                    showToast('Xatolik: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Yuklashda xatolik!', 'error');
            }
        }

        function renderFiles() {
            const container = document.getElementById('filesList');
            
            if (uploadedFiles.length === 0 && uploadedFolders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Hali fayl yuklanmagan</h3>
                        <p>Fayllarni yuqoriga tashlang yoki tanlang</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            // Papkalarni ko'rsatish
            uploadedFolders.forEach((folder, folderIndex) => {
                html += `
                    <div class="file-item folder-item" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                        <div class="file-icon" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name" style="color: #2e7d32; font-weight: 700;">
                                <i class="fas fa-folder-open"></i> ${folder.name}
                            </div>
                            <div class="file-size">${folder.files.length} ta fayl | ${formatFileSize(folder.totalSize)}</div>
                            <div style="margin-top: 5px;">
                                <button class="action-btn" style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; font-size: 0.75rem;" onclick="toggleFolderDetails(${folderIndex})">
                                    <i class="fas fa-list"></i> Fayllarni ko'rish
                                </button>
                            </div>
                            <div id="folder-details-${folderIndex}" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                                ${folder.files.map(f => `<div style="padding: 3px 0; font-size: 0.85rem;"><i class="fas ${getFileIcon(f.name)}"></i> ${f.name}</div>`).join('')}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="action-btn btn-pdf" onclick="convertFolder(${folderIndex}, 'pdf')">
                                <i class="fas fa-file-pdf"></i> Barchasini PDF
                            </button>
                            <button class="action-btn btn-delete" onclick="removeFolder(${folderIndex})">
                                <i class="fas fa-trash"></i> Papkani o'chirish
                            </button>
                        </div>
                    </div>
                `;
            });

            // Oddiy fayllarni ko'rsatish
            html += uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <div class="file-icon ${getFileIconClass(file.name)}">
                        <i class="fas ${getFileIcon(file.name)}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${file.size}</div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn btn-preview" onclick="previewFile(${index})">
                            <i class="fas fa-eye"></i> Ko'rish
                        </button>
                        <button class="action-btn btn-preview" onclick="editFile(${index})">
                            <i class="fas fa-edit"></i> Tahrirlash
                        </button>
                        <button class="action-btn btn-pdf" onclick="convertFile(${index}, 'pdf')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="action-btn btn-word" onclick="convertFile(${index}, 'docx')">
                            <i class="fas fa-file-word"></i> Word
                        </button>
                        <button class="action-btn btn-excel" onclick="convertFile(${index}, 'xlsx')">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="action-btn btn-txt" onclick="convertFile(${index}, 'txt')">
                            <i class="fas fa-file-alt"></i> TXT
                        </button>
                        <button class="action-btn btn-delete" onclick="removeFile(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function toggleFolderDetails(folderIndex) {
            const details = document.getElementById(`folder-details-${folderIndex}`);
            if (details.style.display === 'none') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }

        async function convertFolder(folderIndex, format) {
            const folder = uploadedFolders[folderIndex];
            showLoading(true);
            
            try {
                const response = await fetch('/convert-folder-zip/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: folder.files,
                        folder_name: folder.name
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showLoading(false);
                    showToast(`${data.converted_count} ta fayl PDF ga aylandi! ZIP yuklanmoqda...`, 'success');
                    // ZIP faylni yuklab olish
                    window.location.href = data.download_url;
                } else {
                    showLoading(false);
                    showToast('Xatolik: ' + data.error, 'error');
                }
            } catch (error) {
                showLoading(false);
                showToast('Konvertatsiyada xatolik!', 'error');
                console.error('Konvertatsiyada xatolik:', error);
            }
        }

        async function removeFolder(folderIndex) {
            const folder = uploadedFolders[folderIndex];
            if (!confirm(`"${folder.name}" papkasini va ${folder.files.length} ta faylni o'chirishni xohlaysizmi?`)) {
                return;
            }
            
            for (let file of folder.files) {
                try {
                    await fetch('/delete-file/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            filepath: file.path,
                            file_id: file.id
                        })
                    });
                } catch (error) {
                    console.error('O\'chirishda xatolik:', error);
                }
            }
            
            uploadedFolders.splice(folderIndex, 1);
            renderFiles();
            showToast('Papka o\'chirildi!', 'success');
        }

        async function convertFile(index, format) {
            const file = uploadedFiles[index];
            showLoading(true);

            try {
                const response = await fetch('/convert/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filepath: file.path,
                        format: format
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Konvertatsiya tayyor!', 'success');
                    window.location.href = data.download_url;
                } else {
                    showToast('Xatolik: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Konvertatsiyada xatolik!', 'error');
            }

            showLoading(false);
        }

        async function removeFile(index) {
            const file = uploadedFiles[index];
            if (!confirm(`"${file.name}" faylini o'chirishni xohlaysizmi?`)) {
                return;
            }
            
            try {
                const response = await fetch('/delete-file/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        filepath: file.path,
                        file_id: file.id
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    uploadedFiles.splice(index, 1);
                    renderFiles();
                    showToast('Fayl o\'chirildi!', 'success');
                } else {
                    showToast('Xatolik: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('O\'chirishda xatolik!', 'error');
            }
        }

        async function clearAllFiles() {
            if (!confirm('Barcha fayllarni o\'chirishni xohlaysizmi?')) {
                return;
            }
            
            for (let i = uploadedFiles.length - 1; i >= 0; i--) {
                try {
                    await fetch('/delete-file/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            filepath: uploadedFiles[i].path,
                            file_id: uploadedFiles[i].id
                        })
                    });
                } catch (error) {
                    console.error('Xatolik:', error);
                }
            }
            uploadedFiles = [];
            renderFiles();
            showToast('Barcha fayllar o\'chirildi!', 'success');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                'txt': 'fa-file-alt',
                'html': 'fa-file-code', 'htm': 'fa-file-code',
                'jpg': 'fa-file-image', 'jpeg': 'fa-file-image', 'png': 'fa-file-image', 'gif': 'fa-file-image'
            };
            return icons[ext] || 'fa-file';
        }

        function getFileIconClass(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['pdf'].includes(ext)) return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc';
            if (['xls', 'xlsx'].includes(ext)) return 'xls';
            if (['ppt', 'pptx'].includes(ext)) return 'ppt';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'img';
            if (['txt'].includes(ext)) return 'txt';
            return 'default';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Edit file function
        function editFile(index) {
            const file = uploadedFiles[index];
            // Yangi sahifaga o'tish
            window.location.href = `/edit-file/?filepath=${encodeURIComponent(file.path)}&filename=${encodeURIComponent(file.name)}`;
        }

        // Preview functions
        async function previewFile(index) {
            const file = uploadedFiles[index];
            showLoading(true);

            try {
                const response = await fetch('/preview-content/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filepath: file.path })
                });
                const data = await response.json();
                
                if (data.success) {
                    showPreviewModal(data);
                } else {
                    showToast('Xatolik: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Ko\'rishda xatolik!', 'error');
            }

            showLoading(false);
        }

        function showPreviewModal(data) {
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewContent');
            const fileName = document.getElementById('previewFileName');
            
            fileName.textContent = data.filename;
            
            let html = '';
            
            switch(data.file_type) {
                case 'text':
                    // HTML fayllarini asl ko'rinishida ko'rsatish
                    if (data.filename.endsWith('.html') || data.filename.endsWith('.htm')) {
                        html = `<div class="preview-text html-content">${data.content}</div>`;
                    } else {
                        // Matnni xavfsiz ko'rsatish
                        const escapedContent = escapeHtml(data.content);
                        html = `<pre class="preview-text">${escapedContent}</pre>`;
                    }
                    break;
                    
                case 'image':
                    html = `<div class="preview-image"><img src="${data.content}" alt="${data.filename}"></div>`;
                    break;
                    
                case 'pdf':
                    html = `<div class="preview-pdf"><iframe src="${data.content}"></iframe></div>`;
                    break;
                    
                case 'html_document':
                    // Word fayllarni HTML formatida ko'rsatish (asl format)
                    html = `<div class="preview-content">${data.content}</div>`;
                    break;
                    
                case 'document':
                    html = `<div class="preview-document">${data.content.split('\n\n').map(p => `<p>${escapeHtml(p)}</p>`).join('')}</div>`;
                    break;
                    
                case 'spreadsheet':
                    html = `<div class="preview-document">${data.content}</div>`;
                    break;
                    
                default:
                    html = `
                        <div class="preview-error">
                            <i class="fas fa-file-alt"></i>
                            <h3>Bu fayl turini ko'rib bo'lmaydi</h3>
                            <p>${data.content || 'Fayl formati qo\'llab-quvvatlanmaydi'}</p>
                        </div>
                    `;
            }
            
            content.innerHTML = html;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePreview();
            }
        });

        // Close modal on backdrop click
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePreview();
            }
        });
    </script>
</body>
</html>
