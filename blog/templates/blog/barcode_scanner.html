{% extends 'blog/boshlash.html' %}
{% load static %}

{% block title %}QR & Barcode Skaner - Cloudstore AI{% endblock %}

{% block extra_styles %}
.scanner-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.scanner-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    color: white;
    margin-bottom: 25px;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
}

.scanner-hero h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.scanner-hero p {
    opacity: 0.9;
    font-size: 1rem;
}

.mode-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 8px;
}

.mode-tab {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    background: transparent;
    color: #666;
}

.mode-tab.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

.mode-tab:hover:not(.active) {
    background: rgba(102, 126, 234, 0.1);
}

.scanner-section {
    background: white;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.manual-input {
    display: flex;
    gap: 10px;
}

.manual-input input {
    flex: 1;
    padding: 15px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1.1rem;
    transition: all 0.3s;
}

.manual-input input:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.scan-btn {
    padding: 15px 30px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.scan-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

#reader {
    width: 100%;
    border-radius: 15px;
    overflow: hidden;
}

#reader video {
    border-radius: 15px;
}

.result-card {
    display: none;
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    animation: slideUp 0.5s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-header {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.result-header.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.result-header.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.product-image {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    object-fit: cover;
    background: white;
}

.product-title {
    flex: 1;
}

.product-title h2 {
    font-size: 1.3rem;
    margin-bottom: 5px;
}

.product-title p {
    opacity: 0.9;
    font-size: 0.9rem;
}

.result-body {
    padding: 25px;
}

.health-scores {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.score-badge {
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nutri-a { background: #22c55e; color: white; }
.nutri-b { background: #84cc16; color: white; }
.nutri-c { background: #fbbf24; color: #333; }
.nutri-d { background: #f97316; color: white; }
.nutri-e { background: #ef4444; color: white; }

.nova-1 { background: #22c55e; color: white; }
.nova-2 { background: #84cc16; color: white; }
.nova-3 { background: #fbbf24; color: #333; }
.nova-4 { background: #ef4444; color: white; }

.warnings-box {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 2px solid #f59e0b;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
}

.warnings-box h4 {
    color: #92400e;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.warnings-box p {
    color: #78350f;
    font-size: 0.95rem;
    margin: 5px 0;
}

.info-section {
    margin-bottom: 20px;
}

.info-section h3 {
    font-size: 1.1rem;
    color: #374151;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}

.info-section h3 i {
    color: #667eea;
}

.nutrition-table {
    width: 100%;
    border-collapse: collapse;
}

.nutrition-table tr {
    border-bottom: 1px solid #f3f4f6;
}

.nutrition-table tr:last-child {
    border-bottom: none;
}

.nutrition-table td {
    padding: 10px 5px;
}

.nutrition-table td:first-child {
    color: #6b7280;
}

.nutrition-table td:last-child {
    text-align: right;
    font-weight: 600;
    color: #374151;
}

.nutrition-table .highlight {
    background: #fef3c7;
}

.nutrition-table .highlight td {
    color: #92400e;
}

.vitamins-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
}

.vitamin-item {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    padding: 12px;
    border-radius: 10px;
    text-align: center;
}

.vitamin-item .name {
    font-size: 0.85rem;
    color: #0369a1;
    margin-bottom: 5px;
}

.vitamin-item .value {
    font-weight: 700;
    color: #0c4a6e;
}

.ingredients-text {
    background: #f9fafb;
    padding: 15px;
    border-radius: 12px;
    line-height: 1.6;
    color: #4b5563;
    font-size: 0.95rem;
}

.allergens-box {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    border: 2px solid #ef4444;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}

.allergens-box h4 {
    color: #991b1b;
    margin-bottom: 8px;
}

.allergens-box p {
    color: #7f1d1d;
}

.additives-box {
    background: linear-gradient(135deg, #fef9c3, #fef08a);
    border: 2px solid #eab308;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.additives-box h4 {
    color: #713f12;
    margin-bottom: 8px;
}

.additives-box p {
    color: #78350f;
    font-size: 0.9rem;
}

.qr-result {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
}

.qr-result h3 {
    color: #0369a1;
    margin-bottom: 15px;
}

.qr-result .qr-content {
    background: white;
    padding: 15px;
    border-radius: 10px;
    word-break: break-all;
    margin-bottom: 15px;
}

.qr-result .action-btn {
    padding: 12px 25px;
    background: linear-gradient(135deg, #0ea5e9, #0284c7);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.not-found {
    text-align: center;
    padding: 30px;
}

.not-found i {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 15px;
}

.not-found h3 {
    color: #6b7280;
    margin-bottom: 10px;
}

.loading {
    display: none;
    text-align: center;
    padding: 40px;
}

.loading i {
    font-size: 3rem;
    color: #667eea;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* AI Kamera rejimi stillari */
.ai-camera-section {
    position: relative;
    background: #000;
    border-radius: 20px;
    overflow: hidden;
    min-height: 400px;
}

.ai-camera-section video {
    width: 100%;
    height: 400px;
    object-fit: cover;
}

.ai-camera-section .captured-img {
    width: 100%;
    height: 400px;
    object-fit: cover;
    display: none;
}

.camera-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
}

.capture-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: transparent;
    border: 4px solid #4ade80;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.capture-btn:hover {
    transform: scale(1.05);
}

.capture-btn-inner {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    background: #4ade80;
}

.side-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 1.3rem;
    cursor: pointer;
}

.action-buttons {
    display: none;
    gap: 15px;
}

.retake-btn, .analyze-btn {
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
}

.retake-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
}

.analyze-btn {
    background: linear-gradient(135deg, #4ade80, #22c55e);
    border: none;
    color: white;
}

.camera-instruction {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    padding: 10px 20px;
    border-radius: 20px;
    color: white;
    text-align: center;
    font-size: 0.9rem;
}

/* AI Natija modali */
.ai-result-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    background-color: #000000;
    z-index: 99999;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.ai-result-modal.show {
    display: block;
}

.ai-result-content {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    padding-bottom: 100px;
    background-color: #000000;
    min-height: 100%;
}

.ai-result-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    position: sticky;
    top: 0;
    background-color: #0a0a0a;
    padding: 15px 0;
    padding-top: calc(15px + env(safe-area-inset-top, 0px));
    z-index: 10;
}

.close-ai-result {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.ai-result-header h2 {
    color: white;
    font-size: 1.2rem;
}

/* AI Product Card */
.ai-product-card {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 15px;
    color: white;
}

.ai-product-header {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.ai-product-img {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    object-fit: cover;
}

.ai-product-info h2 {
    font-size: 1.3rem;
    margin-bottom: 5px;
}

.ai-product-info .category {
    display: inline-block;
    background: rgba(74, 222, 128, 0.2);
    color: #4ade80;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
}

/* Nutri-Score bar */
.ns-bar {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin: 15px 0;
}

.ns-letter {
    width: 40px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border-radius: 8px;
    opacity: 0.3;
    transition: all 0.3s;
}

.ns-letter.active {
    opacity: 1;
    transform: scale(1.2);
}

.ns-a { background: #038141; color: white; }
.ns-b { background: #85bb2f; color: white; }
.ns-c { background: #fecb02; color: #333; }
.ns-d { background: #ee8100; color: white; }
.ns-e { background: #e63e11; color: white; }

/* Calorie Circle */
.cal-circle-box {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.cal-circle {
    position: relative;
    width: 150px;
    height: 150px;
}

.cal-circle svg {
    transform: rotate(-90deg);
}

.cal-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 12; }
.cal-progress { fill: none; stroke: url(#calGrad); stroke-width: 12; stroke-linecap: round; }

.cal-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;
}

.cal-value {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #ff6b6b, #feca57);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.cal-label { color: #9ca3af; font-size: 0.8rem; }

/* Macro Cards */
.macro-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.macro-card {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
}

.macro-val { font-weight: 700; font-size: 1.1rem; color: white; }
.macro-name { font-size: 0.8rem; margin-top: 3px; }
.macro-name.protein { color: #10b981; }
.macro-name.carbs { color: #f59e0b; }
.macro-name.fat { color: #ef4444; }

/* Info boxes */
.ai-info-box {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 12px;
    color: white;
}

.ai-info-box h4 {
    font-size: 0.95rem;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.benefit-row, .risk-row {
    display: flex;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.benefit-row:last-child, .risk-row:last-child { border-bottom: none; }

.benefit-icon {
    width: 28px; height: 28px;
    background: rgba(34, 197, 94, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4ade80;
    flex-shrink: 0;
}

.risk-icon {
    width: 28px; height: 28px;
    background: rgba(239, 68, 68, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f87171;
    flex-shrink: 0;
}

.storage-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.storage-item {
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
}

.storage-item .label { font-size: 0.75rem; color: #9ca3af; }
.storage-item .value { font-weight: 600; margin-top: 3px; }

/* Loading overlay */
.ai-loading {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.ai-loading.show { display: flex; }

.ai-spinner {
    width: 60px; height: 60px;
    border: 4px solid rgba(255,255,255,0.1);
    border-top-color: #4ade80;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.ai-loading p { color: white; font-size: 1.1rem; }

@media (max-width: 600px) {
    .scanner-hero h1 { font-size: 1.5rem; }
    .manual-input { flex-direction: column; }
    .health-scores { flex-direction: column; }
}
{% endblock %}

{% block content %}
<div class="scanner-container">
    <div class="scanner-hero">
        <h1><i class="fas fa-qrcode"></i> QR & Barcode Skaner</h1>
        <p>Mahsulot haqida to'liq ma'lumot: kaloriya, vitaminlar, allergenlar, zararlar</p>
    </div>
    
    <div class="mode-tabs">
        <button class="mode-tab active" onclick="switchMode('manual')">
            <i class="fas fa-keyboard"></i> Qo'lda kiritish
        </button>
        <button class="mode-tab" onclick="switchMode('barcode')">
            <i class="fas fa-barcode"></i> Shtrix kod
        </button>
        <button class="mode-tab" onclick="switchMode('camera')">
            <i class="fas fa-camera"></i> üì∑ Kamera
        </button>
    </div>
    
    <div id="manualSection" class="scanner-section">
        <div class="manual-input">
            <input type="text" id="barcodeInput" placeholder="Barcode raqamini kiriting..." 
                   onkeypress="if(event.key==='Enter') searchBarcode()">
            <button class="scan-btn" onclick="searchBarcode()">
                <i class="fas fa-search"></i> Qidirish
            </button>
        </div>
    </div>
    
    <div id="cameraSection" class="scanner-section" style="display: none;">
        <div id="reader"></div>
        <p style="text-align: center; margin-top: 15px; color: #6b7280;">
            <i class="fas fa-info-circle"></i> QR kod yoki barcode'ni kameraga ko'rsating
        </p>
    </div>
    
    <!-- AI Kamera rejimi -->
    <div id="aiCameraSection" class="scanner-section" style="display: none;">
        <div class="ai-camera-section">
            <video id="aiVideo" autoplay playsinline muted></video>
            <img id="capturedImg" class="captured-img" alt="Captured">
            <div class="camera-instruction" id="cameraInstruction">
                üì∑ Ovqatni kameraga ko'rsating
            </div>
            <div class="camera-controls">
                <button class="side-btn" onclick="openGallery()">üñºÔ∏è</button>
                <div id="captureControls">
                    <button class="capture-btn" onclick="capturePhoto()">
                        <div class="capture-btn-inner"></div>
                    </button>
                </div>
                <div id="actionControls" class="action-buttons">
                    <button class="retake-btn" onclick="retakePhoto()">‚Ü©Ô∏è Qayta</button>
                    <button class="analyze-btn" onclick="analyzePhoto()">üîç Tahlil</button>
                </div>
                <button class="side-btn" onclick="toggleFlash()">‚ö°</button>
            </div>
        </div>
        <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleGalleryImage(event)">
    </div>
    
    <!-- AI Natija Modal -->
    <div id="aiResultModal" class="ai-result-modal">
        <div class="ai-result-content">
            <div class="ai-result-header">
                <button class="close-ai-result" onclick="closeAiResult()">‚úï</button>
                <h2>üçé Tahlil natijasi</h2>
            </div>
            <div id="aiResultBody"></div>
        </div>
    </div>
    
    <!-- AI Loading -->
    <div id="aiLoading" class="ai-loading">
        <div class="ai-spinner"></div>
        <p>AI tahlil qilmoqda...</p>
    </div>
    
    <div id="loadingDiv" class="loading">
        <i class="fas fa-spinner"></i>
        <p>Qidirilmoqda...</p>
    </div>
    
    <div id="resultCard" class="result-card"></div>
</div>

<!-- ZXing barcode kutubxonasi (Html5-QRCode orqali) -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
let html5QrCode = null;
let currentMode = 'manual';
let aiStream = null;
let capturedImageData = null;

function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
    event.target.closest('.mode-tab').classList.add('active');
    
    // Barcha section'larni yashirish
    document.getElementById('manualSection').style.display = 'none';
    document.getElementById('cameraSection').style.display = 'none';
    document.getElementById('aiCameraSection').style.display = 'none';
    stopScanner();
    stopAiCamera();
    
    if (mode === 'manual') {
        document.getElementById('manualSection').style.display = 'block';
    } else if (mode === 'barcode') {
        document.getElementById('cameraSection').style.display = 'block';
        startScanner();
    } else if (mode === 'camera') {
        document.getElementById('aiCameraSection').style.display = 'block';
        startAiCamera();
    }
}

// ===== AI KAMERA FUNKSIYALARI =====
async function startAiCamera() {
    try {
        aiStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
            audio: false
        });
        document.getElementById('aiVideo').srcObject = aiStream;
    } catch (err) {
        console.error('Kamera xatosi:', err);
        document.getElementById('cameraInstruction').textContent = '‚ö†Ô∏è Kamera ruxsati kerak';
    }
}

function stopAiCamera() {
    if (aiStream) {
        aiStream.getTracks().forEach(track => track.stop());
        aiStream = null;
    }
}

function capturePhoto() {
    const video = document.getElementById('aiVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
    document.getElementById('capturedImg').src = capturedImageData;
    
    // UI o'zgartirish
    video.style.display = 'none';
    document.getElementById('capturedImg').style.display = 'block';
    document.getElementById('captureControls').style.display = 'none';
    document.getElementById('actionControls').style.display = 'flex';
    document.getElementById('cameraInstruction').textContent = 'üì∏ Rasm olindi';
}

function retakePhoto() {
    capturedImageData = null;
    document.getElementById('aiVideo').style.display = 'block';
    document.getElementById('capturedImg').style.display = 'none';
    document.getElementById('captureControls').style.display = 'block';
    document.getElementById('actionControls').style.display = 'none';
    document.getElementById('cameraInstruction').textContent = 'üì∑ Ovqatni kameraga ko\'rsating';
}

function openGallery() {
    document.getElementById('galleryInput').click();
}

function handleGalleryImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            capturedImageData = e.target.result;
            document.getElementById('capturedImg').src = capturedImageData;
            document.getElementById('aiVideo').style.display = 'none';
            document.getElementById('capturedImg').style.display = 'block';
            document.getElementById('captureControls').style.display = 'none';
            document.getElementById('actionControls').style.display = 'flex';
            document.getElementById('cameraInstruction').textContent = 'üì∏ Rasm tanlandi';
        };
        reader.readAsDataURL(file);
    }
}

async function analyzePhoto() {
    if (!capturedImageData) return;
    
    document.getElementById('aiLoading').classList.add('show');
    
    try {
        const formData = new FormData();
        const response = await fetch(capturedImageData);
        const blob = await response.blob();
        formData.append('image', blob, 'food.jpg');
        
        const result = await fetch('/api/analyze-food/', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        });
        
        const data = await result.json();
        document.getElementById('aiLoading').classList.remove('show');
        
        if (data.success) {
            // Qolgan limit haqida xabar
            if (data.usage_info) {
                console.log(`Bugun ${data.usage_info.used_today}/${data.usage_info.daily_limit} ta ishlatildi`);
            }
            showAiResult(data.data, data.usage_info);
        } else if (data.require_login) {
            // Login talab qilinadi
            showLoginRequired();
        } else if (data.limit_exceeded) {
            // Limit tugadi
            showLimitExceeded(data.daily_limit);
        } else {
            showAiError(data.error || 'Tahlil qilib bo\'lmadi');
        }
    } catch (err) {
        document.getElementById('aiLoading').classList.remove('show');
        showAiError('Server bilan bog\'lanib bo\'lmadi');
    }
}

function showLoginRequired() {
    document.getElementById('aiLoading').classList.remove('show');
    document.getElementById('aiResultBody').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üîê</div>
            <h3 style="color: #f59e0b; margin-bottom: 15px;">Kirish talab qilinadi</h3>
            <p style="color: #9ca3af; margin-bottom: 25px; line-height: 1.6;">
                AI tahlil funksiyasidan foydalanish uchun<br>tizimga kirishingiz kerak
            </p>
            <a href="/login/?next=/scanner/" 
               style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); 
                      color: white; padding: 15px 35px; border-radius: 12px; text-decoration: none;
                      font-weight: 600; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);">
                <i class="fas fa-sign-in-alt"></i> Tizimga kirish
            </a>
            <p style="color: #6b7280; margin-top: 20px; font-size: 0.9rem;">
                Hisobingiz yo'qmi? 
                <a href="/register/" style="color: #667eea;">Ro'yxatdan o'ting</a>
            </p>
        </div>
    `;
    document.getElementById('aiResultModal').classList.add('show');
}

function showLimitExceeded(dailyLimit) {
    document.getElementById('aiLoading').classList.remove('show');
    document.getElementById('aiResultBody').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">‚è∞</div>
            <h3 style="color: #ef4444; margin-bottom: 15px;">Kunlik limit tugadi!</h3>
            <p style="color: #9ca3af; margin-bottom: 20px; line-height: 1.6;">
                Siz bugun <strong>${dailyLimit} ta</strong> rasm tahlil qildingiz.<br>
                Ertaga yana ${dailyLimit} ta imkoniyat bo'ladi.
            </p>
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); 
                        border-radius: 12px; padding: 15px; margin-top: 20px;">
                <p style="color: #f87171; font-size: 0.9rem;">
                    üí° <strong>Maslahat:</strong> Shtrix kod skaneri cheksiz ishlaydi!<br>
                    Mahsulotlarni shtrix kod orqali tekshirib ko'ring.
                </p>
            </div>
        </div>
    `;
    document.getElementById('aiResultModal').classList.add('show');
}

function showAiError(message) {
    document.getElementById('aiResultBody').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <h3 style="color: #f59e0b; margin-bottom: 10px;">Xatolik</h3>
            <p style="color: #9ca3af;">${message}</p>
        </div>
    `;
    document.getElementById('aiResultModal').classList.add('show');
}

// LocalStorage dan saqlangan AI natijani yuklash
function loadSavedAiResult() {
    const saved = localStorage.getItem('lastAiResult');
    const savedImage = localStorage.getItem('lastAiImage');
    if (saved && savedImage) {
        try {
            const data = JSON.parse(saved);
            capturedImageData = savedImage;
            showAiResult(data, null, true); // isFromCache = true
        } catch (e) {
            console.log('Saqlangan natija o\'qishda xato:', e);
        }
    }
}

// AI natijani tozalash
function clearAiResult() {
    localStorage.removeItem('lastAiResult');
    localStorage.removeItem('lastAiImage');
    document.getElementById('aiResultModal').classList.remove('show');
    document.getElementById('aiResultBody').innerHTML = '';
    capturedImageData = null;
}

// LocalStorage dan saqlangan shtrix kod natijasini yuklash
function loadSavedBarcodeResult() {
    const saved = localStorage.getItem('lastBarcodeResult');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            showProductResult(data.product, data.source, true); // isFromCache = true
        } catch (e) {
            console.log('Saqlangan shtrix kod natija o\'qishda xato:', e);
        }
    }
}

// Shtrix kod natijasini tozalash
function clearBarcodeResult() {
    localStorage.removeItem('lastBarcodeResult');
    document.getElementById('productResult').style.display = 'none';
    document.getElementById('productDisplay').innerHTML = '';
}

function showAiResult(data, usageInfo, isFromCache = false) {
    // LocalStorage ga saqlash (agar yangi natija bo'lsa)
    if (!isFromCache && data) {
        localStorage.setItem('lastAiResult', JSON.stringify(data));
        if (capturedImageData) {
            localStorage.setItem('lastAiImage', capturedImageData);
        }
    }
    const n = data.nutrition_per_100g || {};
    const calories = Math.round(n.calories || 0);
    const proteins = parseFloat(n.proteins) || 0;
    const carbs = parseFloat(n.carbohydrates) || 0;
    const fat = parseFloat(n.fat) || 0;
    const sugars = parseFloat(n.sugars) || 0;
    const salt = parseFloat(n.salt) || 0;
    const fiber = parseFloat(n.fiber) || 0;
    
    const portion = data.portion_info || {};
    const portionCal = portion.calories_per_portion || 0;
    const portionGrams = portion.typical_portion_grams || 0;
    
    const nutriscore = (data.nutriscore || 'C').toUpperCase();
    const dailyCal = Math.min(100, Math.round((calories / 2000) * 100));
    const circumference = 2 * Math.PI * 55;
    const offset = circumference - (dailyCal / 100) * circumference;
    
    const storage = data.storage || {};
    
    // Limit info banner
    let limitBanner = '';
    if (usageInfo) {
        const remaining = usageInfo.remaining;
        const used = usageInfo.used_today;
        const limit = usageInfo.daily_limit;
        const progressPercent = Math.round((used / limit) * 100);
        const barColor = remaining > 10 ? '#10b981' : remaining > 5 ? '#f59e0b' : '#ef4444';
        
        limitBanner = `
        <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); 
                    border-radius: 10px; padding: 10px 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 12px;">
            <div style="flex: 1;">
                <div style="font-size: 0.8rem; color: #9ca3af; margin-bottom: 5px;">Bugungi limit</div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 8px; overflow: hidden;">
                    <div style="background: ${barColor}; width: ${progressPercent}%; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; font-weight: bold; color: ${barColor};">${remaining}</div>
                <div style="font-size: 0.7rem; color: #6b7280;">qoldi</div>
            </div>
        </div>`;
    }
    
    document.getElementById('aiResultBody').innerHTML = `
        ${limitBanner}
        <!-- Tozalash tugmasi -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button onclick="clearAiResult()" 
                    style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); 
                           color: #f87171; padding: 8px 15px; border-radius: 8px; cursor: pointer;
                           font-size: 0.85rem; display: flex; align-items: center; gap: 6px; transition: all 0.3s;">
                <i class="fas fa-trash-alt"></i> Tozalash
            </button>
        </div>
        <!-- RASM TAHLILI BO'LIMI -->
        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #34d399; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.3rem;">üì∏</span> Rasm tahlili
                <span style="font-size: 0.7rem; background: rgba(16, 185, 129, 0.3); padding: 3px 8px; border-radius: 10px; margin-left: auto;">AI Vision</span>
            </h4>
            
            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <img src="${capturedImageData}" style="width: 90px; height: 90px; object-fit: cover; border-radius: 12px; border: 2px solid rgba(16,185,129,0.3);" alt="">
                <div style="flex: 1;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 5px; color: #fff;">${data.name || 'Noma\'lum'}</h3>
                    ${data.name_en ? `<p style="color: #9ca3af; font-size: 0.85rem; margin-bottom: 8px;">${data.name_en}</p>` : ''}
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${data.category ? `<span style="background: rgba(16,185,129,0.2); color: #34d399; padding: 3px 10px; border-radius: 8px; font-size: 0.75rem;">${data.category}</span>` : ''}
                        ${data.cooking_method ? `<span style="background: rgba(251,191,36,0.2); color: #fbbf24; padding: 3px 10px; border-radius: 8px; font-size: 0.75rem;">üç≥ ${data.cooking_method}</span>` : ''}
                        ${data.is_fried ? `<span style="background: rgba(239,68,68,0.2); color: #f87171; padding: 3px 10px; border-radius: 8px; font-size: 0.75rem;">üî• Qovurilgan</span>` : ''}
                        ${data.is_homemade ? `<span style="background: rgba(139,92,246,0.2); color: #a78bfa; padding: 3px 10px; border-radius: 8px; font-size: 0.75rem;">üè† Uy taomi</span>` : ''}
                    </div>
                </div>
            </div>
            
            ${data.description ? `<p style="color: #d1d5db; margin: 15px 0 10px; font-size: 0.9rem; line-height: 1.5; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">${data.description}</p>` : ''}
            
            <!-- Tarkibi -->
            ${data.ingredients ? `
            <div style="margin-top: 12px; padding: 12px; background: rgba(251,191,36,0.1); border-left: 3px solid #fbbf24; border-radius: 8px;">
                <h5 style="color: #fbbf24; margin-bottom: 8px; font-size: 0.85rem;">üìù Taxminiy tarkibi</h5>
                <p style="color: #e5e7eb; font-size: 0.85rem; line-height: 1.5;">${data.ingredients}</p>
            </div>
            ` : ''}
        </div>
        
        <!-- AI TAHLILI BO'LIMI -->
        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15)); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #c084fc; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.3rem;">ü§ñ</span> AI Ekspert Tahlili
                <span style="font-size: 0.7rem; background: linear-gradient(135deg, #8b5cf6, #ec4899); padding: 3px 10px; border-radius: 10px; margin-left: auto;">Dietolog xulosasi</span>
            </h4>
            
            <!-- Nutri-Score -->
            <div style="display: flex; gap: 5px; justify-content: center; margin: 15px 0;">
                <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #038141; color: white; opacity: ${nutriscore === 'A' ? '1' : '0.3'}; transform: ${nutriscore === 'A' ? 'scale(1.15)' : 'scale(1)'}; ${nutriscore === 'A' ? 'box-shadow: 0 0 15px rgba(3,129,65,0.5);' : ''}">A</div>
                <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #85bb2f; color: white; opacity: ${nutriscore === 'B' ? '1' : '0.3'}; transform: ${nutriscore === 'B' ? 'scale(1.15)' : 'scale(1)'}; ${nutriscore === 'B' ? 'box-shadow: 0 0 15px rgba(133,187,47,0.5);' : ''}">B</div>
                <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #fecb02; color: #333; opacity: ${nutriscore === 'C' ? '1' : '0.3'}; transform: ${nutriscore === 'C' ? 'scale(1.15)' : 'scale(1)'}; ${nutriscore === 'C' ? 'box-shadow: 0 0 15px rgba(254,203,2,0.5);' : ''}">C</div>
                <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #ee8100; color: white; opacity: ${nutriscore === 'D' ? '1' : '0.3'}; transform: ${nutriscore === 'D' ? 'scale(1.15)' : 'scale(1)'}; ${nutriscore === 'D' ? 'box-shadow: 0 0 15px rgba(238,129,0,0.5);' : ''}">D</div>
                <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #e63e11; color: white; opacity: ${nutriscore === 'E' ? '1' : '0.3'}; transform: ${nutriscore === 'E' ? 'scale(1.15)' : 'scale(1)'}; ${nutriscore === 'E' ? 'box-shadow: 0 0 15px rgba(230,62,17,0.5);' : ''}">E</div>
            </div>
            
            <!-- Kaloriya va porsiya -->
            <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                <!-- 100g uchun -->
                <div style="text-align: center;">
                    <div style="position: relative; width: 110px; height: 110px;">
                        <svg width="110" height="110" style="transform: rotate(-90deg);">
                            <defs>
                                <linearGradient id="calGrad3" x1="0%" y1="0%" x2="100%">
                                    <stop offset="0%" stop-color="#ff6b6b"/>
                                    <stop offset="100%" stop-color="#feca57"/>
                                </linearGradient>
                            </defs>
                            <circle cx="55" cy="55" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
                            <circle cx="55" cy="55" r="45" fill="none" stroke="url(#calGrad3)" stroke-width="8" stroke-linecap="round"
                                stroke-dasharray="${2 * Math.PI * 45}"
                                stroke-dashoffset="${2 * Math.PI * 45 - (dailyCal / 100) * 2 * Math.PI * 45}"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #ff6b6b;">${calories}</div>
                            <div style="color: #9ca3af; font-size: 0.65rem;">kkal</div>
                        </div>
                    </div>
                    <div style="color: #9ca3af; font-size: 0.75rem; margin-top: 5px;">100g uchun</div>
                </div>
                
                <!-- 1 porsiya uchun -->
                ${portionCal ? `
                <div style="text-align: center;">
                    <div style="position: relative; width: 110px; height: 110px;">
                        <svg width="110" height="110" style="transform: rotate(-90deg);">
                            <defs>
                                <linearGradient id="portionGrad" x1="0%" y1="0%" x2="100%">
                                    <stop offset="0%" stop-color="#8b5cf6"/>
                                    <stop offset="100%" stop-color="#ec4899"/>
                                </linearGradient>
                            </defs>
                            <circle cx="55" cy="55" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
                            <circle cx="55" cy="55" r="45" fill="none" stroke="url(#portionGrad)" stroke-width="8" stroke-linecap="round"
                                stroke-dasharray="${2 * Math.PI * 45}"
                                stroke-dashoffset="${2 * Math.PI * 45 - (Math.min(100, portionCal / 20) / 100) * 2 * Math.PI * 45}"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #c084fc;">${portionCal}</div>
                            <div style="color: #9ca3af; font-size: 0.65rem;">kkal</div>
                        </div>
                    </div>
                    <div style="color: #9ca3af; font-size: 0.75rem; margin-top: 5px;">1 dona (~${portionGrams}g)</div>
                </div>
                ` : ''}
            </div>
            
            <!-- Makrolar -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0;">
                <div style="background: rgba(16, 185, 129, 0.15); padding: 10px 5px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: #10b981;">${proteins}g</div>
                    <div style="color: #10b981; font-size: 0.7rem;">Oqsil</div>
                </div>
                <div style="background: rgba(245, 158, 11, 0.15); padding: 10px 5px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: #f59e0b;">${carbs}g</div>
                    <div style="color: #f59e0b; font-size: 0.7rem;">Uglevod</div>
                </div>
                <div style="background: rgba(239, 68, 68, 0.15); padding: 10px 5px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">${fat}g</div>
                    <div style="color: #ef4444; font-size: 0.7rem;">Yog'</div>
                </div>
                <div style="background: rgba(168, 85, 247, 0.15); padding: 10px 5px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: #a855f7;">${sugars}g</div>
                    <div style="color: #a855f7; font-size: 0.7rem;">Shakar</div>
                </div>
            </div>
            
            <!-- Foydalari -->
            ${data.health_benefits && data.health_benefits.length ? `
            <div style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #4ade80; margin-bottom: 8px; font-size: 0.9rem;">üíö Foydalari</h5>
                ${data.health_benefits.map(b => `<div style="display: flex; gap: 8px; padding: 4px 0; font-size: 0.85rem;"><span style="color: #4ade80;">‚úì</span><span>${b}</span></div>`).join('')}
            </div>
            ` : ''}
            
            <!-- Zararlari -->
            ${data.health_risks && data.health_risks.length ? `
            <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #f87171; margin-bottom: 8px; font-size: 0.9rem;">‚ö†Ô∏è Ogohlantirishlar</h5>
                ${data.health_risks.map(r => `<div style="display: flex; gap: 8px; padding: 4px 0; font-size: 0.85rem;"><span style="color: #f87171;">!</span><span>${r}</span></div>`).join('')}
            </div>
            ` : ''}
            
            <!-- Tavsiyalar -->
            <div style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1; padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #a5b4fc; margin-bottom: 8px; font-size: 0.9rem;">‚è∞ Tavsiyalar</h5>
                ${data.best_time_to_eat ? `<p style="font-size: 0.85rem; margin: 6px 0;"><span style="color: #9ca3af;">üïê Qachon yeyish:</span> ${data.best_time_to_eat}</p>` : ''}
                ${data.daily_limit ? `<p style="font-size: 0.85rem; margin: 6px 0;"><span style="color: #9ca3af;">üìè Kunlik miqdor:</span> ${data.daily_limit}</p>` : ''}
                ${data.who_should_avoid ? `<p style="font-size: 0.85rem; margin: 6px 0; color: #fca5a5;"><span style="color: #9ca3af;">üö´ Kimlar yemasin:</span> ${data.who_should_avoid}</p>` : ''}
            </div>
            
            <!-- Saqlash -->
            ${storage.method ? `
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #9ca3af; margin-bottom: 8px; font-size: 0.9rem;">üì¶ Saqlash</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
                    <div><span style="color: #6b7280;">Usul:</span> ${storage.method}</div>
                    ${storage.temperature ? `<div><span style="color: #6b7280;">Harorat:</span> ${storage.temperature}</div>` : ''}
                    ${storage.duration ? `<div><span style="color: #6b7280;">Muddat:</span> ${storage.duration}</div>` : ''}
                </div>
            </div>
            ` : ''}
            
            <!-- Nima bilan yaxshi ketadi -->
            ${data.pairs_well_with && data.pairs_well_with.length ? `
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #9ca3af; margin-bottom: 8px; font-size: 0.9rem;">üçΩÔ∏è Nima bilan yaxshi ketadi</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    ${data.pairs_well_with.map(p => `<span style="background: rgba(16,185,129,0.2); color: #34d399; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem;">${p}</span>`).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Sog'liq xulosasi -->
            ${data.health_summary ? `
            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #9ca3af; margin-bottom: 8px; font-size: 0.9rem;">üè• Sog'liqqa ta'siri</h5>
                <p style="font-size: 0.85rem; line-height: 1.5; color: #d1d5db;">${data.health_summary}</p>
            </div>
            ` : ''}
            
            <!-- YAKUNIY XULOSA -->
            ${data.recommendation || data.serving_suggestion ? `
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(236, 72, 153, 0.25)); border: 2px solid rgba(139, 92, 246, 0.5); padding: 15px; border-radius: 12px; margin: 15px 0;">
                <h5 style="color: #e879f9; margin-bottom: 10px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">üéØ AI Yakuniy Xulosa</h5>
                ${data.recommendation ? `<p style="font-size: 0.9rem; line-height: 1.6; color: #fff; margin-bottom: 8px;">${data.recommendation}</p>` : ''}
                ${data.serving_suggestion ? `<p style="font-size: 0.85rem; line-height: 1.5; color: #d1d5db;"><span style="color: #a5b4fc;">üí° Tavsiya:</span> ${data.serving_suggestion}</p>` : ''}
            </div>
            ` : ''}
            
            <!-- Qo'shimcha belgilar -->
            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                ${data.is_vegan ? `<span style="background: rgba(34,197,94,0.2); color: #4ade80; padding: 5px 12px; border-radius: 15px; font-size: 0.75rem;">ü•¨ Vegan</span>` : ''}
                ${data.is_gluten_free ? `<span style="background: rgba(251,191,36,0.2); color: #fbbf24; padding: 5px 12px; border-radius: 15px; font-size: 0.75rem;">üåæ Glutensiz</span>` : ''}
                ${data.confidence ? `<span style="background: rgba(99,102,241,0.2); color: #a5b4fc; padding: 5px 12px; border-radius: 15px; font-size: 0.75rem;">üìä ${Math.round(data.confidence * 100)}% aniqlik</span>` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('aiResultModal').classList.add('show');
}

function closeAiResult() {
    document.getElementById('aiResultModal').classList.remove('show');
    retakePhoto();
}

function toggleFlash() {
    // Flash toggle (agar mavjud bo'lsa)
    if (aiStream) {
        const track = aiStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        if (capabilities.torch) {
            const settings = track.getSettings();
            track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
        }
    }
}

// ===== BARCODE SCANNER (ZXing) =====
let scannerVideo = null;
let scannerStream = null;
let html5QrcodeScanner = null;
let scanInterval = null;
let isScanning = false;

async function startScanner() {
    const readerDiv = document.getElementById('reader');
    
    // Skaner uchun container yaratish
    readerDiv.innerHTML = `
        <div id="qr-reader" style="width: 100%; border-radius: 15px; overflow: hidden;"></div>
        <div id="scanStatus" style="text-align: center; margin-top: 10px; padding: 10px; 
                    background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 10px;">
            üì∑ Shtrix kodni kameraga tutib turing...
        </div>
        <style>
            #qr-reader video { border-radius: 15px !important; }
            #qr-reader__scan_region { border-radius: 15px !important; overflow: hidden; }
            #qr-reader__dashboard { background: transparent !important; }
            #qr-reader__dashboard_section { display: none !important; }
            #qr-reader__dashboard_section_csr { display: none !important; }
            #qr-reader__status_span { display: none !important; }
        </style>
    `;
    
    try {
        // Html5Qrcode skaner - ZXing asosida, barcha formatlarni o'qiydi
        html5QrcodeScanner = new Html5Qrcode("qr-reader", {
            formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.ITF,
                Html5QrcodeSupportedFormats.CODABAR,
                Html5QrcodeSupportedFormats.DATA_MATRIX,
                Html5QrcodeSupportedFormats.PDF_417
            ],
            verbose: false
        });
        
        await html5QrcodeScanner.start(
            { facingMode: "environment" },
            {
                fps: 10,
                qrbox: { width: 280, height: 150 },
                aspectRatio: 1.5
            },
            (decodedText, decodedResult) => {
                // Muvaffaqiyatli o'qildi
                const format = decodedResult?.result?.format?.formatName || 'BARCODE';
                console.log('‚úÖ ZXing topdi:', decodedText, 'Format:', format);
                document.getElementById('scanStatus').innerHTML = `
                    <span style="color: #4ade80;">‚úì</span> <strong>${format}</strong>: ${decodedText}
                `;
                // Vibrate (agar mavjud bo'lsa)
                if (navigator.vibrate) navigator.vibrate(100);
                handleScanResult(decodedText);
            },
            (errorMessage) => {
                // Skanerlash davom etmoqda
            }
        );
        
        isScanning = true;
    } catch (err) {
        console.error('Kamera xatosi:', err);
        readerDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <i class="fas fa-camera-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>Kamera ruxsati berilmagan</h3>
                <p>Iltimos, brauzer sozlamalaridan kamera ruxsatini bering</p>
            </div>
        `;
    }
}

function getFormatName(format) {
    const names = {
        0: 'AZTEC', 1: 'CODABAR', 2: 'CODE 39', 3: 'CODE 93', 4: 'CODE 128',
        5: 'DATA MATRIX', 6: 'EAN-8', 7: 'EAN-13', 8: 'ITF', 9: 'MAXICODE',
        10: 'PDF 417', 11: 'QR CODE', 12: 'RSS 14', 13: 'RSS EXPANDED',
        14: 'UPC-A', 15: 'UPC-E', 16: 'UPC EAN'
    };
    return names[format] || 'BARCODE';
}

function stopScanner() {
    isScanning = false;
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
            }).catch(err => console.log('Scanner stop error:', err));
        } catch (e) {
            console.log('Scanner stop exception:', e);
        }
        html5QrcodeScanner = null;
    }
}

function handleScanResult(code) {
    stopScanner();
    
    if (code.startsWith('http://') || code.startsWith('https://')) {
        showQRResult('url', code);
    } else if (code.startsWith('mailto:')) {
        showQRResult('email', code);
    } else if (code.startsWith('tel:')) {
        showQRResult('phone', code);
    } else if (code.startsWith('WIFI:')) {
        showQRResult('wifi', code);
    } else if (/^\d{8,14}$/.test(code)) {
        document.getElementById('barcodeInput').value = code;
        searchBarcode();
    } else {
        showQRResult('text', code);
    }
}

function showQRResult(type, content) {
    let html = '<div class="qr-result">';
    
    switch(type) {
        case 'url':
            html += `<h3><i class="fas fa-link"></i> Havola topildi</h3>
                <div class="qr-content">${content}</div>
                <a href="${content}" target="_blank" class="action-btn">
                    <i class="fas fa-external-link-alt"></i> Havolani ochish
                </a>`;
            break;
        case 'email':
            html += `<h3><i class="fas fa-envelope"></i> Email topildi</h3>
                <div class="qr-content">${content.replace('mailto:', '')}</div>
                <a href="${content}" class="action-btn">
                    <i class="fas fa-paper-plane"></i> Xat yuborish
                </a>`;
            break;
        case 'phone':
            html += `<h3><i class="fas fa-phone"></i> Telefon raqami</h3>
                <div class="qr-content">${content.replace('tel:', '')}</div>
                <a href="${content}" class="action-btn">
                    <i class="fas fa-phone-alt"></i> Qo'ng'iroq qilish
                </a>`;
            break;
        case 'wifi':
            html += `<h3><i class="fas fa-wifi"></i> WiFi ma'lumotlari</h3>
                <div class="qr-content">${content}</div>`;
            break;
        default:
            html += `<h3><i class="fas fa-qrcode"></i> QR kod ma'lumoti</h3>
                <div class="qr-content">${content}</div>
                <button onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')" class="action-btn">
                    <i class="fas fa-copy"></i> Nusxalash
                </button>`;
    }
    
    html += '</div>';
    document.getElementById('resultCard').innerHTML = html;
    document.getElementById('resultCard').style.display = 'block';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert('Nusxalandi!'));
}

function searchBarcode() {
    const barcode = document.getElementById('barcodeInput').value.trim();
    if (!barcode) {
        alert('Iltimos, barcode kiriting');
        return;
    }
    
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('resultCard').style.display = 'none';
    
    fetch('/api/barcode/lookup/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ barcode: barcode })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingDiv').style.display = 'none';
        
        if (data.success && data.found) {
            showProductResult(data.product, data.source);
        } else {
            showNotFound(barcode);
        }
    })
    .catch(error => {
        document.getElementById('loadingDiv').style.display = 'none';
        alert('Xatolik yuz berdi');
    });
}

function showProductResult(product, source, isFromCache = false) {
    // LocalStorage ga saqlash (agar yangi natija bo'lsa)
    if (!isFromCache && product) {
        localStorage.setItem('lastBarcodeResult', JSON.stringify({product, source}));
    }
    
    const calories = Math.round(product.calories || 0);
    const proteins = parseFloat(product.proteins) || 0;
    const carbs = parseFloat(product.carbohydrates) || 0;
    const fat = parseFloat(product.fat) || 0;
    const sugars = parseFloat(product.sugars) || 0;
    const salt = parseFloat(product.salt) || 0;
    
    // AI tahlili mavjudmi
    const ai = product.ai_analysis || {};
    const rawApi = product.raw_api_data || {};
    
    // Nutri-Score
    let nutriGrade = ai.health_rating || product.nutriscore_grade || '';
    if (!nutriGrade && calories) {
        if (calories < 100 && sugars < 5) nutriGrade = 'A';
        else if (calories < 200 && sugars < 10) nutriGrade = 'B';
        else if (calories < 300) nutriGrade = 'C';
        else if (calories < 400) nutriGrade = 'D';
        else nutriGrade = 'E';
    }
    nutriGrade = nutriGrade.toUpperCase() || 'C';
    
    // Kunlik foizlar
    const dailyCal = Math.min(100, Math.round((calories / 2000) * 100));
    const dailyProtein = Math.min(100, Math.round((proteins / 50) * 100));
    const dailyCarbs = Math.min(100, Math.round((carbs / 300) * 100));
    const dailyFat = Math.min(100, Math.round((fat / 65) * 100));
    
    let html = `
        <div class="result-header" style="background: linear-gradient(135deg, #10b981, #059669);">
            ${product.image_url ? `<img src="${product.image_url}" class="product-image" onerror="this.style.display='none'">` : '<div style="width:80px;height:80px;background:rgba(255,255,255,0.2);border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;">üì¶</div>'}
            <div class="product-title">
                <h2>${product.name || 'Nomsiz mahsulot'}</h2>
                <p>${product.brand || ''} ${product.weight ? '‚Ä¢ ' + product.weight : ''}</p>
            </div>
        </div>
        <div class="result-body" style="background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); color: white; border-radius: 0 0 20px 20px; padding: 20px;">
    `;
    
    // ===== 1. SHTRIX KOD MA'LUMOTLARI (API dan) =====
    if (rawApi.source) {
        html += `
            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: #60a5fa; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.3rem;">üìä</span> Shtrix kod ma'lumotlari
                    <span style="font-size: 0.7rem; background: rgba(59, 130, 246, 0.3); padding: 3px 8px; border-radius: 10px; margin-left: auto;">${rawApi.source}</span>
                </h4>
                <div style="display: grid; gap: 8px; font-size: 0.9rem;">
                    ${rawApi.name ? `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);"><span style="color: #9ca3af;">Nomi:</span><span>${rawApi.name}</span></div>` : ''}
                    ${rawApi.brand ? `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);"><span style="color: #9ca3af;">Brend:</span><span>${rawApi.brand}</span></div>` : ''}
                    ${rawApi.calories ? `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);"><span style="color: #9ca3af;">Kaloriya:</span><span>${rawApi.calories} kkal</span></div>` : ''}
                    ${rawApi.proteins ? `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);"><span style="color: #9ca3af;">Oqsil:</span><span>${rawApi.proteins}g</span></div>` : ''}
                    ${rawApi.carbohydrates ? `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);"><span style="color: #9ca3af;">Uglevod:</span><span>${rawApi.carbohydrates}g</span></div>` : ''}
                    ${rawApi.fat ? `<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);"><span style="color: #9ca3af;">Yog':</span><span>${rawApi.fat}g</span></div>` : ''}
                    ${rawApi.nutriscore_grade ? `<div style="display: flex; justify-content: space-between; padding: 5px 0;"><span style="color: #9ca3af;">Nutri-Score:</span><span style="font-weight: 600;">${rawApi.nutriscore_grade.toUpperCase()}</span></div>` : ''}
                </div>
            </div>
        `;
    }
    
    // ===== 2. AI TAHLILI =====
    html += `
        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15)); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #c084fc; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.3rem;">ü§ñ</span> AI Tahlili
                <span style="font-size: 0.7rem; background: linear-gradient(135deg, #8b5cf6, #ec4899); padding: 3px 10px; border-radius: 10px; margin-left: auto;">Ekspert xulosa</span>
            </h4>
    `;
    
    // Nutri-Score vizual
    html += `
        <div style="display: flex; gap: 5px; justify-content: center; margin: 15px 0;">
            <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #038141; color: white; opacity: ${nutriGrade === 'A' ? '1' : '0.3'}; transform: ${nutriGrade === 'A' ? 'scale(1.15)' : 'scale(1)'};">A</div>
            <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #85bb2f; color: white; opacity: ${nutriGrade === 'B' ? '1' : '0.3'}; transform: ${nutriGrade === 'B' ? 'scale(1.15)' : 'scale(1)'};">B</div>
            <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #fecb02; color: #333; opacity: ${nutriGrade === 'C' ? '1' : '0.3'}; transform: ${nutriGrade === 'C' ? 'scale(1.15)' : 'scale(1)'};">C</div>
            <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #ee8100; color: white; opacity: ${nutriGrade === 'D' ? '1' : '0.3'}; transform: ${nutriGrade === 'D' ? 'scale(1.15)' : 'scale(1)'};">D</div>
            <div style="width: 40px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; border-radius: 8px; background: #e63e11; color: white; opacity: ${nutriGrade === 'E' ? '1' : '0.3'}; transform: ${nutriGrade === 'E' ? 'scale(1.15)' : 'scale(1)'};">E</div>
        </div>
    `;
    
    // AI tomonidan tavsif
    if (ai.description || product.description) {
        html += `<p style="color: #d1d5db; margin: 15px 0; font-style: italic; text-align: center;">"${ai.description || product.description}"</p>`;
    }
    
    // Kaloriya va makro
    html += `
        <div style="display: flex; justify-content: center; margin: 20px 0;">
            <div style="position: relative; width: 130px; height: 130px;">
                <svg width="130" height="130" style="transform: rotate(-90deg);">
                    <defs>
                        <linearGradient id="calGradient2" x1="0%" y1="0%" x2="100%">
                            <stop offset="0%" stop-color="#ff6b6b"/>
                            <stop offset="100%" stop-color="#feca57"/>
                        </linearGradient>
                    </defs>
                    <circle cx="65" cy="65" r="55" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="10"/>
                    <circle cx="65" cy="65" r="55" fill="none" stroke="url(#calGradient2)" stroke-width="10" stroke-linecap="round"
                        stroke-dasharray="${2 * Math.PI * 55}"
                        stroke-dashoffset="${2 * Math.PI * 55 - (dailyCal / 100) * 2 * Math.PI * 55}"/>
                </svg>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 700; background: linear-gradient(135deg, #ff6b6b, #feca57); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${calories}</div>
                    <div style="color: #9ca3af; font-size: 0.75rem;">kkal</div>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
            <div style="background: rgba(16, 185, 129, 0.15); padding: 12px 8px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.3rem; font-weight: 700; color: #10b981;">${proteins}g</div>
                <div style="color: #10b981; font-size: 0.75rem;">Oqsil</div>
            </div>
            <div style="background: rgba(245, 158, 11, 0.15); padding: 12px 8px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.3rem; font-weight: 700; color: #f59e0b;">${carbs}g</div>
                <div style="color: #f59e0b; font-size: 0.75rem;">Uglevod</div>
            </div>
            <div style="background: rgba(239, 68, 68, 0.15); padding: 12px 8px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.3rem; font-weight: 700; color: #ef4444;">${fat}g</div>
                <div style="color: #ef4444; font-size: 0.75rem;">Yog'</div>
            </div>
        </div>
    `;
    
    // AI - Foydalari
    const benefits = ai.benefits || product.benefits || [];
    if (benefits.length > 0) {
        html += `
            <div style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #4ade80; margin-bottom: 8px; font-size: 0.9rem;">üíö Foydalari</h5>
                ${benefits.map(b => `<div style="display: flex; gap: 8px; padding: 4px 0; font-size: 0.85rem;"><span style="color: #4ade80;">‚úì</span><span>${b}</span></div>`).join('')}
            </div>
        `;
    }
    
    // AI - Zararlari
    const risks = ai.risks || product.risks || [];
    if (risks.length > 0) {
        html += `
            <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #f87171; margin-bottom: 8px; font-size: 0.9rem;">‚ö†Ô∏è Ogohlantirishlar</h5>
                ${risks.map(r => `<div style="display: flex; gap: 8px; padding: 4px 0; font-size: 0.85rem;"><span style="color: #f87171;">!</span><span>${r}</span></div>`).join('')}
            </div>
        `;
    }
    
    // AI - Qachon iste'mol qilish
    const bestTime = ai.best_time || product.best_time;
    const dailyLimit = ai.daily_limit || product.daily_limit;
    const whoShouldAvoid = ai.who_should_avoid || '';
    if (bestTime || dailyLimit) {
        html += `
            <div style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid #6366f1; padding: 12px; border-radius: 8px; margin: 12px 0;">
                <h5 style="color: #a5b4fc; margin-bottom: 8px; font-size: 0.9rem;">‚è∞ Tavsiyalar</h5>
                ${bestTime ? `<p style="font-size: 0.85rem; margin: 4px 0;"><span style="color: #9ca3af;">Qachon:</span> ${bestTime}</p>` : ''}
                ${dailyLimit ? `<p style="font-size: 0.85rem; margin: 4px 0;"><span style="color: #9ca3af;">Kunlik:</span> ${dailyLimit}</p>` : ''}
                ${whoShouldAvoid ? `<p style="font-size: 0.85rem; margin: 4px 0; color: #fca5a5;"><span style="color: #9ca3af;">Kimlar ichmasin:</span> ${whoShouldAvoid}</p>` : ''}
            </div>
        `;
    }
    
    // AI - Yakuniy xulosa
    const conclusion = ai.conclusion || ai.health_summary || product.health_summary;
    if (conclusion) {
        html += `
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2)); border: 1px solid rgba(139, 92, 246, 0.4); padding: 15px; border-radius: 12px; margin: 15px 0;">
                <h5 style="color: #e879f9; margin-bottom: 10px; font-size: 0.9rem;">üéØ AI Yakuniy Xulosa</h5>
                <p style="font-size: 0.9rem; line-height: 1.6; color: #e5e7eb;">${conclusion}</p>
            </div>
        `;
    }
    
    html += `</div>`; // AI tahlili end
    
    // ===== 3. TARKIB VA QO'SHIMCHA MA'LUMOTLAR =====
    // Tarkibi
    if (product.ingredients) {
        html += `
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin: 15px 0;">
                <h4 style="color: #9ca3af; margin-bottom: 10px; font-size: 0.9rem;">üìù Tarkibi</h4>
                <p style="line-height: 1.5; color: #d1d5db; font-size: 0.85rem;">${product.ingredients}</p>
            </div>
        `;
    }
    
    // Allergenlar
    if (product.allergens) {
        html += `
            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 12px; border-radius: 12px; margin: 12px 0;">
                <h5 style="color: #fbbf24; margin-bottom: 8px; font-size: 0.9rem;">üö´ Allergenlar</h5>
                <p style="font-size: 0.85rem;">${product.allergens}</p>
            </div>
        `;
    }
    
    // Qo'shimcha ma'lumotlar
    html += `
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin: 15px 0;">
            <h4 style="color: #9ca3af; margin-bottom: 12px; font-size: 0.9rem;">‚ÑπÔ∏è Qo'shimcha</h4>
            <div style="display: grid; gap: 6px; font-size: 0.85rem;">
                <div style="display: flex; justify-content: space-between; padding: 4px 0;"><span style="color: #6b7280;">Barcode</span><span style="font-family: monospace;">${product.barcode}</span></div>
                ${product.brand ? `<div style="display: flex; justify-content: space-between; padding: 4px 0;"><span style="color: #6b7280;">Brend</span><span>${product.brand}</span></div>` : ''}
                ${product.country ? `<div style="display: flex; justify-content: space-between; padding: 4px 0;"><span style="color: #6b7280;">Mamlakat</span><span>${product.country.replace('en:', '').replace('uz:', '')}</span></div>` : ''}
                ${source ? `<div style="display: flex; justify-content: space-between; padding: 4px 0;"><span style="color: #6b7280;">Ma'lumot manbasi</span><span>${source}</span></div>` : ''}
            </div>
        </div>
        
        <!-- Tozalash tugmasi -->
        <div style="text-align: center; margin-top: 15px; padding-bottom: 10px;">
            <button onclick="clearBarcodeResult()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 0.95rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); display: inline-flex; align-items: center; gap: 8px;">
                <span>üóëÔ∏è</span> Tozalash
            </button>
        </div>
    `;
    
    html += '</div>'; // result-body end
    
    document.getElementById('resultCard').innerHTML = html;
    document.getElementById('resultCard').style.display = 'block';
    document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
}

function showNotFound(barcode) {
    document.getElementById('resultCard').innerHTML = `
        <div class="result-header error">
            <i class="fas fa-times-circle" style="font-size: 2.5rem;"></i>
            <div class="product-title">
                <h2>Mahsulot topilmadi</h2>
                <p>Barcode: ${barcode}</p>
            </div>
        </div>
        <div class="result-body">
            <div class="not-found">
                <i class="fas fa-box-open"></i>
                <h3>Bu mahsulot bazada mavjud emas</h3>
                <p style="color: #9ca3af; margin-bottom: 20px;">
                    Open Food Facts bazasida ham topilmadi.
                </p>
                <button class="scan-btn" onclick="addNewProduct('${barcode}')">
                    <i class="fas fa-plus"></i> Mahsulot qo'shish
                </button>
            </div>
        </div>`;
    document.getElementById('resultCard').style.display = 'block';
}

function addNewProduct(barcode) {
    const name = prompt('Mahsulot nomini kiriting:');
    if (!name) return;
    
    fetch('/api/barcode/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ barcode: barcode, name: name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Mahsulot qo\'shildi!');
            searchBarcode();
        } else {
            alert('Xatolik: ' + (data.error || 'Noma\'lum'));
        }
    });
}

// Sahifa yuklanganda saqlangan natijalarni ko'rsatish
document.addEventListener('DOMContentLoaded', function() {
    loadSavedAiResult();
    loadSavedBarcodeResult();
});
</script>
{% endblock %}
