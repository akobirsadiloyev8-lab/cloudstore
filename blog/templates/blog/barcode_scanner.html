{% extends 'blog/boshlash.html' %}
{% load static %}

{% block title %}QR & Barcode Skaner - Cloudstore AI{% endblock %}

{% block extra_styles %}
.scanner-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.scanner-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    color: white;
    margin-bottom: 25px;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
}

.scanner-hero h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.scanner-hero p {
    opacity: 0.9;
    font-size: 1rem;
}

.mode-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 8px;
}

.mode-tab {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    background: transparent;
    color: #666;
}

.mode-tab.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

.mode-tab:hover:not(.active) {
    background: rgba(102, 126, 234, 0.1);
}

.scanner-section {
    background: white;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.manual-input {
    display: flex;
    gap: 10px;
}

.manual-input input {
    flex: 1;
    padding: 15px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1.1rem;
    transition: all 0.3s;
}

.manual-input input:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.scan-btn {
    padding: 15px 30px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.scan-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

#reader {
    width: 100%;
    border-radius: 15px;
    overflow: hidden;
}

#reader video {
    border-radius: 15px;
}

.result-card {
    display: none;
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    animation: slideUp 0.5s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-header {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.result-header.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.result-header.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.product-image {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    object-fit: cover;
    background: white;
}

.product-title {
    flex: 1;
}

.product-title h2 {
    font-size: 1.3rem;
    margin-bottom: 5px;
}

.product-title p {
    opacity: 0.9;
    font-size: 0.9rem;
}

.result-body {
    padding: 25px;
}

.health-scores {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.score-badge {
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nutri-a { background: #22c55e; color: white; }
.nutri-b { background: #84cc16; color: white; }
.nutri-c { background: #fbbf24; color: #333; }
.nutri-d { background: #f97316; color: white; }
.nutri-e { background: #ef4444; color: white; }

.nova-1 { background: #22c55e; color: white; }
.nova-2 { background: #84cc16; color: white; }
.nova-3 { background: #fbbf24; color: #333; }
.nova-4 { background: #ef4444; color: white; }

.warnings-box {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 2px solid #f59e0b;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
}

.warnings-box h4 {
    color: #92400e;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.warnings-box p {
    color: #78350f;
    font-size: 0.95rem;
    margin: 5px 0;
}

.info-section {
    margin-bottom: 20px;
}

.info-section h3 {
    font-size: 1.1rem;
    color: #374151;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}

.info-section h3 i {
    color: #667eea;
}

.nutrition-table {
    width: 100%;
    border-collapse: collapse;
}

.nutrition-table tr {
    border-bottom: 1px solid #f3f4f6;
}

.nutrition-table tr:last-child {
    border-bottom: none;
}

.nutrition-table td {
    padding: 10px 5px;
}

.nutrition-table td:first-child {
    color: #6b7280;
}

.nutrition-table td:last-child {
    text-align: right;
    font-weight: 600;
    color: #374151;
}

.nutrition-table .highlight {
    background: #fef3c7;
}

.nutrition-table .highlight td {
    color: #92400e;
}

.vitamins-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
}

.vitamin-item {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    padding: 12px;
    border-radius: 10px;
    text-align: center;
}

.vitamin-item .name {
    font-size: 0.85rem;
    color: #0369a1;
    margin-bottom: 5px;
}

.vitamin-item .value {
    font-weight: 700;
    color: #0c4a6e;
}

.ingredients-text {
    background: #f9fafb;
    padding: 15px;
    border-radius: 12px;
    line-height: 1.6;
    color: #4b5563;
    font-size: 0.95rem;
}

.allergens-box {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    border: 2px solid #ef4444;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}

.allergens-box h4 {
    color: #991b1b;
    margin-bottom: 8px;
}

.allergens-box p {
    color: #7f1d1d;
}

.additives-box {
    background: linear-gradient(135deg, #fef9c3, #fef08a);
    border: 2px solid #eab308;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.additives-box h4 {
    color: #713f12;
    margin-bottom: 8px;
}

.additives-box p {
    color: #78350f;
    font-size: 0.9rem;
}

.qr-result {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
}

.qr-result h3 {
    color: #0369a1;
    margin-bottom: 15px;
}

.qr-result .qr-content {
    background: white;
    padding: 15px;
    border-radius: 10px;
    word-break: break-all;
    margin-bottom: 15px;
}

.qr-result .action-btn {
    padding: 12px 25px;
    background: linear-gradient(135deg, #0ea5e9, #0284c7);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.not-found {
    text-align: center;
    padding: 30px;
}

.not-found i {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 15px;
}

.not-found h3 {
    color: #6b7280;
    margin-bottom: 10px;
}

.loading {
    display: none;
    text-align: center;
    padding: 40px;
}

.loading i {
    font-size: 3rem;
    color: #667eea;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* AI Kamera rejimi stillari */
.ai-camera-section {
    position: relative;
    background: #000;
    border-radius: 20px;
    overflow: hidden;
    min-height: 400px;
}

.ai-camera-section video {
    width: 100%;
    height: 400px;
    object-fit: cover;
}

.ai-camera-section .captured-img {
    width: 100%;
    height: 400px;
    object-fit: cover;
    display: none;
}

.camera-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
}

.capture-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: transparent;
    border: 4px solid #4ade80;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.capture-btn:hover {
    transform: scale(1.05);
}

.capture-btn-inner {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    background: #4ade80;
}

.side-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 1.3rem;
    cursor: pointer;
}

.action-buttons {
    display: none;
    gap: 15px;
}

.retake-btn, .analyze-btn {
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
}

.retake-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
}

.analyze-btn {
    background: linear-gradient(135deg, #4ade80, #22c55e);
    border: none;
    color: white;
}

.camera-instruction {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    padding: 10px 20px;
    border-radius: 20px;
    color: white;
    text-align: center;
    font-size: 0.9rem;
}

/* AI Natija modali */
.ai-result-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    z-index: 9999;
    overflow-y: auto;
}

.ai-result-modal.show {
    display: block;
}

.ai-result-content {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    padding-bottom: 100px;
}

.ai-result-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    position: sticky;
    top: 0;
    background: rgba(10,10,10,0.95);
    padding: 15px 0;
    z-index: 10;
}

.close-ai-result {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.ai-result-header h2 {
    color: white;
    font-size: 1.2rem;
}

/* AI Product Card */
.ai-product-card {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 15px;
    color: white;
}

.ai-product-header {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.ai-product-img {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    object-fit: cover;
}

.ai-product-info h2 {
    font-size: 1.3rem;
    margin-bottom: 5px;
}

.ai-product-info .category {
    display: inline-block;
    background: rgba(74, 222, 128, 0.2);
    color: #4ade80;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
}

/* Nutri-Score bar */
.ns-bar {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin: 15px 0;
}

.ns-letter {
    width: 40px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border-radius: 8px;
    opacity: 0.3;
    transition: all 0.3s;
}

.ns-letter.active {
    opacity: 1;
    transform: scale(1.2);
}

.ns-a { background: #038141; color: white; }
.ns-b { background: #85bb2f; color: white; }
.ns-c { background: #fecb02; color: #333; }
.ns-d { background: #ee8100; color: white; }
.ns-e { background: #e63e11; color: white; }

/* Calorie Circle */
.cal-circle-box {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.cal-circle {
    position: relative;
    width: 150px;
    height: 150px;
}

.cal-circle svg {
    transform: rotate(-90deg);
}

.cal-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 12; }
.cal-progress { fill: none; stroke: url(#calGrad); stroke-width: 12; stroke-linecap: round; }

.cal-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;
}

.cal-value {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #ff6b6b, #feca57);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.cal-label { color: #9ca3af; font-size: 0.8rem; }

/* Macro Cards */
.macro-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.macro-card {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
}

.macro-val { font-weight: 700; font-size: 1.1rem; color: white; }
.macro-name { font-size: 0.8rem; margin-top: 3px; }
.macro-name.protein { color: #10b981; }
.macro-name.carbs { color: #f59e0b; }
.macro-name.fat { color: #ef4444; }

/* Info boxes */
.ai-info-box {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 12px;
    color: white;
}

.ai-info-box h4 {
    font-size: 0.95rem;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.benefit-row, .risk-row {
    display: flex;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.benefit-row:last-child, .risk-row:last-child { border-bottom: none; }

.benefit-icon {
    width: 28px; height: 28px;
    background: rgba(34, 197, 94, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4ade80;
    flex-shrink: 0;
}

.risk-icon {
    width: 28px; height: 28px;
    background: rgba(239, 68, 68, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #f87171;
    flex-shrink: 0;
}

.storage-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.storage-item {
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
}

.storage-item .label { font-size: 0.75rem; color: #9ca3af; }
.storage-item .value { font-weight: 600; margin-top: 3px; }

/* Loading overlay */
.ai-loading {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.ai-loading.show { display: flex; }

.ai-spinner {
    width: 60px; height: 60px;
    border: 4px solid rgba(255,255,255,0.1);
    border-top-color: #4ade80;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.ai-loading p { color: white; font-size: 1.1rem; }

@media (max-width: 600px) {
    .scanner-hero h1 { font-size: 1.5rem; }
    .manual-input { flex-direction: column; }
    .health-scores { flex-direction: column; }
}
{% endblock %}

{% block content %}
<div class="scanner-container">
    <div class="scanner-hero">
        <h1><i class="fas fa-qrcode"></i> QR & Barcode Skaner</h1>
        <p>Mahsulot haqida to'liq ma'lumot: kaloriya, vitaminlar, allergenlar, zararlar</p>
    </div>
    
    <div class="mode-tabs">
        <button class="mode-tab active" onclick="switchMode('manual')">
            <i class="fas fa-keyboard"></i> Qo'lda kiritish
        </button>
        <button class="mode-tab" onclick="switchMode('barcode')">
            <i class="fas fa-barcode"></i> Shtrix kod
        </button>
        <button class="mode-tab" onclick="switchMode('camera')">
            <i class="fas fa-camera"></i> üì∑ Kamera
        </button>
    </div>
    
    <div id="manualSection" class="scanner-section">
        <div class="manual-input">
            <input type="text" id="barcodeInput" placeholder="Barcode raqamini kiriting..." 
                   onkeypress="if(event.key==='Enter') searchBarcode()">
            <button class="scan-btn" onclick="searchBarcode()">
                <i class="fas fa-search"></i> Qidirish
            </button>
        </div>
    </div>
    
    <div id="cameraSection" class="scanner-section" style="display: none;">
        <div id="reader"></div>
        <p style="text-align: center; margin-top: 15px; color: #6b7280;">
            <i class="fas fa-info-circle"></i> QR kod yoki barcode'ni kameraga ko'rsating
        </p>
    </div>
    
    <!-- AI Kamera rejimi -->
    <div id="aiCameraSection" class="scanner-section" style="display: none;">
        <div class="ai-camera-section">
            <video id="aiVideo" autoplay playsinline muted></video>
            <img id="capturedImg" class="captured-img" alt="Captured">
            <div class="camera-instruction" id="cameraInstruction">
                üì∑ Ovqatni kameraga ko'rsating
            </div>
            <div class="camera-controls">
                <button class="side-btn" onclick="openGallery()">üñºÔ∏è</button>
                <div id="captureControls">
                    <button class="capture-btn" onclick="capturePhoto()">
                        <div class="capture-btn-inner"></div>
                    </button>
                </div>
                <div id="actionControls" class="action-buttons">
                    <button class="retake-btn" onclick="retakePhoto()">‚Ü©Ô∏è Qayta</button>
                    <button class="analyze-btn" onclick="analyzePhoto()">üîç Tahlil</button>
                </div>
                <button class="side-btn" onclick="toggleFlash()">‚ö°</button>
            </div>
        </div>
        <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="handleGalleryImage(event)">
    </div>
    
    <!-- AI Natija Modal -->
    <div id="aiResultModal" class="ai-result-modal">
        <div class="ai-result-content">
            <div class="ai-result-header">
                <button class="close-ai-result" onclick="closeAiResult()">‚úï</button>
                <h2>üçé Tahlil natijasi</h2>
            </div>
            <div id="aiResultBody"></div>
        </div>
    </div>
    
    <!-- AI Loading -->
    <div id="aiLoading" class="ai-loading">
        <div class="ai-spinner"></div>
        <p>AI tahlil qilmoqda...</p>
    </div>
    
    <div id="loadingDiv" class="loading">
        <i class="fas fa-spinner"></i>
        <p>Qidirilmoqda...</p>
    </div>
    
    <div id="resultCard" class="result-card"></div>
</div>

<!-- Barcode/QR kutubxonalari -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://unpkg.com/@AustinZhu/barcoder@latest/dist/barcoder.min.js"></script>

<script>
let html5QrCode = null;
let currentMode = 'manual';
let aiStream = null;
let capturedImageData = null;

function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
    event.target.closest('.mode-tab').classList.add('active');
    
    // Barcha section'larni yashirish
    document.getElementById('manualSection').style.display = 'none';
    document.getElementById('cameraSection').style.display = 'none';
    document.getElementById('aiCameraSection').style.display = 'none';
    stopScanner();
    stopAiCamera();
    
    if (mode === 'manual') {
        document.getElementById('manualSection').style.display = 'block';
    } else if (mode === 'barcode') {
        document.getElementById('cameraSection').style.display = 'block';
        startScanner();
    } else if (mode === 'camera') {
        document.getElementById('aiCameraSection').style.display = 'block';
        startAiCamera();
    }
}

// ===== AI KAMERA FUNKSIYALARI =====
async function startAiCamera() {
    try {
        aiStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
            audio: false
        });
        document.getElementById('aiVideo').srcObject = aiStream;
    } catch (err) {
        console.error('Kamera xatosi:', err);
        document.getElementById('cameraInstruction').textContent = '‚ö†Ô∏è Kamera ruxsati kerak';
    }
}

function stopAiCamera() {
    if (aiStream) {
        aiStream.getTracks().forEach(track => track.stop());
        aiStream = null;
    }
}

function capturePhoto() {
    const video = document.getElementById('aiVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
    document.getElementById('capturedImg').src = capturedImageData;
    
    // UI o'zgartirish
    video.style.display = 'none';
    document.getElementById('capturedImg').style.display = 'block';
    document.getElementById('captureControls').style.display = 'none';
    document.getElementById('actionControls').style.display = 'flex';
    document.getElementById('cameraInstruction').textContent = 'üì∏ Rasm olindi';
}

function retakePhoto() {
    capturedImageData = null;
    document.getElementById('aiVideo').style.display = 'block';
    document.getElementById('capturedImg').style.display = 'none';
    document.getElementById('captureControls').style.display = 'block';
    document.getElementById('actionControls').style.display = 'none';
    document.getElementById('cameraInstruction').textContent = 'üì∑ Ovqatni kameraga ko\'rsating';
}

function openGallery() {
    document.getElementById('galleryInput').click();
}

function handleGalleryImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            capturedImageData = e.target.result;
            document.getElementById('capturedImg').src = capturedImageData;
            document.getElementById('aiVideo').style.display = 'none';
            document.getElementById('capturedImg').style.display = 'block';
            document.getElementById('captureControls').style.display = 'none';
            document.getElementById('actionControls').style.display = 'flex';
            document.getElementById('cameraInstruction').textContent = 'üì∏ Rasm tanlandi';
        };
        reader.readAsDataURL(file);
    }
}

async function analyzePhoto() {
    if (!capturedImageData) return;
    
    document.getElementById('aiLoading').classList.add('show');
    
    try {
        const formData = new FormData();
        const response = await fetch(capturedImageData);
        const blob = await response.blob();
        formData.append('image', blob, 'food.jpg');
        
        const result = await fetch('/api/analyze-food/', {
            method: 'POST',
            body: formData
        });
        
        const data = await result.json();
        document.getElementById('aiLoading').classList.remove('show');
        
        if (data.success) {
            showAiResult(data.data);
        } else {
            alert('Xatolik: ' + (data.error || 'Tahlil qilib bo\'lmadi'));
        }
    } catch (err) {
        document.getElementById('aiLoading').classList.remove('show');
        alert('Server bilan bog\'lanib bo\'lmadi');
    }
}

function showAiResult(data) {
    const n = data.nutrition_per_100g || {};
    const calories = Math.round(n.calories || 0);
    const proteins = parseFloat(n.proteins) || 0;
    const carbs = parseFloat(n.carbohydrates) || 0;
    const fat = parseFloat(n.fat) || 0;
    const sugars = parseFloat(n.sugars) || 0;
    const salt = parseFloat(n.salt) || 0;
    const fiber = parseFloat(n.fiber) || 0;
    
    const nutriscore = (data.nutriscore || 'C').toUpperCase();
    const dailyCal = Math.min(100, Math.round((calories / 2000) * 100));
    const circumference = 2 * Math.PI * 60;
    const offset = circumference - (dailyCal / 100) * circumference;
    
    // Benefits
    let benefitsHtml = '';
    if (data.health_benefits && data.health_benefits.length) {
        benefitsHtml = data.health_benefits.map(b => `
            <div class="benefit-row">
                <div class="benefit-icon">‚úì</div>
                <span>${b}</span>
            </div>
        `).join('');
    }
    
    // Risks
    let risksHtml = '';
    if (data.health_risks && data.health_risks.length) {
        risksHtml = data.health_risks.map(r => `
            <div class="risk-row">
                <div class="risk-icon">!</div>
                <span>${r}</span>
            </div>
        `).join('');
    }
    
    const storage = data.storage || {};
    
    document.getElementById('aiResultBody').innerHTML = `
        <div class="ai-product-card">
            <div class="ai-product-header">
                <img src="${capturedImageData}" class="ai-product-img" alt="">
                <div class="ai-product-info">
                    <h2>${data.name || 'Noma\'lum'}</h2>
                    ${data.category ? `<span class="category">${data.category}</span>` : ''}
                </div>
            </div>
            
            <div class="ns-bar">
                <div class="ns-letter ns-a ${nutriscore === 'A' ? 'active' : ''}">A</div>
                <div class="ns-letter ns-b ${nutriscore === 'B' ? 'active' : ''}">B</div>
                <div class="ns-letter ns-c ${nutriscore === 'C' ? 'active' : ''}">C</div>
                <div class="ns-letter ns-d ${nutriscore === 'D' ? 'active' : ''}">D</div>
                <div class="ns-letter ns-e ${nutriscore === 'E' ? 'active' : ''}">E</div>
            </div>
        </div>
        
        <div class="ai-info-box">
            <h4>üî• Kaloriya (100g)</h4>
            <div class="cal-circle-box">
                <div class="cal-circle">
                    <svg width="150" height="150">
                        <defs>
                            <linearGradient id="calGrad" x1="0%" y1="0%" x2="100%">
                                <stop offset="0%" stop-color="#ff6b6b"/>
                                <stop offset="100%" stop-color="#feca57"/>
                            </linearGradient>
                        </defs>
                        <circle class="cal-bg" cx="75" cy="75" r="60"/>
                        <circle class="cal-progress" cx="75" cy="75" r="60"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}"/>
                    </svg>
                    <div class="cal-text">
                        <div class="cal-value">${calories}</div>
                        <div class="cal-label">kkal</div>
                    </div>
                </div>
            </div>
            
            <div class="macro-row">
                <div class="macro-card">
                    <div class="macro-val">${proteins}g</div>
                    <div class="macro-name protein">Oqsil</div>
                </div>
                <div class="macro-card">
                    <div class="macro-val">${carbs}g</div>
                    <div class="macro-name carbs">Uglevod</div>
                </div>
                <div class="macro-card">
                    <div class="macro-val">${fat}g</div>
                    <div class="macro-name fat">Yog'</div>
                </div>
            </div>
        </div>
        
        <div class="ai-info-box">
            <h4>üìä Batafsil</h4>
            <div class="macro-row">
                <div class="macro-card">
                    <div class="macro-val">${sugars}g</div>
                    <div class="macro-name">üç¨ Shakar</div>
                </div>
                <div class="macro-card">
                    <div class="macro-val">${salt}g</div>
                    <div class="macro-name">üßÇ Tuz</div>
                </div>
                <div class="macro-card">
                    <div class="macro-val">${fiber}g</div>
                    <div class="macro-name">üåæ Tola</div>
                </div>
            </div>
        </div>
        
        ${benefitsHtml ? `
        <div class="ai-info-box">
            <h4>üíö Foydalari</h4>
            ${benefitsHtml}
        </div>
        ` : ''}
        
        ${risksHtml ? `
        <div class="ai-info-box">
            <h4>‚ö†Ô∏è Ogohlantirishlar</h4>
            ${risksHtml}
        </div>
        ` : ''}
        
        ${data.best_time_to_eat ? `
        <div class="ai-info-box">
            <h4>‚è∞ Qachon iste'mol qilish</h4>
            <p style="background: rgba(99,102,241,0.2); padding: 10px 15px; border-radius: 10px;">
                üïê ${data.best_time_to_eat}
            </p>
            ${data.who_should_avoid ? `<p style="color: #fca5a5; margin-top: 10px;">‚ö†Ô∏è ${data.who_should_avoid}</p>` : ''}
        </div>
        ` : ''}
        
        ${storage.method ? `
        <div class="ai-info-box">
            <h4>üì¶ Saqlash sharoitlari</h4>
            <div class="storage-grid">
                <div class="storage-item">
                    <div class="label">Usul</div>
                    <div class="value">${storage.method || '-'}</div>
                </div>
                <div class="storage-item">
                    <div class="label">Harorat</div>
                    <div class="value">${storage.temperature || '-'}</div>
                </div>
                <div class="storage-item">
                    <div class="label">Muddat</div>
                    <div class="value">${storage.duration || '-'}</div>
                </div>
                <div class="storage-item">
                    <div class="label">Maslahat</div>
                    <div class="value" style="font-size: 0.8rem;">${storage.tips || '-'}</div>
                </div>
            </div>
        </div>
        ` : ''}
        
        ${data.serving_suggestion ? `
        <div class="ai-info-box">
            <h4>üçΩÔ∏è Iste'mol tavsiyasi</h4>
            <p>${data.serving_suggestion}</p>
        </div>
        ` : ''}
    `;
    
    document.getElementById('aiResultModal').classList.add('show');
}

function closeAiResult() {
    document.getElementById('aiResultModal').classList.remove('show');
    retakePhoto();
}

function toggleFlash() {
    // Flash toggle (agar mavjud bo'lsa)
    if (aiStream) {
        const track = aiStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        if (capabilities.torch) {
            const settings = track.getSettings();
            track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
        }
    }
}

// ===== BARCODE SCANNER =====
let scannerVideo = null;
let scannerStream = null;
let barcodeDetector = null;
let scanInterval = null;

async function startScanner() {
    const readerDiv = document.getElementById('reader');
    
    // BarcodeDetector API mavjudligini tekshirish
    if ('BarcodeDetector' in window) {
        try {
            barcodeDetector = new BarcodeDetector({
                formats: ['qr_code', 'ean_13', 'ean_8', 'code_128', 'code_39', 'upc_a', 'upc_e']
            });
        } catch (e) {
            console.log('BarcodeDetector xatosi:', e);
        }
    }
    
    // Kamera uchun video element yaratish
    readerDiv.innerHTML = `
        <div style="position: relative;">
            <video id="scannerVideo" autoplay playsinline muted style="width: 100%; border-radius: 15px;"></video>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        width: 250px; height: 250px; border: 3px solid #4ade80; border-radius: 15px;
                        box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
            <div id="scanStatus" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
                        background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px;">
                üì∑ Skanerlash...
            </div>
        </div>
    `;
    
    scannerVideo = document.getElementById('scannerVideo');
    
    try {
        scannerStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        scannerVideo.srcObject = scannerStream;
        
        // Skanerlash boshlash
        scannerVideo.onloadedmetadata = () => {
            startBarcodeDetection();
        };
    } catch (err) {
        console.error('Kamera xatosi:', err);
        readerDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <i class="fas fa-camera-slash" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <h3>Kamera ruxsati berilmagan</h3>
                <p>Iltimos, brauzer sozlamalaridan kamera ruxsatini bering</p>
            </div>
        `;
    }
}

function startBarcodeDetection() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    scanInterval = setInterval(async () => {
        if (!scannerVideo || scannerVideo.paused) return;
        
        canvas.width = scannerVideo.videoWidth;
        canvas.height = scannerVideo.videoHeight;
        ctx.drawImage(scannerVideo, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        try {
            // 1. BarcodeDetector API bilan (Chrome, Edge)
            if (barcodeDetector) {
                const barcodes = await barcodeDetector.detect(canvas);
                if (barcodes.length > 0) {
                    const code = barcodes[0].rawValue;
                    document.getElementById('scanStatus').textContent = '‚úì Topildi: ' + code;
                    handleScanResult(code);
                    return;
                }
            }
            
            // 2. jsQR bilan QR kod o'qish (barcha brauzerlar)
            if (typeof jsQR !== 'undefined') {
                const qrCode = jsQR(imageData.data, canvas.width, canvas.height);
                if (qrCode) {
                    document.getElementById('scanStatus').textContent = '‚úì QR: ' + qrCode.data;
                    handleScanResult(qrCode.data);
                    return;
                }
            }
            
            // 3. Shtrix kod uchun - raqamlarni tekshirish
            // EAN-13, UPC-A formatlar uchun oddiy tekshirish
            
        } catch (err) {
            // Xato bo'lsa davom etish
            console.log('Scan error:', err);
        }
    }, 150); // Tezroq skanerlash
}

function stopScanner() {
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    if (scannerStream) {
        scannerStream.getTracks().forEach(track => track.stop());
        scannerStream = null;
    }
    if (html5QrCode) {
        try {
            html5QrCode.stop().catch(err => console.log(err));
        } catch (e) {}
    }
}

function handleScanResult(code) {
    stopScanner();
    
    if (code.startsWith('http://') || code.startsWith('https://')) {
        showQRResult('url', code);
    } else if (code.startsWith('mailto:')) {
        showQRResult('email', code);
    } else if (code.startsWith('tel:')) {
        showQRResult('phone', code);
    } else if (code.startsWith('WIFI:')) {
        showQRResult('wifi', code);
    } else if (/^\d{8,14}$/.test(code)) {
        document.getElementById('barcodeInput').value = code;
        searchBarcode();
    } else {
        showQRResult('text', code);
    }
}

function showQRResult(type, content) {
    let html = '<div class="qr-result">';
    
    switch(type) {
        case 'url':
            html += `<h3><i class="fas fa-link"></i> Havola topildi</h3>
                <div class="qr-content">${content}</div>
                <a href="${content}" target="_blank" class="action-btn">
                    <i class="fas fa-external-link-alt"></i> Havolani ochish
                </a>`;
            break;
        case 'email':
            html += `<h3><i class="fas fa-envelope"></i> Email topildi</h3>
                <div class="qr-content">${content.replace('mailto:', '')}</div>
                <a href="${content}" class="action-btn">
                    <i class="fas fa-paper-plane"></i> Xat yuborish
                </a>`;
            break;
        case 'phone':
            html += `<h3><i class="fas fa-phone"></i> Telefon raqami</h3>
                <div class="qr-content">${content.replace('tel:', '')}</div>
                <a href="${content}" class="action-btn">
                    <i class="fas fa-phone-alt"></i> Qo'ng'iroq qilish
                </a>`;
            break;
        case 'wifi':
            html += `<h3><i class="fas fa-wifi"></i> WiFi ma'lumotlari</h3>
                <div class="qr-content">${content}</div>`;
            break;
        default:
            html += `<h3><i class="fas fa-qrcode"></i> QR kod ma'lumoti</h3>
                <div class="qr-content">${content}</div>
                <button onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')" class="action-btn">
                    <i class="fas fa-copy"></i> Nusxalash
                </button>`;
    }
    
    html += '</div>';
    document.getElementById('resultCard').innerHTML = html;
    document.getElementById('resultCard').style.display = 'block';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert('Nusxalandi!'));
}

function searchBarcode() {
    const barcode = document.getElementById('barcodeInput').value.trim();
    if (!barcode) {
        alert('Iltimos, barcode kiriting');
        return;
    }
    
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('resultCard').style.display = 'none';
    
    fetch('/api/barcode/lookup/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ barcode: barcode })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingDiv').style.display = 'none';
        
        if (data.success && data.found) {
            showProductResult(data.product, data.source);
        } else {
            showNotFound(barcode);
        }
    })
    .catch(error => {
        document.getElementById('loadingDiv').style.display = 'none';
        alert('Xatolik yuz berdi');
    });
}

function showProductResult(product, source) {
    let html = `
        <div class="result-header">
            ${product.image_url ? `<img src="${product.image_url}" class="product-image" onerror="this.style.display='none'">` : '<i class="fas fa-box" style="font-size:3rem;"></i>'}
            <div class="product-title">
                <h2>${product.name || 'Nomsiz mahsulot'}</h2>
                <p>${product.brand || ''} ${product.weight ? '‚Ä¢ ' + product.weight : ''}</p>
            </div>
        </div>
        <div class="result-body">
    `;
    
    // Sog'liq ko'rsatkichlari
    if (product.nutriscore_grade || product.nova_group) {
        html += '<div class="health-scores">';
        if (product.nutriscore_grade) {
            const grade = product.nutriscore_grade.toLowerCase();
            html += `<div class="score-badge nutri-${grade}">
                <span>Nutri-Score</span> <strong>${product.nutriscore_grade}</strong>
            </div>`;
        }
        if (product.nova_group) {
            html += `<div class="score-badge nova-${product.nova_group}">
                <span>NOVA</span> <strong>${product.nova_group}</strong>
            </div>`;
        }
        html += '</div>';
    }
    
    // Ogohlantirishlar
    if (product.warnings) {
        html += `<div class="warnings-box">
            <h4><i class="fas fa-exclamation-triangle"></i> Ogohlantirishlar</h4>
            ${product.warnings.split('\n').map(w => `<p>${w}</p>`).join('')}
        </div>`;
    }
    
    // Allergenlar
    if (product.allergens) {
        html += `<div class="allergens-box">
            <h4><i class="fas fa-allergies"></i> Allergenlar</h4>
            <p>${product.allergens}</p>
        </div>`;
    }
    
    // Ozuqaviy qiymatlar
    if (product.calories || product.proteins || product.carbohydrates || product.fat) {
        html += `<div class="info-section">
            <h3><i class="fas fa-fire"></i> Ozuqaviy qiymatlar (100g uchun)</h3>
            <table class="nutrition-table">`;
        
        if (product.calories) html += `<tr class="highlight"><td>üî• Kaloriya</td><td>${product.calories} kcal</td></tr>`;
        if (product.proteins) html += `<tr><td>ü•© Oqsillar</td><td>${product.proteins}g</td></tr>`;
        if (product.carbohydrates) html += `<tr><td>üçû Uglevodlar</td><td>${product.carbohydrates}g</td></tr>`;
        if (product.sugars) {
            const cls = product.sugars > 22.5 ? 'highlight' : '';
            html += `<tr class="${cls}"><td>üç¨ Shakar</td><td>${product.sugars}g</td></tr>`;
        }
        if (product.fat) html += `<tr><td>üßà Yog'</td><td>${product.fat}g</td></tr>`;
        if (product.saturated_fat) {
            const cls = product.saturated_fat > 5 ? 'highlight' : '';
            html += `<tr class="${cls}"><td>‚Ä¢ To'yingan yog'</td><td>${product.saturated_fat}g</td></tr>`;
        }
        if (product.fiber) html += `<tr><td>üåæ Kletchatka</td><td>${product.fiber}g</td></tr>`;
        if (product.salt) {
            const cls = product.salt > 1.5 ? 'highlight' : '';
            html += `<tr class="${cls}"><td>üßÇ Tuz</td><td>${product.salt}g</td></tr>`;
        }
        
        html += '</table></div>';
    }
    
    // Vitaminlar
    const vitamins = [];
    if (product.vitamin_a) vitamins.push({name: 'Vitamin A', value: product.vitamin_a + ' ¬µg'});
    if (product.vitamin_c) vitamins.push({name: 'Vitamin C', value: product.vitamin_c + ' mg'});
    if (product.vitamin_d) vitamins.push({name: 'Vitamin D', value: product.vitamin_d + ' ¬µg'});
    if (product.vitamin_e) vitamins.push({name: 'Vitamin E', value: product.vitamin_e + ' mg'});
    if (product.vitamin_b1) vitamins.push({name: 'Vitamin B1', value: product.vitamin_b1 + ' mg'});
    if (product.vitamin_b2) vitamins.push({name: 'Vitamin B2', value: product.vitamin_b2 + ' mg'});
    if (product.vitamin_b6) vitamins.push({name: 'Vitamin B6', value: product.vitamin_b6 + ' mg'});
    if (product.vitamin_b12) vitamins.push({name: 'Vitamin B12', value: product.vitamin_b12 + ' ¬µg'});
    if (product.calcium) vitamins.push({name: 'Kaltsiy', value: product.calcium + ' mg'});
    if (product.iron) vitamins.push({name: 'Temir', value: product.iron + ' mg'});
    if (product.magnesium) vitamins.push({name: 'Magniy', value: product.magnesium + ' mg'});
    if (product.zinc) vitamins.push({name: 'Sink', value: product.zinc + ' mg'});
    if (product.potassium) vitamins.push({name: 'Kaliy', value: product.potassium + ' mg'});
    
    if (vitamins.length > 0) {
        html += `<div class="info-section">
            <h3><i class="fas fa-pills"></i> Vitaminlar va minerallar</h3>
            <div class="vitamins-grid">
                ${vitamins.map(v => `<div class="vitamin-item">
                    <div class="name">${v.name}</div>
                    <div class="value">${v.value}</div>
                </div>`).join('')}
            </div>
        </div>`;
    }
    
    // Tarkibi
    if (product.ingredients) {
        html += `<div class="info-section">
            <h3><i class="fas fa-list"></i> Tarkibi</h3>
            <div class="ingredients-text">${product.ingredients}</div>
        </div>`;
    }
    
    // Qo'shimchalar
    if (product.additives) {
        html += `<div class="additives-box">
            <h4><i class="fas fa-flask"></i> Qo'shimchalar (E raqamlar)</h4>
            <p>${product.additives}</p>
        </div>`;
    }
    
    // Qo'shimcha ma'lumotlar
    html += `<div class="info-section" style="margin-top: 20px;">
        <h3><i class="fas fa-info-circle"></i> Qo'shimcha ma'lumotlar</h3>
        <table class="nutrition-table">
            <tr><td>Barcode</td><td>${product.barcode}</td></tr>
            ${product.category ? `<tr><td>Kategoriya</td><td>${product.category}</td></tr>` : ''}
            ${product.country ? `<tr><td>Mamlakat</td><td>${product.country}</td></tr>` : ''}
            ${product.scan_count ? `<tr><td>Skanerlangan</td><td>${product.scan_count} marta</td></tr>` : ''}
        </table>
    </div></div>`;
    
    document.getElementById('resultCard').innerHTML = html;
    document.getElementById('resultCard').style.display = 'block';
}

function showNotFound(barcode) {
    document.getElementById('resultCard').innerHTML = `
        <div class="result-header error">
            <i class="fas fa-times-circle" style="font-size: 2.5rem;"></i>
            <div class="product-title">
                <h2>Mahsulot topilmadi</h2>
                <p>Barcode: ${barcode}</p>
            </div>
        </div>
        <div class="result-body">
            <div class="not-found">
                <i class="fas fa-box-open"></i>
                <h3>Bu mahsulot bazada mavjud emas</h3>
                <p style="color: #9ca3af; margin-bottom: 20px;">
                    Open Food Facts bazasida ham topilmadi.
                </p>
                <button class="scan-btn" onclick="addNewProduct('${barcode}')">
                    <i class="fas fa-plus"></i> Mahsulot qo'shish
                </button>
            </div>
        </div>`;
    document.getElementById('resultCard').style.display = 'block';
}

function addNewProduct(barcode) {
    const name = prompt('Mahsulot nomini kiriting:');
    if (!name) return;
    
    fetch('/api/barcode/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ barcode: barcode, name: name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Mahsulot qo\'shildi!');
            searchBarcode();
        } else {
            alert('Xatolik: ' + (data.error || 'Noma\'lum'));
        }
    });
}
</script>
{% endblock %}
