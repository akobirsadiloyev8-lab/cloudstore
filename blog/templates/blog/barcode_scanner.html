{% extends 'blog/boshlash.html' %}
{% load static %}

{% block title %}QR & Barcode Skaner - Cloudstore AI{% endblock %}

{% block extra_styles %}
.scanner-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.scanner-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    color: white;
    margin-bottom: 25px;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
}

.scanner-hero h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.scanner-hero p {
    opacity: 0.9;
    font-size: 1rem;
}

.mode-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 8px;
}

.mode-tab {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    background: transparent;
    color: #666;
}

.mode-tab.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

.mode-tab:hover:not(.active) {
    background: rgba(102, 126, 234, 0.1);
}

.scanner-section {
    background: white;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.manual-input {
    display: flex;
    gap: 10px;
}

.manual-input input {
    flex: 1;
    padding: 15px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 1.1rem;
    transition: all 0.3s;
}

.manual-input input:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.scan-btn {
    padding: 15px 30px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.scan-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

#reader {
    width: 100%;
    border-radius: 15px;
    overflow: hidden;
}

#reader video {
    border-radius: 15px;
}

.result-card {
    display: none;
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    animation: slideUp 0.5s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-header {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.result-header.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.result-header.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.product-image {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    object-fit: cover;
    background: white;
}

.product-title {
    flex: 1;
}

.product-title h2 {
    font-size: 1.3rem;
    margin-bottom: 5px;
}

.product-title p {
    opacity: 0.9;
    font-size: 0.9rem;
}

.result-body {
    padding: 25px;
}

.health-scores {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.score-badge {
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nutri-a { background: #22c55e; color: white; }
.nutri-b { background: #84cc16; color: white; }
.nutri-c { background: #fbbf24; color: #333; }
.nutri-d { background: #f97316; color: white; }
.nutri-e { background: #ef4444; color: white; }

.nova-1 { background: #22c55e; color: white; }
.nova-2 { background: #84cc16; color: white; }
.nova-3 { background: #fbbf24; color: #333; }
.nova-4 { background: #ef4444; color: white; }

.warnings-box {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 2px solid #f59e0b;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
}

.warnings-box h4 {
    color: #92400e;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.warnings-box p {
    color: #78350f;
    font-size: 0.95rem;
    margin: 5px 0;
}

.info-section {
    margin-bottom: 20px;
}

.info-section h3 {
    font-size: 1.1rem;
    color: #374151;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}

.info-section h3 i {
    color: #667eea;
}

.nutrition-table {
    width: 100%;
    border-collapse: collapse;
}

.nutrition-table tr {
    border-bottom: 1px solid #f3f4f6;
}

.nutrition-table tr:last-child {
    border-bottom: none;
}

.nutrition-table td {
    padding: 10px 5px;
}

.nutrition-table td:first-child {
    color: #6b7280;
}

.nutrition-table td:last-child {
    text-align: right;
    font-weight: 600;
    color: #374151;
}

.nutrition-table .highlight {
    background: #fef3c7;
}

.nutrition-table .highlight td {
    color: #92400e;
}

.vitamins-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
}

.vitamin-item {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    padding: 12px;
    border-radius: 10px;
    text-align: center;
}

.vitamin-item .name {
    font-size: 0.85rem;
    color: #0369a1;
    margin-bottom: 5px;
}

.vitamin-item .value {
    font-weight: 700;
    color: #0c4a6e;
}

.ingredients-text {
    background: #f9fafb;
    padding: 15px;
    border-radius: 12px;
    line-height: 1.6;
    color: #4b5563;
    font-size: 0.95rem;
}

.allergens-box {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    border: 2px solid #ef4444;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}

.allergens-box h4 {
    color: #991b1b;
    margin-bottom: 8px;
}

.allergens-box p {
    color: #7f1d1d;
}

.additives-box {
    background: linear-gradient(135deg, #fef9c3, #fef08a);
    border: 2px solid #eab308;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.additives-box h4 {
    color: #713f12;
    margin-bottom: 8px;
}

.additives-box p {
    color: #78350f;
    font-size: 0.9rem;
}

.qr-result {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
}

.qr-result h3 {
    color: #0369a1;
    margin-bottom: 15px;
}

.qr-result .qr-content {
    background: white;
    padding: 15px;
    border-radius: 10px;
    word-break: break-all;
    margin-bottom: 15px;
}

.qr-result .action-btn {
    padding: 12px 25px;
    background: linear-gradient(135deg, #0ea5e9, #0284c7);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.not-found {
    text-align: center;
    padding: 30px;
}

.not-found i {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 15px;
}

.not-found h3 {
    color: #6b7280;
    margin-bottom: 10px;
}

.loading {
    display: none;
    text-align: center;
    padding: 40px;
}

.loading i {
    font-size: 3rem;
    color: #667eea;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@media (max-width: 600px) {
    .scanner-hero h1 { font-size: 1.5rem; }
    .manual-input { flex-direction: column; }
    .health-scores { flex-direction: column; }
}
{% endblock %}

{% block content %}
<div class="scanner-container">
    <div class="scanner-hero">
        <h1><i class="fas fa-qrcode"></i> QR & Barcode Skaner</h1>
        <p>Mahsulot haqida to'liq ma'lumot: kaloriya, vitaminlar, allergenlar, zararlar</p>
    </div>
    
    <div class="mode-tabs">
        <button class="mode-tab active" onclick="switchMode('manual')">
            <i class="fas fa-keyboard"></i> Qo'lda kiritish
        </button>
        <button class="mode-tab" onclick="switchMode('camera')">
            <i class="fas fa-camera"></i> Kamera
        </button>
    </div>
    
    <div id="manualSection" class="scanner-section">
        <div class="manual-input">
            <input type="text" id="barcodeInput" placeholder="Barcode raqamini kiriting..." 
                   onkeypress="if(event.key==='Enter') searchBarcode()">
            <button class="scan-btn" onclick="searchBarcode()">
                <i class="fas fa-search"></i> Qidirish
            </button>
        </div>
    </div>
    
    <div id="cameraSection" class="scanner-section" style="display: none;">
        <div id="reader"></div>
        <p style="text-align: center; margin-top: 15px; color: #6b7280;">
            <i class="fas fa-info-circle"></i> QR kod yoki barcode'ni kameraga ko'rsating
        </p>
    </div>
    
    <div id="loadingDiv" class="loading">
        <i class="fas fa-spinner"></i>
        <p>Qidirilmoqda...</p>
    </div>
    
    <div id="resultCard" class="result-card"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
let html5QrCode = null;
let currentMode = 'manual';

function switchMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
    event.target.closest('.mode-tab').classList.add('active');
    
    if (mode === 'manual') {
        document.getElementById('manualSection').style.display = 'block';
        document.getElementById('cameraSection').style.display = 'none';
        stopScanner();
    } else {
        document.getElementById('manualSection').style.display = 'none';
        document.getElementById('cameraSection').style.display = 'block';
        startScanner();
    }
}

function startScanner() {
    if (html5QrCode) {
        html5QrCode.clear();
    }
    
    html5QrCode = new Html5Qrcode("reader");
    
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
            handleScanResult(decodedText);
        },
        (errorMessage) => {}
    ).catch((err) => {
        console.error("Kamera xatosi:", err);
        alert("Kameraga kirish imkoni yo'q. Iltimos, ruxsat bering.");
    });
}

function stopScanner() {
    if (html5QrCode) {
        html5QrCode.stop().catch(err => console.log(err));
    }
}

function handleScanResult(code) {
    stopScanner();
    
    if (code.startsWith('http://') || code.startsWith('https://')) {
        showQRResult('url', code);
    } else if (code.startsWith('mailto:')) {
        showQRResult('email', code);
    } else if (code.startsWith('tel:')) {
        showQRResult('phone', code);
    } else if (code.startsWith('WIFI:')) {
        showQRResult('wifi', code);
    } else if (/^\d{8,14}$/.test(code)) {
        document.getElementById('barcodeInput').value = code;
        searchBarcode();
    } else {
        showQRResult('text', code);
    }
}

function showQRResult(type, content) {
    let html = '<div class="qr-result">';
    
    switch(type) {
        case 'url':
            html += `<h3><i class="fas fa-link"></i> Havola topildi</h3>
                <div class="qr-content">${content}</div>
                <a href="${content}" target="_blank" class="action-btn">
                    <i class="fas fa-external-link-alt"></i> Havolani ochish
                </a>`;
            break;
        case 'email':
            html += `<h3><i class="fas fa-envelope"></i> Email topildi</h3>
                <div class="qr-content">${content.replace('mailto:', '')}</div>
                <a href="${content}" class="action-btn">
                    <i class="fas fa-paper-plane"></i> Xat yuborish
                </a>`;
            break;
        case 'phone':
            html += `<h3><i class="fas fa-phone"></i> Telefon raqami</h3>
                <div class="qr-content">${content.replace('tel:', '')}</div>
                <a href="${content}" class="action-btn">
                    <i class="fas fa-phone-alt"></i> Qo'ng'iroq qilish
                </a>`;
            break;
        case 'wifi':
            html += `<h3><i class="fas fa-wifi"></i> WiFi ma'lumotlari</h3>
                <div class="qr-content">${content}</div>`;
            break;
        default:
            html += `<h3><i class="fas fa-qrcode"></i> QR kod ma'lumoti</h3>
                <div class="qr-content">${content}</div>
                <button onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')" class="action-btn">
                    <i class="fas fa-copy"></i> Nusxalash
                </button>`;
    }
    
    html += '</div>';
    document.getElementById('resultCard').innerHTML = html;
    document.getElementById('resultCard').style.display = 'block';
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert('Nusxalandi!'));
}

function searchBarcode() {
    const barcode = document.getElementById('barcodeInput').value.trim();
    if (!barcode) {
        alert('Iltimos, barcode kiriting');
        return;
    }
    
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('resultCard').style.display = 'none';
    
    fetch('/api/barcode/lookup/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ barcode: barcode })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingDiv').style.display = 'none';
        
        if (data.success && data.found) {
            showProductResult(data.product, data.source);
        } else {
            showNotFound(barcode);
        }
    })
    .catch(error => {
        document.getElementById('loadingDiv').style.display = 'none';
        alert('Xatolik yuz berdi');
    });
}

function showProductResult(product, source) {
    let html = `
        <div class="result-header">
            ${product.image_url ? `<img src="${product.image_url}" class="product-image" onerror="this.style.display='none'">` : '<i class="fas fa-box" style="font-size:3rem;"></i>'}
            <div class="product-title">
                <h2>${product.name || 'Nomsiz mahsulot'}</h2>
                <p>${product.brand || ''} ${product.weight ? '‚Ä¢ ' + product.weight : ''}</p>
            </div>
        </div>
        <div class="result-body">
    `;
    
    // Sog'liq ko'rsatkichlari
    if (product.nutriscore_grade || product.nova_group) {
        html += '<div class="health-scores">';
        if (product.nutriscore_grade) {
            const grade = product.nutriscore_grade.toLowerCase();
            html += `<div class="score-badge nutri-${grade}">
                <span>Nutri-Score</span> <strong>${product.nutriscore_grade}</strong>
            </div>`;
        }
        if (product.nova_group) {
            html += `<div class="score-badge nova-${product.nova_group}">
                <span>NOVA</span> <strong>${product.nova_group}</strong>
            </div>`;
        }
        html += '</div>';
    }
    
    // Ogohlantirishlar
    if (product.warnings) {
        html += `<div class="warnings-box">
            <h4><i class="fas fa-exclamation-triangle"></i> Ogohlantirishlar</h4>
            ${product.warnings.split('\n').map(w => `<p>${w}</p>`).join('')}
        </div>`;
    }
    
    // Allergenlar
    if (product.allergens) {
        html += `<div class="allergens-box">
            <h4><i class="fas fa-allergies"></i> Allergenlar</h4>
            <p>${product.allergens}</p>
        </div>`;
    }
    
    // Ozuqaviy qiymatlar
    if (product.calories || product.proteins || product.carbohydrates || product.fat) {
        html += `<div class="info-section">
            <h3><i class="fas fa-fire"></i> Ozuqaviy qiymatlar (100g uchun)</h3>
            <table class="nutrition-table">`;
        
        if (product.calories) html += `<tr class="highlight"><td>üî• Kaloriya</td><td>${product.calories} kcal</td></tr>`;
        if (product.proteins) html += `<tr><td>ü•© Oqsillar</td><td>${product.proteins}g</td></tr>`;
        if (product.carbohydrates) html += `<tr><td>üçû Uglevodlar</td><td>${product.carbohydrates}g</td></tr>`;
        if (product.sugars) {
            const cls = product.sugars > 22.5 ? 'highlight' : '';
            html += `<tr class="${cls}"><td>üç¨ Shakar</td><td>${product.sugars}g</td></tr>`;
        }
        if (product.fat) html += `<tr><td>üßà Yog'</td><td>${product.fat}g</td></tr>`;
        if (product.saturated_fat) {
            const cls = product.saturated_fat > 5 ? 'highlight' : '';
            html += `<tr class="${cls}"><td>‚Ä¢ To'yingan yog'</td><td>${product.saturated_fat}g</td></tr>`;
        }
        if (product.fiber) html += `<tr><td>üåæ Kletchatka</td><td>${product.fiber}g</td></tr>`;
        if (product.salt) {
            const cls = product.salt > 1.5 ? 'highlight' : '';
            html += `<tr class="${cls}"><td>üßÇ Tuz</td><td>${product.salt}g</td></tr>`;
        }
        
        html += '</table></div>';
    }
    
    // Vitaminlar
    const vitamins = [];
    if (product.vitamin_a) vitamins.push({name: 'Vitamin A', value: product.vitamin_a + ' ¬µg'});
    if (product.vitamin_c) vitamins.push({name: 'Vitamin C', value: product.vitamin_c + ' mg'});
    if (product.vitamin_d) vitamins.push({name: 'Vitamin D', value: product.vitamin_d + ' ¬µg'});
    if (product.vitamin_e) vitamins.push({name: 'Vitamin E', value: product.vitamin_e + ' mg'});
    if (product.vitamin_b1) vitamins.push({name: 'Vitamin B1', value: product.vitamin_b1 + ' mg'});
    if (product.vitamin_b2) vitamins.push({name: 'Vitamin B2', value: product.vitamin_b2 + ' mg'});
    if (product.vitamin_b6) vitamins.push({name: 'Vitamin B6', value: product.vitamin_b6 + ' mg'});
    if (product.vitamin_b12) vitamins.push({name: 'Vitamin B12', value: product.vitamin_b12 + ' ¬µg'});
    if (product.calcium) vitamins.push({name: 'Kaltsiy', value: product.calcium + ' mg'});
    if (product.iron) vitamins.push({name: 'Temir', value: product.iron + ' mg'});
    if (product.magnesium) vitamins.push({name: 'Magniy', value: product.magnesium + ' mg'});
    if (product.zinc) vitamins.push({name: 'Sink', value: product.zinc + ' mg'});
    if (product.potassium) vitamins.push({name: 'Kaliy', value: product.potassium + ' mg'});
    
    if (vitamins.length > 0) {
        html += `<div class="info-section">
            <h3><i class="fas fa-pills"></i> Vitaminlar va minerallar</h3>
            <div class="vitamins-grid">
                ${vitamins.map(v => `<div class="vitamin-item">
                    <div class="name">${v.name}</div>
                    <div class="value">${v.value}</div>
                </div>`).join('')}
            </div>
        </div>`;
    }
    
    // Tarkibi
    if (product.ingredients) {
        html += `<div class="info-section">
            <h3><i class="fas fa-list"></i> Tarkibi</h3>
            <div class="ingredients-text">${product.ingredients}</div>
        </div>`;
    }
    
    // Qo'shimchalar
    if (product.additives) {
        html += `<div class="additives-box">
            <h4><i class="fas fa-flask"></i> Qo'shimchalar (E raqamlar)</h4>
            <p>${product.additives}</p>
        </div>`;
    }
    
    // Qo'shimcha ma'lumotlar
    html += `<div class="info-section" style="margin-top: 20px;">
        <h3><i class="fas fa-info-circle"></i> Qo'shimcha ma'lumotlar</h3>
        <table class="nutrition-table">
            <tr><td>Barcode</td><td>${product.barcode}</td></tr>
            ${product.category ? `<tr><td>Kategoriya</td><td>${product.category}</td></tr>` : ''}
            ${product.country ? `<tr><td>Mamlakat</td><td>${product.country}</td></tr>` : ''}
            ${product.scan_count ? `<tr><td>Skanerlangan</td><td>${product.scan_count} marta</td></tr>` : ''}
        </table>
    </div></div>`;
    
    document.getElementById('resultCard').innerHTML = html;
    document.getElementById('resultCard').style.display = 'block';
}

function showNotFound(barcode) {
    document.getElementById('resultCard').innerHTML = `
        <div class="result-header error">
            <i class="fas fa-times-circle" style="font-size: 2.5rem;"></i>
            <div class="product-title">
                <h2>Mahsulot topilmadi</h2>
                <p>Barcode: ${barcode}</p>
            </div>
        </div>
        <div class="result-body">
            <div class="not-found">
                <i class="fas fa-box-open"></i>
                <h3>Bu mahsulot bazada mavjud emas</h3>
                <p style="color: #9ca3af; margin-bottom: 20px;">
                    Open Food Facts bazasida ham topilmadi.
                </p>
                <button class="scan-btn" onclick="addNewProduct('${barcode}')">
                    <i class="fas fa-plus"></i> Mahsulot qo'shish
                </button>
            </div>
        </div>`;
    document.getElementById('resultCard').style.display = 'block';
}

function addNewProduct(barcode) {
    const name = prompt('Mahsulot nomini kiriting:');
    if (!name) return;
    
    fetch('/api/barcode/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ barcode: barcode, name: name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Mahsulot qo\'shildi!');
            searchBarcode();
        } else {
            alert('Xatolik: ' + (data.error || 'Noma\'lum'));
        }
    });
}
</script>
{% endblock %}
