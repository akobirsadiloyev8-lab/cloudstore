{% extends 'blog/boshlash.html' %}
{% load static %}

{% block title %}Barcha Kitoblar{% endblock %}

{% block head %}
<style>
    :root {
        --amz-orange: #ff9900;
        --amz-orange-hover: #ffad33;
        --amz-dark: #131921;
        --amz-light-dark: #232f3e;
        --amz-text: #0f1111;
        --amz-link: #007185;
        --amz-link-hover: #c7511f;
        --amz-border: #ddd;
        --amz-bg: #eaeded;
        --amz-card: #fff;
        --amz-star: #de7921;
    }

    body.dark-mode {
        --amz-text: #e0e0e0;
        --amz-bg: #0f1111;
        --amz-card: #1a1a1a;
        --amz-border: #333;
        --amz-link: #4fc3f7;
    }
    
    .amz-page-wrapper {
        background: var(--amz-bg);
        min-height: 100vh;
        padding-top: 0;
    }

    /* Top Navigation Bar */
    .amz-top-nav {
        background: var(--amz-light-dark);
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 0;
    }

    .amz-nav-item {
        color: #fff;
        text-decoration: none;
        padding: 8px 15px;
        font-size: 0.9rem;
        border-radius: 3px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .amz-nav-item:hover {
        border-color: #fff;
    }

    .amz-nav-item.active {
        background: var(--amz-orange);
        color: #000;
        font-weight: 600;
    }

    /* Main Container */
    .amz-container {
        max-width: 1500px;
        margin: 0 auto;
        display: flex;
        gap: 20px;
        padding: 20px;
    }

    /* Sidebar */
    .amz-sidebar {
        width: 250px;
        flex-shrink: 0;
    }

    .amz-sidebar-section {
        background: var(--amz-card);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid var(--amz-border);
    }

    .amz-sidebar-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--amz-text);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--amz-border);
    }

    .amz-filter-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .amz-filter-list li {
        margin-bottom: 6px;
    }

    .amz-filter-list a {
        color: var(--amz-link);
        text-decoration: none;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 0;
        transition: color 0.2s;
    }

    .amz-filter-list a:hover {
        color: var(--amz-link-hover);
        text-decoration: underline;
    }

    .amz-filter-list a.active {
        color: var(--amz-link-hover);
        font-weight: 600;
    }

    .amz-filter-list img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
    }

    .amz-avatar-sm {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--amz-light-dark);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* Main Content */
    .amz-main {
        flex: 1;
        min-width: 0;
    }

    /* Search Bar */
    .amz-search-bar {
        background: var(--amz-card);
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--amz-border);
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .amz-search-input {
        flex: 1;
        display: flex;
        border-radius: 4px;
        overflow: hidden;
        border: 2px solid var(--amz-orange);
    }

    .amz-search-input input {
        flex: 1;
        padding: 10px 15px;
        border: none;
        font-size: 0.95rem;
        outline: none;
        background: var(--amz-card);
        color: var(--amz-text);
    }

    .amz-search-input button {
        background: var(--amz-orange);
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .amz-search-input button:hover {
        background: var(--amz-orange-hover);
    }

    .amz-search-input button i {
        color: #000;
        font-size: 1.1rem;
    }

    /* Results Header */
    .amz-results-header {
        background: var(--amz-card);
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--amz-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .amz-results-info {
        font-size: 0.9rem;
        color: var(--amz-text);
    }

    .amz-results-info strong {
        color: var(--amz-link-hover);
    }

    .amz-view-options {
        display: flex;
        gap: 8px;
    }

    .amz-view-btn {
        background: none;
        border: 1px solid var(--amz-border);
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        color: var(--amz-text);
        transition: all 0.2s;
    }

    .amz-view-btn:hover, .amz-view-btn.active {
        background: var(--amz-light-dark);
        color: #fff;
    }

    /* Books Grid */
    .amz-books-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
    }

    .amz-book-card {
        background: var(--amz-card);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--amz-border);
        transition: all 0.2s;
        text-decoration: none;
        display: flex;
        flex-direction: column;
    }

    .amz-book-card:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        transform: translateY(-3px);
    }

    .amz-book-cover {
        height: 220px;
        background: linear-gradient(135deg, #232f3e, #37475a);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .amz-book-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }

    .amz-book-card:hover .amz-book-cover img {
        transform: scale(1.05);
    }

    .amz-book-cover .no-cover {
        color: #fff;
        font-size: 3.5rem;
        opacity: 0.5;
    }

    .amz-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #cc0c39;
        color: #fff;
        padding: 4px 10px;
        font-size: 0.75rem;
        font-weight: 700;
        border-radius: 3px;
    }

    .amz-book-info {
        padding: 15px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .amz-book-title {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--amz-link);
        margin-bottom: 5px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .amz-book-card:hover .amz-book-title {
        color: var(--amz-link-hover);
        text-decoration: underline;
    }

    .amz-book-author {
        font-size: 0.8rem;
        color: var(--amz-text);
        margin-bottom: 8px;
        opacity: 0.8;
    }

    .amz-book-author span {
        color: var(--amz-link);
    }

    .amz-rating {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
    }

    .amz-stars {
        color: var(--amz-star);
        font-size: 0.85rem;
        display: flex;
        gap: 1px;
    }

    .amz-rating-count {
        font-size: 0.8rem;
        color: var(--amz-link);
    }

    .amz-book-meta {
        font-size: 0.8rem;
        color: var(--amz-text);
        opacity: 0.7;
        margin-top: auto;
        display: flex;
        gap: 12px;
    }

    .amz-book-category {
        display: inline-block;
        background: #f0f2f2;
        padding: 4px 10px;
        border-radius: 3px;
        font-size: 0.75rem;
        color: var(--amz-text);
        margin-top: 10px;
    }

    body.dark-mode .amz-book-category {
        background: #2a2a2a;
    }

    /* Stats Section */
    .amz-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .amz-stat-card {
        flex: 1;
        background: var(--amz-card);
        border: 1px solid var(--amz-border);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }

    .amz-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--amz-orange);
    }

    .amz-stat-label {
        font-size: 0.85rem;
        color: var(--amz-text);
        opacity: 0.8;
    }

    /* Action Buttons */
    .amz-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: var(--amz-orange);
        color: #000;
        border: none;
        border-radius: 20px;
        font-weight: 600;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
    }

    .amz-action-btn:hover {
        background: var(--amz-orange-hover);
    }

    .amz-action-btn.secondary {
        background: transparent;
        border: 1px solid var(--amz-border);
        color: var(--amz-text);
    }

    .amz-action-btn.secondary:hover {
        background: var(--amz-light-dark);
        color: #fff;
    }

    /* Active Filters */
    .amz-active-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .amz-filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--amz-light-dark);
        color: #fff;
        border-radius: 3px;
        font-size: 0.85rem;
    }

    .amz-filter-tag a {
        color: #fff;
        text-decoration: none;
        font-weight: 700;
        margin-left: 5px;
    }

    .amz-filter-tag a:hover {
        color: var(--amz-orange);
    }

    /* Empty State */
    .amz-empty {
        text-align: center;
        padding: 60px 20px;
        background: var(--amz-card);
        border-radius: 8px;
        border: 1px solid var(--amz-border);
    }

    .amz-empty i {
        font-size: 4rem;
        color: var(--amz-border);
        margin-bottom: 20px;
    }

    .amz-empty h3 {
        color: var(--amz-text);
        margin-bottom: 10px;
    }

    .amz-empty p {
        color: var(--amz-text);
        opacity: 0.7;
    }



    /* Back link */
    .amz-back-link {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: var(--amz-link);
        text-decoration: none;
        font-size: 0.85rem;
        margin-bottom: 15px;
    }

    .amz-back-link:hover {
        color: var(--amz-link-hover);
        text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .amz-container {
            flex-direction: column;
        }

        .amz-sidebar {
            width: 100%;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .amz-sidebar-section {
            flex: 1;
            min-width: 250px;
        }
    }

    @media (max-width: 768px) {
        .amz-page-wrapper {
            padding-top: 70px;
        }

        .amz-top-nav {
            padding: 8px 10px;
            gap: 8px;
        }

        .amz-nav-item {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .amz-books-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .amz-book-cover {
            height: 180px;
        }

        .amz-stats {
            flex-wrap: wrap;
        }

        .amz-stat-card {
            min-width: calc(50% - 10px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="amz-page-wrapper">
    <!-- Top Navigation -->
    <div class="amz-top-nav">
        <a href="{% url 'all_books' %}" class="amz-nav-item {% if current_tab == 'all' %}active{% endif %}">
            <i class="fas fa-th-large"></i> Barchasi
        </a>
        <a href="{% url 'all_books' %}?tab=new" class="amz-nav-item {% if current_tab == 'new' %}active{% endif %}">
            <i class="fas fa-bolt"></i> Yangi qo'shilgan
        </a>
        <a href="{% url 'all_books' %}?tab=top" class="amz-nav-item {% if current_tab == 'top' %}active{% endif %}">
            <i class="fas fa-trophy"></i> Eng mashhur
        </a>
        {% if user.is_authenticated %}
        <a href="{% url 'all_books' %}?tab=favorites" class="amz-nav-item {% if current_tab == 'favorites' %}active{% endif %}">
            <i class="fas fa-heart"></i> Sevimlilar
        </a>
        {% endif %}
    </div>

    <!-- Main Container -->
    <div class="amz-container">
        <!-- Sidebar -->
        <aside class="amz-sidebar">
            <!-- Back Link -->
            <a href="{% url 'boshlash' %}" class="amz-back-link">
                <i class="fas fa-arrow-left"></i> Bosh sahifaga qaytish
            </a>

            <!-- Upload Button -->
            {% if user.is_authenticated %}
            <a href="{% url 'kitob_yuklash' %}" class="amz-action-btn" style="width: 100%; justify-content: center; margin-bottom: 15px;">
                <i class="fas fa-cloud-upload-alt"></i> Kitob yuklash
            </a>
            {% endif %}

            <!-- Authors Filter -->
            <div class="amz-sidebar-section">
                <h3 class="amz-sidebar-title"><i class="fas fa-feather-alt"></i> Adiblar</h3>
                <ul class="amz-filter-list">
                    <li>
                        <a href="{% url 'all_books' %}{% if current_category %}?category={{ current_category }}{% endif %}" 
                           class="{% if not current_author %}active{% endif %}">
                            <i class="fas fa-users"></i> Barcha adiblar
                        </a>
                    </li>
                    {% for author in authors %}
                    <li>
                        <a href="{% url 'all_books' %}?author={{ author.id }}{% if current_category %}&category={{ current_category }}{% endif %}" 
                           class="{% if current_author == author.id %}active{% endif %}">
                            {% if author.image %}
                                <img src="{{ author.image.url }}" alt="{{ author.name }}">
                            {% else %}
                                <span class="amz-avatar-sm">{{ author.name|slice:":1" }}</span>
                            {% endif %}
                            {{ author.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Categories Filter -->
            <div class="amz-sidebar-section">
                <h3 class="amz-sidebar-title"><i class="fas fa-folder-open"></i> Kategoriyalar</h3>
                <ul class="amz-filter-list">
                    <li>
                        <a href="{% url 'all_books' %}{% if current_author %}?author={{ current_author }}{% endif %}" 
                           class="{% if not current_category %}active{% endif %}">
                            Barcha kategoriyalar
                        </a>
                    </li>
                    {% for cat in categories %}
                    <li>
                        <a href="{% url 'all_books' %}?category={{ cat.slug }}{% if current_author %}&author={{ current_author }}{% endif %}" 
                           class="{% if current_category == cat.slug %}active{% endif %}">
                            <i class="{{ cat.icon|default:'fas fa-bookmark' }}"></i> {{ cat.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="amz-main">
            <!-- Search Bar -->
            <div class="amz-search-bar">
                <form class="amz-search-input" method="get" style="flex: 1;">
                    {% if current_author %}<input type="hidden" name="author" value="{{ current_author }}">{% endif %}
                    {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
                    <input type="text" name="q" placeholder="Kitob nomi, muallif yoki kalit so'z qidiring..." 
                           value="{{ search_query|default:'' }}">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
            </div>

            <!-- Stats -->
            <div class="amz-stats">
                <div class="amz-stat-card">
                    <div class="amz-stat-value">{{ books.count }}</div>
                    <div class="amz-stat-label">Kitoblar</div>
                </div>
                <div class="amz-stat-card">
                    <div class="amz-stat-value">{{ authors.count }}</div>
                    <div class="amz-stat-label">Adiblar</div>
                </div>
                <div class="amz-stat-card">
                    <div class="amz-stat-value">{{ categories.count }}</div>
                    <div class="amz-stat-label">Kategoriyalar</div>
                </div>
            </div>

            <!-- Active Filters -->
            {% if current_author or current_category or search_query %}
            <div class="amz-active-filters">
                {% if search_query %}
                <span class="amz-filter-tag">
                    <i class="fas fa-search"></i> "{{ search_query }}"
                    <a href="{% url 'all_books' %}{% if current_author %}?author={{ current_author }}{% endif %}{% if current_category %}{% if current_author %}&{% else %}?{% endif %}category={{ current_category }}{% endif %}">&times;</a>
                </span>
                {% endif %}
                {% if current_author %}
                <span class="amz-filter-tag">
                    <i class="fas fa-user"></i> Adib filtri
                    <a href="{% url 'all_books' %}{% if current_category %}?category={{ current_category }}{% endif %}">&times;</a>
                </span>
                {% endif %}
                {% if current_category %}
                <span class="amz-filter-tag">
                    <i class="fas fa-folder"></i> {{ current_category }}
                    <a href="{% url 'all_books' %}{% if current_author %}?author={{ current_author }}{% endif %}">&times;</a>
                </span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Results Header -->
            <div class="amz-results-header">
                <div class="amz-results-info">
                    <strong>{{ books.count }}</strong> natija topildi
                    {% if search_query %} - "{{ search_query }}"{% endif %}
                </div>
                <div class="amz-view-options">
                    <button class="amz-view-btn active" onclick="setGridView('grid')">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="amz-view-btn" onclick="setGridView('list')">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            <!-- Books Grid -->
            {% if books %}
            <div class="amz-books-grid" id="books-grid">
                {% for book in books %}
                <a href="{% url 'book_detail' book.id %}" class="amz-book-card">
                    <div class="amz-book-cover">
                        {% if book.cover_image %}
                            <img src="{{ book.cover_image.url }}" alt="{{ book.title }}">
                        {% else %}
                            <i class="fas fa-book no-cover"></i>
                        {% endif %}
                        
                        {% if forloop.counter <= 5 and current_tab == 'new' %}
                        <span class="amz-badge">Yangi</span>
                        {% elif book.average_rating >= 4.5 %}
                        <span class="amz-badge" style="background: #067d62;">Bestseller</span>
                        {% endif %}
                    </div>
                    <div class="amz-book-info">
                        <h3 class="amz-book-title">{{ book.title }}</h3>
                        <p class="amz-book-author">
                            <span>{{ book.author.name }}</span>
                        </p>
                        
                        {% if book.average_rating > 0 %}
                        <div class="amz-rating">
                            <div class="amz-stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= book.average_rating %}
                                        <i class="fas fa-star"></i>
                                    {% elif forloop.counter <= book.average_rating|add:"0.5" %}
                                        <i class="fas fa-star-half-alt"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="amz-rating-count">{{ book.average_rating|floatformat:1 }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="amz-book-meta">
                            <span><i class="fas fa-eye"></i> {{ book.views_count }}</span>
                            <span><i class="fas fa-file-alt"></i> {{ book.pages.count }}</span>
                        </div>
                        
                        {% if book.category %}
                        <span class="amz-book-category">{{ book.category.name }}</span>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="amz-empty">
                <i class="fas fa-search"></i>
                <h3>Kitoblar topilmadi</h3>
                {% if search_query %}
                <p>"{{ search_query }}" so'rovi bo'yicha hech narsa topilmadi</p>
                {% else %}
                <p>Tanlangan filtrlar bo'yicha kitoblar mavjud emas</p>
                {% endif %}
                <a href="{% url 'all_books' %}" class="amz-action-btn secondary" style="margin-top: 20px;">
                    <i class="fas fa-undo"></i> Filtrlarni tozalash
                </a>
            </div>
            {% endif %}
        </main>
    </div>
</div>

<script>
function setGridView(type) {
    const grid = document.getElementById('books-grid');
    const buttons = document.querySelectorAll('.amz-view-btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.closest('.amz-view-btn').classList.add('active');
    
    if (type === 'list') {
        grid.style.gridTemplateColumns = '1fr';
    } else {
        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
    }
}
</script>
{% endblock %}
