{% extends "blog/boshlash.html" %}
{% load static %}

{% block title %}To'lov - {{ plan.name }} | Cloudstore{% endblock %}

{% block content %}
<style>
    .checkout-section {
        min-height: 100vh;
        padding: 40px 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }
    
    body.dark-mode .checkout-section {
        background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
    }
    
    .checkout-container {
        max-width: 900px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 30px;
    }
    
    @media (max-width: 768px) {
        .checkout-container {
            grid-template-columns: 1fr;
        }
    }
    
    .checkout-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    body.dark-mode .checkout-card {
        background: #2d2d2d;
    }
    
    .checkout-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    body.dark-mode .checkout-header {
        border-color: #444;
    }
    
    .checkout-header i {
        font-size: 2rem;
        color: #667eea;
    }
    
    .checkout-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .payment-methods {
        margin-bottom: 30px;
    }
    
    .payment-methods h4 {
        margin-bottom: 15px;
        color: #64748b;
    }
    
    .payment-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .payment-option {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .payment-option:hover {
        border-color: #667eea;
    }
    
    .payment-option.active {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }
    
    .payment-option img {
        height: 30px;
        margin-bottom: 5px;
    }
    
    .payment-option span {
        display: block;
        font-size: 0.85rem;
        color: #64748b;
    }
    
    /* Promo Code */
    .promo-section {
        margin-bottom: 30px;
    }
    
    .promo-input-group {
        display: flex;
        gap: 10px;
    }
    
    .promo-input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        text-transform: uppercase;
    }
    
    .promo-input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .promo-btn {
        padding: 12px 25px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .promo-message {
        margin-top: 10px;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
    }
    
    .promo-message.success {
        background: #dcfce7;
        color: #166534;
    }
    
    .promo-message.error {
        background: #fee2e2;
        color: #dc2626;
    }
    
    /* Order Summary */
    .order-summary {
        position: sticky;
        top: 100px;
    }
    
    .plan-preview {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        margin-bottom: 20px;
    }
    
    .plan-preview-icon {
        width: 60px;
        height: 60px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }
    
    .plan-preview-info h3 {
        margin: 0 0 5px;
    }
    
    .price-breakdown {
        padding: 20px 0;
        border-bottom: 1px solid #e2e8f0;
    }
    
    body.dark-mode .price-breakdown {
        border-color: #444;
    }
    
    .price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .price-row.discount {
        color: #10b981;
    }
    
    .price-total {
        display: flex;
        justify-content: space-between;
        font-size: 1.3rem;
        font-weight: bold;
        padding-top: 15px;
    }
    
    .checkout-btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s;
    }
    
    .checkout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    
    .checkout-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .security-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        color: #64748b;
        font-size: 0.85rem;
    }
    
    .security-badges i {
        margin-right: 5px;
    }
    
    /* Terms */
    .terms-check {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-top: 15px;
        font-size: 0.85rem;
        color: #64748b;
    }
    
    .terms-check input {
        margin-top: 3px;
    }
    
    .terms-check a {
        color: #667eea;
    }
</style>

<!-- Navigatsiya tugmalari -->
<div style="display: flex; gap: 10px; padding: 100px 20px 20px; max-width: 900px; margin: 0 auto;">
    <a href="javascript:history.back()" style="padding: 10px 20px; background: var(--card-bg); border-radius: 10px; text-decoration: none; color: var(--text-color); display: inline-flex; align-items: center; gap: 8px;">
        <i class="fas fa-arrow-left"></i> Orqaga
    </a>
    <a href="{% url 'boshlash' %}" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; text-decoration: none; color: white; display: inline-flex; align-items: center; gap: 8px;">
        <i class="fas fa-home"></i> Bosh sahifa
    </a>
</div>

<section class="checkout-section" style="padding-top: 20px;">
    <div class="checkout-container">
        <!-- Left: Payment Form -->
        <div class="checkout-card">
            <div class="checkout-header">
                <i class="fas fa-credit-card"></i>
                <div>
                    <h2>To'lov ma'lumotlari</h2>
                    <p style="margin: 0; color: #64748b;">Xavfsiz to'lov</p>
                </div>
            </div>
            
            <!-- Payment Methods -->
            <div class="payment-methods">
                <h4>To'lov usulini tanlang</h4>
                <div class="payment-options">
                    <div class="payment-option active" data-method="click">
                        <img src="https://click.uz/click/images/logo.svg" alt="Click" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2230%22><text y=%2220%22 fill=%22%23667eea%22>CLICK</text></svg>'">
                        <span>Click</span>
                    </div>
                    <div class="payment-option" data-method="payme">
                        <img src="https://cdn.payme.uz/logo/payme_01.svg" alt="Payme" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2230%22><text y=%2220%22 fill=%22%2300CCCC%22>PAYME</text></svg>'">
                        <span>Payme</span>
                    </div>
                    <div class="payment-option" data-method="uzum">
                        <img src="https://uzumbank.uz/logo.svg" alt="Uzum" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2230%22><text y=%2220%22 fill=%22%237C3AED%22>UZUM</text></svg>'">
                        <span>Uzum Bank</span>
                    </div>
                    <div class="payment-option" data-method="stripe">
                        <i class="fab fa-cc-visa" style="font-size: 1.5rem; color: #1a1f71;"></i>
                        <i class="fab fa-cc-mastercard" style="font-size: 1.5rem; color: #eb001b;"></i>
                        <span>Xalqaro karta</span>
                    </div>
                </div>
            </div>
            
            <!-- Promo Code -->
            <div class="promo-section">
                <h4 style="margin-bottom: 10px; color: #64748b;">Promo kod</h4>
                <div class="promo-input-group">
                    <input type="text" class="promo-input" id="promoCode" placeholder="Promo kodni kiriting" value="{{ promo.code|default:'' }}">
                    <button class="promo-btn" onclick="applyPromo()">Qo'llash</button>
                </div>
                <div id="promoMessage" class="promo-message" style="display: none;"></div>
            </div>
            
            <!-- Terms -->
            <div class="terms-check">
                <input type="checkbox" id="termsCheck" required>
                <label for="termsCheck">
                    Men <a href="/terms/">Foydalanish shartlari</a> va <a href="/privacy/">Maxfiylik siyosati</a> bilan tanishdim va roziman.
                </label>
            </div>
        </div>
        
        <!-- Right: Order Summary -->
        <div class="checkout-card order-summary">
            <h3 style="margin: 0 0 20px;">Buyurtma xulosasi</h3>
            
            <div class="plan-preview">
                <div class="plan-preview-icon">
                    {% if plan.plan_type == 'standard' %}‚≠ê
                    {% elif plan.plan_type == 'premium' %}üíé
                    {% elif plan.plan_type == 'vip' %}üëë
                    {% else %}üìö{% endif %}
                </div>
                <div class="plan-preview-info">
                    <h3>{{ plan.name }}</h3>
                    <span>{{ plan.get_duration_type_display }}</span>
                </div>
            </div>
            
            <div class="price-breakdown">
                <div class="price-row">
                    <span>{{ plan.name }} obunasi</span>
                    <span>{{ plan.price|floatformat:0 }} so'm</span>
                </div>
                {% if discount > 0 %}
                <div class="price-row discount" id="discountRow">
                    <span>Chegirma ({{ promo.code }})</span>
                    <span>-{{ discount|floatformat:0 }} so'm</span>
                </div>
                {% endif %}
            </div>
            
            <div class="price-total">
                <span>Jami:</span>
                <span id="totalPrice">{{ final_price|floatformat:0 }} so'm</span>
            </div>
            
            <button class="checkout-btn" id="checkoutBtn" onclick="processPayment()">
                <i class="fas fa-lock"></i> Xavfsiz to'lov
            </button>
            
            <div class="security-badges">
                <span><i class="fas fa-shield-alt"></i> SSL himoyalangan</span>
                <span><i class="fas fa-undo"></i> 7 kun kafolat</span>
            </div>
        </div>
    </div>
</section>

<script>
let selectedMethod = 'click';
let currentDiscount = {{ discount|default:0 }};

// Payment method selection
document.querySelectorAll('.payment-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
        this.classList.add('active');
        selectedMethod = this.dataset.method;
    });
});

// Apply promo code
async function applyPromo() {
    const code = document.getElementById('promoCode').value.trim();
    const messageEl = document.getElementById('promoMessage');
    
    if (!code) {
        messageEl.textContent = 'Kodni kiriting';
        messageEl.className = 'promo-message error';
        messageEl.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch('/api/apply-promo/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                code: code,
                plan_id: {{ plan.id }}
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageEl.textContent = data.message;
            messageEl.className = 'promo-message success';
            
            // Update price
            const originalPrice = {{ plan.price|default:0 }};
            if (data.code_type === 'percentage') {
                currentDiscount = originalPrice * data.value / 100;
            } else {
                currentDiscount = data.value;
            }
            
            const newTotal = Math.max(0, originalPrice - currentDiscount);
            document.getElementById('totalPrice').textContent = newTotal.toLocaleString() + " so'm";
            
            // Show discount row
            let discountRow = document.getElementById('discountRow');
            if (!discountRow) {
                const breakdown = document.querySelector('.price-breakdown');
                discountRow = document.createElement('div');
                discountRow.id = 'discountRow';
                discountRow.className = 'price-row discount';
                discountRow.innerHTML = `<span>Chegirma (${code})</span><span>-${currentDiscount.toLocaleString()} so'm</span>`;
                breakdown.appendChild(discountRow);
            } else {
                discountRow.innerHTML = `<span>Chegirma (${code})</span><span>-${currentDiscount.toLocaleString()} so'm</span>`;
            }
        } else {
            messageEl.textContent = data.message;
            messageEl.className = 'promo-message error';
        }
        
        messageEl.style.display = 'block';
    } catch (error) {
        messageEl.textContent = 'Xatolik yuz berdi';
        messageEl.className = 'promo-message error';
        messageEl.style.display = 'block';
    }
}

// Process payment
async function processPayment() {
    const termsCheck = document.getElementById('termsCheck');
    
    if (!termsCheck.checked) {
        alert('Iltimos, shartlarni qabul qiling');
        return;
    }
    
    const btn = document.getElementById('checkoutBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kuting...';
    
    try {
        const response = await fetch('/api/create-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                plan_id: {{ plan.id }},
                payment_method: selectedMethod,
                promo_code: document.getElementById('promoCode').value.trim()
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Redirect to payment page
            window.location.href = data.payment_url;
        } else {
            alert(data.error || 'Xatolik yuz berdi');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-lock"></i> Xavfsiz to\'lov';
        }
    } catch (error) {
        alert('Xatolik yuz berdi. Qaytadan urinib ko\'ring.');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Xavfsiz to\'lov';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
