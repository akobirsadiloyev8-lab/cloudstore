{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }} profili | Cloudstore{% endblock %}

{% block content %}
<!-- content -->
<div class="container mt-3" id="main-content">
    <!-- Cover image -->
    <figure class="coverimg w-100 height-180 mb-0 position-relative rounded z-index-0 overlay-gradiant overflow-hidden">
        {% if is_owner %}
        <div class="position-absolute top-0 end-0 z-index-1 m-2">
            <button class="btn btn-sm btn-theme" onclick="this.nextElementSibling.click()"><i class="bi bi-camera"></i> Muqova o'zgartirish</button>
            <input type="file" class="d-none" id="cover-upload">
        </div>
        {% endif %}
        {% if profile.cover_image %}
        <img src="{{ profile.cover_image.url }}" class="mw-100" alt="Cover" />
        {% else %}
        <img src="{% static 'assets/img/background-image/backgorund-image-13.jpg' %}" class="mw-100" alt="Default cover" />
        {% endif %}
    </figure>

    <!-- Profile header section -->
    <div class="row gx-3 gx-lg-4 align-items-start">
        <!-- Avatar and action buttons -->
        <div class="col-12 col-md-auto position-relative px-3 px-lg-4 text-center mb-3 mb-lg-4">
            <figure class="avatar avatar-100 coverimg rounded-circle mt--50 shadow-md border-3 border-light position-relative overflow-visible mb-3 mb-lg-4">
                {% if profile.avatar %}
                <img src="{{ profile.avatar.url }}" alt="{{ profile_user.username }}" />
                {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-theme-1 text-white" style="font-size: 2.5rem; font-weight: 700;">
                    {{ profile_user.username|first|upper }}
                </div>
                {% endif %}
                {% if is_owner %}
                <div class="position-absolute bottom-0 end-0 m-0 z-index-1 lh-20">
                    <button class="btn btn-sm btn-theme btn-square shadow rounded-circle" onclick="this.nextElementSibling.click()"><i class="bi bi-camera"></i></button>
                    <input type="file" class="d-none" id="avatar-upload">
                </div>
                {% endif %}
            </figure>
            <br>
            {% if not is_owner %}
                {% if user.is_authenticated %}
                <button class="btn {% if is_following %}btn-outline-theme{% else %}btn-theme{% endif %} me-2" id="followBtn" onclick="toggleFollow()">
                    {% if is_following %}
                    <i class="bi bi-check2 vm me-2"></i> Kuzatilyapti
                    {% else %}
                    <i class="bi bi-plus vm me-2"></i> Kuzatish
                    {% endif %}
                </button>
                <a href="{% url 'telegram_chat_with_user' profile_user.username %}" class="btn btn-outline-theme">
                    <i class="bi bi-chat-dots vm me-2"></i> Xabar
                </a>
                {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-theme me-2">
                    <i class="bi bi-person-plus vm me-2"></i> Kuzatish
                </a>
                {% endif %}
            {% else %}
            <a href="{% url 'edit_profile' %}" class="btn btn-theme">
                <i class="bi bi-pencil vm me-2"></i> Profilni tahrirlash
            </a>
            {% endif %}
        </div>

        <!-- User info -->
        <div class="col-12 col-md pt-0 pt-md-3 mb-3 mb-lg-4">
            <h2>
                <span class="text-gradient">{{ profile_user.first_name|default:profile_user.username }} {{ profile_user.last_name }}</span>
                {% if profile_user.is_staff %}
                <span class="badge bg-theme-1 theme-green rounded fs-14"><i class="bi bi-patch-check-fill me-1"></i> Admin</span>
                {% endif %}
            </h2>
            <p class="mb-1"><span class="text-secondary me-2"><i class="bi bi-at me-2"></i>Username:</span> @{{ profile_user.username }}</p>
            {% if profile.bio %}
            <p class="mb-1"><span class="text-secondary me-2"><i class="bi bi-chat-right-text me-2"></i>Bio:</span> {{ profile.bio }}</p>
            {% endif %}
            {% if profile.location %}
            <p class="mb-1"><span class="text-secondary me-2"><i class="bi bi-geo-alt me-2"></i>Joylashuv:</span> {{ profile.location }}</p>
            {% endif %}
            <p class="mb-1"><span class="text-secondary me-2"><i class="bi bi-calendar-event me-2"></i>Qo'shilgan:</span> {{ profile_user.date_joined|date:"d M, Y" }}</p>
            {% if profile.website %}
            <p class="mb-1"><span class="text-secondary me-2"><i class="bi bi-link-45deg me-2"></i>Vebsayt:</span> <a href="{{ profile.website }}" target="_blank" class="text-theme-1">{{ profile.website }}</a></p>
            {% endif %}
        </div>

        <!-- Stats -->
        <div class="col-12 col-xl-auto pt-0 pt-md-3 text-center">
            <div class="row gx-3 gx-lg-4">
                <div class="col">
                    <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                        <div class="card-header">
                            <h4 class="mb-0">{{ followers_count }}</h4>
                            <p class="text-secondary small">Kuzatuvchilar</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                        <div class="card-header">
                            <h4 class="mb-0">{{ following_count }}</h4>
                            <p class="text-secondary small">Kuzatilayotganlar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if can_view %}
    <!-- Profile Overview Card -->
    {% if is_owner %}
    <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
        <div class="card-header">
            <h6 class="mb-0">Profil ko'rib chiqish</h6>
            <p class="text-secondary small"><i class="bi bi-eye me-1"></i> Faqat sizga ko'rinadi</p>
        </div>
        <div class="card-body">
            <div class="row gx-3">
                <div class="col-12 col-md-6 col-lg-4 mb-3 mb-lg-0">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-people avatar avatar-30 bg-theme-1-subtle text-theme-1 rounded"></i>
                        </div>
                        <div class="col">
                            <h5 class="mb-0">{{ followers_count }} <small>Kuzatuvchilar</small></h5>
                            <p class="text-secondary small">Sizni kuzatayotganlar</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-4 mb-3 mb-lg-0">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-star avatar avatar-30 bg-theme-1-subtle text-theme-1 rounded"></i>
                        </div>
                        <div class="col">
                            <h5 class="mb-0">{{ reviews|length }} <small>Sharhlar</small></h5>
                            <p class="text-secondary small">Yozilgan sharhlar</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row gx-3 gx-lg-4">
        <!-- Left Column - About & Connections -->
        <div class="col-12 col-md-6 col-lg-5 col-xl-4">
            <!-- About Section -->
            <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                <div class="card-header">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-person-circle h5 me-1 avatar avatar-40 bg-theme-1-subtle text-theme-1 rounded"></i>
                        </div>
                        <div class="col">
                            <h6 class="mb-0">Haqida</h6>
                            <p class="text-secondary small">{{ profile.bio|default:"Bio mavjud emas"|truncatechars:50 }}</p>
                        </div>
                    </div>
                </div>
                <div class="card-body pb-0">
                    {% if profile.bio %}
                    <p class="text-secondary">{{ profile.bio }}</p>
                    {% endif %}

                    {% if profile_user.email and is_owner %}
                    <div class="row gx-3 align-items-center mb-3">
                        <div class="col-auto">
                            <i class="bi bi-envelope h5 text-theme-1 mb-0"></i>
                        </div>
                        <div class="col">
                            <p class="text-secondary small mb-1">Email</p>
                            <p>{{ profile_user.email }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <div class="row gx-3 align-items-center mb-3">
                        <div class="col-auto">
                            <i class="bi bi-calendar2-heart h5 text-theme-1 mb-0"></i>
                        </div>
                        <div class="col">
                            <p class="text-secondary small mb-1">Qo'shilgan sana</p>
                            <p>{{ profile_user.date_joined|date:"d M, Y" }}</p>
                        </div>
                    </div>

                    {% if profile_user.last_login %}
                    <div class="row gx-3 align-items-center mb-3">
                        <div class="col-auto">
                            <i class="bi bi-clock-history h5 text-theme-1 mb-0"></i>
                        </div>
                        <div class="col">
                            <p class="text-secondary small mb-1">Oxirgi faollik</p>
                            <p>{{ profile_user.last_login|timesince }} oldin</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Followers List -->
            {% if followers %}
            <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                <div class="card-header">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-people h5 me-1 avatar avatar-40 bg-theme-1-subtle text-theme-1 theme-green rounded"></i>
                        </div>
                        <div class="col">
                            <h6 class="mb-0">Kuzatuvchilar</h6>
                            <p class="text-secondary small">{{ followers_count }} kuzatuvchi</p>
                        </div>
                        <div class="col-auto">
                            <a href="#" class="btn btn-sm btn-link">Hammasi</a>
                        </div>
                    </div>
                </div>
                <div class="card-body gallery px-2 pb-0">
                    <div class="row gx-0">
                        {% for follow in followers %}
                        <div class="col-4 mb-2">
                            <a href="{% url 'user_profile_view' follow.follower.username %}" class="btn btn-link w-100">
                                <div class="height-100 w-100 overflow-hidden rounded mb-2">
                                    <figure class="h-100 w-100 coverimg">
                                        {% if follow.follower.userprofile.avatar %}
                                        <img src="{{ follow.follower.userprofile.avatar.url }}" alt="{{ follow.follower.username }}" />
                                        {% else %}
                                        <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-theme-1-subtle text-theme-1" style="font-size: 1.5rem; font-weight: 600;">
                                            {{ follow.follower.username|first|upper }}
                                        </div>
                                        {% endif %}
                                    </figure>
                                </div>
                                <p class="text-truncated small">{{ follow.follower.first_name|default:follow.follower.username }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Following List -->
            {% if following_list %}
            <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                <div class="card-header">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-person-plus h5 me-1 avatar avatar-40 bg-theme-1-subtle text-theme-1 theme-blue rounded"></i>
                        </div>
                        <div class="col">
                            <h6 class="mb-0">Kuzatilayotganlar</h6>
                            <p class="text-secondary small">{{ following_count }} kishi</p>
                        </div>
                        <div class="col-auto">
                            <a href="#" class="btn btn-sm btn-link">Hammasi</a>
                        </div>
                    </div>
                </div>
                <div class="card-body gallery px-2 pb-0">
                    <div class="row gx-0">
                        {% for follow in following_list %}
                        <div class="col-4 mb-2">
                            <a href="{% url 'user_profile_view' follow.following.username %}" class="btn btn-link w-100">
                                <div class="height-100 w-100 overflow-hidden rounded mb-2">
                                    <figure class="h-100 w-100 coverimg">
                                        {% if follow.following.userprofile.avatar %}
                                        <img src="{{ follow.following.userprofile.avatar.url }}" alt="{{ follow.following.username }}" />
                                        {% else %}
                                        <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-theme-1-subtle text-theme-1" style="font-size: 1.5rem; font-weight: 600;">
                                            {{ follow.following.username|first|upper }}
                                        </div>
                                        {% endif %}
                                    </figure>
                                </div>
                                <p class="text-truncated small">{{ follow.following.first_name|default:follow.following.username }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Activity & Reviews -->
        <div class="col-12 col-md-6 col-lg-7 col-xl-8">
            <!-- Reading Activity -->
            {% if reading_activities %}
            <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                <div class="card-header">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-book h5 me-1 avatar avatar-40 bg-theme-1-subtle text-theme-1 rounded"></i>
                        </div>
                       
                    </div>
                </div>
                <div class="card-body pb-0">
                    {% for activity in reading_activities %}
                    <div class="row gx-3 mb-4">
                        <div class="col-auto">
                            <figure class="avatar avatar-50 rounded coverimg">
                                {% if activity.book.cover_image %}
                                <img src="{{ activity.book.cover_image.url }}" alt="{{ activity.book.title }}" />
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-theme-1-subtle text-theme-1">
                                    <i class="bi bi-book"></i>
                                </div>
                                {% endif %}
                            </figure>
                        </div>
                        <div class="col">
                            <h6 class="mb-1">
                                <a href="{% url 'book_detail' activity.book.id %}">{{ activity.book.title }}</a>
                            </h6>
                            <p class="small text-secondary">{{ activity.started_at|date:"d M, Y" }} dan beri o'qimoqda</p>
                            {% if activity.progress %}
                            <div class="progress height-5 mb-2" role="progressbar">
                                <div class="progress-bar bg-theme-1" style="width: {{ activity.progress }}%"></div>
                            </div>
                            <p class="small text-secondary">{{ activity.progress }}% o'qildi</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Mutual Books -->
            {% if mutual_books %}
            <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                <div class="card-header">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-intersect h5 me-1 avatar avatar-40 bg-theme-1-subtle text-theme-1 theme-yellow rounded"></i>
                        </div>
                        <div class="col">
                          
                            <p class="text-secondary small">Siz ham, {{ profile_user.first_name|default:profile_user.username }} ham o'qigan</p>
                        </div>
                    </div>
                </div>
                
            {% endif %}

            <!-- Reviews -->
            {% if reviews %}
            <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                <div class="card-header">
                    <div class="row gx-3 align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-chat-quote h5 me-1 avatar avatar-40 bg-theme-1-subtle text-theme-1 theme-red rounded"></i>
                        </div>
                        <div class="col">
                            <h6 class="mb-0">Sharhlar</h6>
                           
                        </div>
                    </div>
                </div>
                <div class="card-body pb-0">
                    {% for review in reviews %}
                    <div class="row gx-3 mb-4">
                        <div class="col-auto">
                            <figure class="avatar avatar-50 rounded coverimg">
                                {% if review.book.cover_image %}
                                <img src="{{ review.book.cover_image.url }}" alt="{{ review.book.title }}" />
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100 w-100 bg-theme-1-subtle text-theme-1">
                                    <i class="bi bi-book"></i>
                                </div>
                                {% endif %}
                            </figure>
                        </div>
                        <div class="col">
                            <h6 class="mb-1">
                                <a href="{% url 'book_detail' review.book.id %}">{{ review.book.title }}</a>
                            </h6>
                            <p class="small text-secondary mb-2">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                    <i class="bi bi-star text-secondary"></i>
                                    {% endif %}
                                {% endfor %}
                            </p>
                            <h5 class="fw-normal text-gradient">"{{ review.content|truncatechars:200 }}"</h5>
                            <p class="small text-secondary">{{ review.created_at|date:"d M, Y" }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Empty state if no activity -->
            {% if not reading_activities and not reviews %}
            <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
                <div class="card-body text-center py-5">
                    <i class="bi bi-book display-1 text-secondary opacity-50 mb-3"></i>
                    <h5 class="text-secondary">Hali faollik yo'q</h5>
                   
                    {% if is_owner %}
                   
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% else %}
    <!-- Private profile notice -->
    <div class="card adminuiux-card shadow-sm mb-3 mb-lg-4">
        <div class="card-body text-center py-5">
            <i class="bi bi-lock display-1 text-secondary opacity-50 mb-3"></i>
            <h5 class="text-secondary">Bu profil maxfiy</h5>
            <p class="text-secondary small">Profil ma'lumotlarini ko'rish uchun ushbu foydalanuvchini kuzating</p>
            {% if user.is_authenticated and not is_following %}
            <button class="btn btn-theme mt-3" id="followBtn" onclick="toggleFollow()">
                <i class="bi bi-plus vm me-2"></i> Kuzatish
            </button>
            {% elif not user.is_authenticated %}
            <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-theme mt-3">
                <i class="bi bi-box-arrow-in-right me-2"></i> Kirish
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function toggleFollow() {
    fetch(`{% url 'toggle_follow' profile_user.username %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById('followBtn');
            if (data.is_following) {
                btn.innerHTML = '<i class="bi bi-check2 vm me-2"></i> Kuzatilyapti';
                btn.classList.remove('btn-theme');
                btn.classList.add('btn-outline-theme');
            } else {
                btn.innerHTML = '<i class="bi bi-plus vm me-2"></i> Kuzatish';
                btn.classList.remove('btn-outline-theme');
                btn.classList.add('btn-theme');
            }
            // Update followers count
            location.reload();
        }
    });
}
</script>
{% endblock %}
