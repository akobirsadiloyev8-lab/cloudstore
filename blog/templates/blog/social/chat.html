{% extends "blog/boshlash.html" %}
{% load static %}

{% block title %}{{ other_user.username }} bilan suhbat | Cloudstore{% endblock %}

{% block content %}
<style>
    .chat-section {
        min-height: 100vh;
        padding: 80px 0 0;
        background: var(--bg-color);
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background: var(--card-bg);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 100;
    }
    
    .chat-back {
        color: var(--text-color);
        text-decoration: none;
        font-size: 1.2rem;
    }
    
    .chat-user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .chat-user-avatar.default {
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    .chat-user-info {
        flex: 1;
    }
    
    .chat-user-name {
        font-weight: bold;
    }
    
    .chat-user-status {
        font-size: 0.85rem;
        color: #10b981;
    }
    
    .chat-container {
        max-width: 800px;
        width: 100%;
        margin: 80px auto 100px;
        padding: 20px;
        flex: 1;
        overflow-y: auto;
    }
    
    .messages-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .message {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 20px;
        position: relative;
    }
    
    .message.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message.received {
        align-self: flex-start;
        background: var(--card-bg);
        color: var(--text-color);
        border-bottom-left-radius: 5px;
    }
    
    .message-content {
        word-wrap: break-word;
    }
    
    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 5px;
        text-align: right;
    }
    
    .chat-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--card-bg);
        padding: 15px 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    .chat-input-wrapper {
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        gap: 15px;
    }
    
    .chat-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid var(--border-color);
        border-radius: 25px;
        font-size: 1rem;
        background: var(--bg-color);
        color: var(--text-color);
        resize: none;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .chat-send {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s;
    }
    
    .chat-send:hover {
        transform: scale(1.1);
    }
    
    .empty-chat {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }
    
    .date-divider {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }
    
    .date-divider span {
        background: var(--bg-color);
        padding: 5px 15px;
        color: #64748b;
        font-size: 0.85rem;
        border-radius: 15px;
    }
    
    @media (max-width: 768px) {
        .message {
            max-width: 85%;
        }
    }
    
    /* Yangi stillar */
    .online-dot {
        color: #10b981;
        font-size: 0.6rem;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .typing-indicator {
        font-size: 0.8rem;
        color: #64748b;
        font-style: italic;
    }
    
    .typing-dots span {
        animation: typing 1.4s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
        0%, 60%, 100% { opacity: 0; }
        30% { opacity: 1; }
    }
    
    .chat-header-actions {
        display: flex;
        gap: 10px;
    }
    
    .header-btn {
        color: var(--text-color);
        padding: 8px;
        border-radius: 50%;
        transition: background 0.3s;
    }
    
    .header-btn:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .message-reply-preview {
        font-size: 0.8rem;
        padding: 8px 12px;
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
        margin-bottom: 8px;
        border-left: 3px solid #667eea;
    }
    
    .message-image img {
        max-width: 250px;
        max-height: 300px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.3s;
    }
    
    .message-image img:hover {
        transform: scale(1.02);
    }
    
    .message-file {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(0,0,0,0.1);
        border-radius: 12px;
        min-width: 200px;
    }
    
    .message-file i {
        font-size: 1.5rem;
        color: #667eea;
    }
    
    .file-info {
        flex: 1;
    }
    
    .file-name {
        display: block;
        font-weight: 500;
        word-break: break-all;
    }
    
    .file-size {
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .file-download {
        padding: 8px 12px;
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        color: inherit;
    }
    
    .message-content.deleted {
        font-style: italic;
        opacity: 0.6;
    }
    
    .message-meta {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 5px;
        justify-content: flex-end;
    }
    
    .message-edited {
        font-size: 0.65rem;
    }
    
    .message-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .message:hover .message-actions {
        opacity: 1;
    }
    
    .action-btn {
        background: rgba(0,0,0,0.3);
        border: none;
        color: white;
        padding: 5px 8px;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .reply-preview {
        position: fixed;
        bottom: 80px;
        left: 0;
        right: 0;
        background: var(--card-bg);
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-top: 2px solid #667eea;
    }
    
    .reply-content {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #667eea;
    }
    
    .reply-cancel {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.2rem;
        cursor: pointer;
    }
    
    .attach-btn, .emoji-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 10px;
        opacity: 0.7;
        transition: opacity 0.3s;
    }
    
    .attach-btn:hover, .emoji-btn:hover {
        opacity: 1;
    }
    
    /* Emoji Picker Styles */
    .emoji-picker {
        position: fixed;
        bottom: 90px;
        right: 20px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        width: 320px;
        max-height: 400px;
        z-index: 1000;
        overflow: hidden;
        display: none;
    }
    
    .emoji-picker.show {
        display: block;
        animation: slideUp 0.2s ease;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .emoji-picker-header {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .emoji-picker-header input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.9rem;
    }
    
    .emoji-picker-header input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .emoji-close {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.2rem;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .emoji-categories {
        display: flex;
        padding: 8px;
        gap: 5px;
        border-bottom: 1px solid var(--border-color);
        overflow-x: auto;
    }
    
    .emoji-category-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 8px;
        transition: background 0.2s;
    }
    
    .emoji-category-btn:hover,
    .emoji-category-btn.active {
        background: rgba(102, 126, 234, 0.2);
    }
    
    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        padding: 10px;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .emoji-item {
        font-size: 1.5rem;
        padding: 8px;
        text-align: center;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
    }
    
    .emoji-item:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: scale(1.2);
    }
    
    .sticker-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 10px;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .sticker-item {
        font-size: 2.5rem;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        border-radius: 12px;
        background: rgba(255,255,255,0.1);
        transition: all 0.2s;
    }
    
    .sticker-item:hover {
        background: rgba(102, 126, 234, 0.3);
        transform: scale(1.1);
    }
    
    .emoji-tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color);
    }
    
    .emoji-tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        border: none;
        background: none;
        color: var(--text-color);
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .emoji-tab.active {
        color: #667eea;
        border-bottom: 2px solid #667eea;
        margin-bottom: -2px;
    }
    
    .emoji-tab:hover {
        background: rgba(102, 126, 234, 0.1);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }

    .file-preview {
        padding: 10px 20px;
        background: var(--bg-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-top: 1px solid var(--border-color);
    }
    
    .preview-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .preview-content img {
        max-height: 60px;
        border-radius: 8px;
    }
    
    .preview-cancel {
        background: #ef4444;
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
    }
    
    .message-menu {
        position: fixed;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        padding: 8px 0;
        z-index: 1000;
        min-width: 180px;
    }
    
    .message-menu button {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 12px 20px;
        border: none;
        background: none;
        color: var(--text-color);
        cursor: pointer;
        font-size: 0.95rem;
    }
    
    .message-menu button:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .message-menu button.danger {
        color: #ef4444;
    }
    
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    
    .image-modal img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
    }
    
    .close-modal {
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 2rem;
        color: white;
        cursor: pointer;
    }
</style>

<section class="chat-section">
    <!-- Chat Header -->
    <div class="chat-header">
        <a href="{% url 'messages_inbox' %}" class="chat-back">
            <i class="fas fa-arrow-left"></i>
        </a>
        {% if other_profile.avatar %}
        <img src="{{ other_profile.avatar.url }}" alt="{{ other_user.username }}" class="chat-user-avatar">
        {% else %}
        <div class="chat-user-avatar default">{{ other_user.username|first|upper }}</div>
        {% endif %}
        <div class="chat-user-info">
            <div class="chat-user-name">{{ other_user.first_name|default:other_user.username }} {{ other_user.last_name }}</div>
            <div class="chat-user-status" id="userStatus">
                {% if other_profile.show_online_status %}
                    {% if other_profile.is_online %}
                    <i class="fas fa-circle online-dot"></i> <span id="statusText">Online</span>
                    {% else %}
                    <span id="statusText">{{ other_profile.get_online_status_display }}</span>
                    {% endif %}
                {% endif %}
            </div>
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <span>yozmoqda</span>
                <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
            </div>
        </div>
        <div class="chat-header-actions">
            <a href="{% url 'user_profile' other_user.username %}" class="header-btn">
                <i class="fas fa-user"></i>
            </a>
        </div>
    </div>
    
    <!-- Messages -->
    <div class="chat-container" id="chatContainer">
        {% if messages %}
        <div class="messages-list" id="messagesList">
            {% for message in messages %}
            <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}" 
                 data-id="{{ message.id }}" 
                 data-type="{{ message.message_type }}">
                
                {% if message.reply_to and message.reply_to.is_visible_to %}
                <div class="message-reply-preview">
                    <i class="fas fa-reply"></i>
                    {{ message.reply_to.content|truncatechars:50 }}
                </div>
                {% endif %}
                
                {% if message.is_deleted_for_everyone %}
                <div class="message-content deleted">
                    <i class="fas fa-ban"></i> Bu xabar o'chirildi
                </div>
                {% else %}
                    {% if message.message_type == 'image' and message.file %}
                    <div class="message-image">
                        <img src="{{ message.file.url }}" alt="Rasm" onclick="openImageModal('{{ message.file.url }}')">
                    </div>
                    {% elif message.message_type == 'file' and message.file %}
                    <div class="message-file">
                        <i class="fas fa-file"></i>
                        <div class="file-info">
                            <span class="file-name">{{ message.file_name }}</span>
                            <span class="file-size">{{ message.format_file_size }}</span>
                        </div>
                        <a href="{{ message.file.url }}" download class="file-download">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                    {% endif %}
                    
                    {% if message.content %}
                    <div class="message-content">{{ message.content|linebreaks }}</div>
                    {% endif %}
                {% endif %}
                
                <div class="message-meta">
                    <span class="message-time">{{ message.created_at|time:"H:i" }}</span>
                    {% if message.edited_at %}
                    <span class="message-edited"><i class="fas fa-pencil-alt"></i></span>
                    {% endif %}
                    {% if message.sender == user %}
                    <span class="message-status">
                        {% if message.is_read %}
                        <i class="fas fa-check-double" style="color: #3b82f6;"></i>
                        {% else %}
                        <i class="fas fa-check"></i>
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
                
                {% if message.sender == user and not message.is_deleted_for_everyone %}
                <div class="message-actions">
                    <button onclick="showMessageMenu({{ message.id }})" class="action-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-chat" id="emptyChat">
            <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
            <p>Suhbatni boshlang!</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Reply Preview -->
    <div class="reply-preview" id="replyPreview" style="display: none;">
        <div class="reply-content">
            <i class="fas fa-reply"></i>
            <span id="replyText"></span>
        </div>
        <button onclick="cancelReply()" class="reply-cancel">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Input -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="attach-btn" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.zip" onchange="handleFileSelect(event)">
            
            <textarea class="chat-input" id="messageInput" placeholder="Xabar yozing..." rows="1"></textarea>
            
            <button class="emoji-btn" onclick="toggleEmojiPicker()">
                <i class="fas fa-smile"></i>
            </button>
            
            <button class="chat-send" id="sendBtn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        
        <!-- File Preview -->
        <div class="file-preview" id="filePreview" style="display: none;">
            <div class="preview-content">
                <img id="imagePreviewThumb" src="" alt="" style="display: none;">
                <div id="filePreviewInfo" style="display: none;">
                    <i class="fas fa-file"></i>
                    <span id="filePreviewName"></span>
                </div>
            </div>
            <button onclick="cancelFileUpload()" class="preview-cancel">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- Message Context Menu -->
    <div class="message-menu" id="messageMenu" style="display: none;">
        <button onclick="replyToMessage()"><i class="fas fa-reply"></i> Javob berish</button>
        <button onclick="editMessage()"><i class="fas fa-edit"></i> Tahrirlash</button>
        <button onclick="deleteMessage(false)"><i class="fas fa-trash"></i> O'chirish</button>
        <button onclick="deleteMessage(true)" class="danger"><i class="fas fa-trash-alt"></i> Hammadan o'chirish</button>
    </div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="close-modal">&times;</span>
        <img id="modalImage" src="">
    </div>
    
    <!-- Emoji/Sticker Picker -->
    <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-tabs">
            <button class="emoji-tab active" onclick="switchEmojiTab('emoji')">üòÄ Emoji</button>
            <button class="emoji-tab" onclick="switchEmojiTab('sticker')">üé® Stikerlar</button>
        </div>
        
        <!-- Emoji Tab -->
        <div class="tab-content active" id="emojiTab">
            <div class="emoji-categories">
                <button class="emoji-category-btn active" onclick="showEmojiCategory('smileys')" title="Yuzlar">üòÄ</button>
                <button class="emoji-category-btn" onclick="showEmojiCategory('gestures')" title="Qo'llar">üëã</button>
                <button class="emoji-category-btn" onclick="showEmojiCategory('hearts')" title="Yuraklar">‚ù§Ô∏è</button>
                <button class="emoji-category-btn" onclick="showEmojiCategory('animals')" title="Hayvonlar">üê∂</button>
                <button class="emoji-category-btn" onclick="showEmojiCategory('food')" title="Ovqat">üçï</button>
                <button class="emoji-category-btn" onclick="showEmojiCategory('activities')" title="Faoliyat">‚öΩ</button>
                <button class="emoji-category-btn" onclick="showEmojiCategory('objects')" title="Narsalar">üí°</button>
                <button class="emoji-category-btn" onclick="showEmojiCategory('symbols')" title="Belgilar">üíØ</button>
            </div>
            <div class="emoji-grid" id="emojiGrid">
                <!-- Emoji'lar JS orqali qo'shiladi -->
            </div>
        </div>
        
        <!-- Sticker Tab -->
        <div class="tab-content" id="stickerTab">
            <div class="sticker-grid" id="stickerGrid">
                <!-- Stikerlar JS orqali qo'shiladi -->
            </div>
        </div>
    </div>
</section>

<script>
// Global variables
let lastMessageId = {{ messages.last.id|default:0 }};
let selectedMessageId = null;
let replyToId = null;
let selectedFile = null;
let typingTimeout = null;

// Scroll to bottom
function scrollToBottom() {
    const container = document.getElementById('chatContainer');
    container.scrollTop = container.scrollHeight;
}
scrollToBottom();

// Enter to send
const messageInput = document.getElementById('messageInput');
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Typing indicator
messageInput.addEventListener('input', function() {
    // Notify typing
    fetch(`/api/chat/{{ other_user.username }}/typing/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_typing: true })
    });
    
    // Stop typing after 3 seconds
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        fetch(`/api/chat/{{ other_user.username }}/typing/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_typing: false })
        });
    }, 3000);
});

// Send message
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content && !selectedFile) return;
    
    const formData = new FormData();
    formData.append('content', content);
    if (replyToId) formData.append('reply_to', replyToId);
    if (selectedFile) formData.append('file', selectedFile);
    
    // Show sending state
    document.getElementById('sendBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/users/{{ other_user.username }}/message/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: selectedFile ? formData : JSON.stringify({ 
            content: content,
            reply_to: replyToId 
        }),
        ...(selectedFile ? {} : { headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }})
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('sendBtn').innerHTML = '<i class="fas fa-paper-plane"></i>';
        
        if (data.success) {
            addMessageToList(data.message, true);
            input.value = '';
            cancelReply();
            cancelFileUpload();
            scrollToBottom();
            lastMessageId = data.message.id;
        } else {
            alert(data.error || 'Xatolik yuz berdi');
        }
    })
    .catch(err => {
        document.getElementById('sendBtn').innerHTML = '<i class="fas fa-paper-plane"></i>';
        console.error(err);
    });
}

// Add message to list
function addMessageToList(msg, isMine) {
    const emptyChat = document.getElementById('emptyChat');
    if (emptyChat) emptyChat.remove();
    
    let messagesList = document.getElementById('messagesList');
    if (!messagesList) {
        const container = document.getElementById('chatContainer');
        messagesList = document.createElement('div');
        messagesList.id = 'messagesList';
        messagesList.className = 'messages-list';
        container.appendChild(messagesList);
    }
    
    const messageEl = document.createElement('div');
    messageEl.className = `message ${isMine ? 'sent' : 'received'}`;
    messageEl.dataset.id = msg.id;
    
    let contentHtml = '';
    
    if (msg.is_image && msg.file_url) {
        contentHtml += `<div class="message-image"><img src="${msg.file_url}" onclick="openImageModal('${msg.file_url}')"></div>`;
    } else if (msg.file_url) {
        contentHtml += `
            <div class="message-file">
                <i class="fas fa-file"></i>
                <div class="file-info">
                    <span class="file-name">${msg.file_name}</span>
                    <span class="file-size">${msg.file_size}</span>
                </div>
                <a href="${msg.file_url}" download class="file-download"><i class="fas fa-download"></i></a>
            </div>`;
    }
    
    if (msg.content) {
        contentHtml += `<div class="message-content">${msg.content}</div>`;
    }
    
    messageEl.innerHTML = `
        ${contentHtml}
        <div class="message-meta">
            <span class="message-time">${msg.created_at}</span>
            ${isMine ? '<span class="message-status"><i class="fas fa-check"></i></span>' : ''}
        </div>
        ${isMine ? `<div class="message-actions"><button onclick="showMessageMenu(${msg.id})" class="action-btn"><i class="fas fa-ellipsis-v"></i></button></div>` : ''}
    `;
    
    messagesList.appendChild(messageEl);
}

// Poll for new messages
function pollMessages() {
    fetch(`/api/chat/{{ other_user.username }}/new/?last_id=${lastMessageId}`)
    .then(response => response.json())
    .then(data => {
        // Add new messages
        data.messages.forEach(msg => {
            addMessageToList(msg, false);
            lastMessageId = Math.max(lastMessageId, msg.id);
        });
        
        if (data.messages.length > 0) {
            scrollToBottom();
        }
        
        // Update status
        const statusText = document.getElementById('statusText');
        const typingIndicator = document.getElementById('typingIndicator');
        
        if (data.other_user.is_typing) {
            typingIndicator.style.display = 'block';
            statusText.parentElement.style.display = 'none';
        } else {
            typingIndicator.style.display = 'none';
            statusText.parentElement.style.display = 'block';
            if (data.other_user.is_online) {
                statusText.innerHTML = '<i class="fas fa-circle online-dot"></i> Online';
            } else if (data.other_user.last_seen) {
                statusText.textContent = data.other_user.last_seen;
            }
        }
    })
    .catch(err => console.error('Polling error:', err));
}

// Start polling
setInterval(pollMessages, 2000);

// File handling
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('Fayl hajmi 10MB dan oshmasligi kerak');
        return;
    }
    
    selectedFile = file;
    const preview = document.getElementById('filePreview');
    preview.style.display = 'flex';
    
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreviewThumb').src = e.target.result;
            document.getElementById('imagePreviewThumb').style.display = 'block';
            document.getElementById('filePreviewInfo').style.display = 'none';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('imagePreviewThumb').style.display = 'none';
        document.getElementById('filePreviewInfo').style.display = 'flex';
        document.getElementById('filePreviewName').textContent = file.name;
    }
}

function cancelFileUpload() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('filePreview').style.display = 'none';
}

// Reply
function replyToMessage() {
    if (!selectedMessageId) return;
    
    const messageEl = document.querySelector(`.message[data-id="${selectedMessageId}"]`);
    const content = messageEl.querySelector('.message-content')?.textContent || 'Fayl';
    
    replyToId = selectedMessageId;
    document.getElementById('replyText').textContent = content.substring(0, 50);
    document.getElementById('replyPreview').style.display = 'flex';
    
    hideMessageMenu();
    document.getElementById('messageInput').focus();
}

function cancelReply() {
    replyToId = null;
    document.getElementById('replyPreview').style.display = 'none';
}

// Message menu
function showMessageMenu(messageId) {
    selectedMessageId = messageId;
    const menu = document.getElementById('messageMenu');
    const messageEl = document.querySelector(`.message[data-id="${messageId}"]`);
    const rect = messageEl.getBoundingClientRect();
    
    menu.style.display = 'block';
    menu.style.top = `${rect.top}px`;
    menu.style.right = '20px';
}

function hideMessageMenu() {
    document.getElementById('messageMenu').style.display = 'none';
    selectedMessageId = null;
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.message-menu') && !e.target.closest('.action-btn')) {
        hideMessageMenu();
    }
});

// Delete message
function deleteMessage(forEveryone) {
    if (!selectedMessageId) return;
    
    const confirmText = forEveryone ? 
        "Xabar hammadan o'chiriladi. Davom etasizmi?" : 
        "Xabar faqat sizdan o'chiriladi. Davom etasizmi?";
    
    if (!confirm(confirmText)) return;
    
    fetch(`/api/messages/${selectedMessageId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ delete_for_everyone: forEveryone })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageEl = document.querySelector(`.message[data-id="${selectedMessageId}"]`);
            if (data.deleted_for_everyone) {
                messageEl.querySelector('.message-content').innerHTML = '<i class="fas fa-ban"></i> Bu xabar o\'chirildi';
                messageEl.querySelector('.message-content').classList.add('deleted');
                const actions = messageEl.querySelector('.message-actions');
                if (actions) actions.remove();
            } else {
                messageEl.remove();
            }
            hideMessageMenu();
        } else {
            alert(data.error);
        }
    });
}

// Edit message
function editMessage() {
    if (!selectedMessageId) return;
    
    const messageEl = document.querySelector(`.message[data-id="${selectedMessageId}"]`);
    const contentEl = messageEl.querySelector('.message-content');
    const currentText = contentEl.textContent;
    
    const newText = prompt('Xabarni tahrirlash:', currentText);
    if (!newText || newText === currentText) {
        hideMessageMenu();
        return;
    }
    
    fetch(`/api/messages/${selectedMessageId}/edit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: newText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            contentEl.textContent = data.message.content;
            // Add edited indicator
            const meta = messageEl.querySelector('.message-meta');
            if (!meta.querySelector('.message-edited')) {
                const edited = document.createElement('span');
                edited.className = 'message-edited';
                edited.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                meta.insertBefore(edited, meta.firstChild.nextSibling);
            }
            hideMessageMenu();
        } else {
            alert(data.error);
        }
    });
}

// Image modal
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// ==========================================
// EMOJI & STICKER PICKER
// ==========================================

const emojiCategories = {
    smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üòâ', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'üòÆ‚Äçüí®', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'ü•∏', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì', 'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø', 'üíÄ', '‚ò†Ô∏è', 'üí©', 'ü§°', 'üëπ', 'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ'],
    gestures: ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏'],
    hearts: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚ô•Ô∏è', 'ü´∂', 'üíå', 'üíê', 'üåπ', 'ü•Ä', 'üå∑', 'üå∏', 'üíÆ', 'üèµÔ∏è', 'üåª', 'üåº'],
    animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üêª‚Äç‚ùÑÔ∏è', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'ü™±', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü™∞', 'ü™≤', 'ü™≥', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'ü¶£', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'ü¶¨', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêà‚Äç‚¨õ', 'ü™∂', 'üêì', 'ü¶É', 'ü¶§', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶´', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î'],
    food: ['üçï', 'üçî', 'üçü', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü´î', 'ü•ô', 'üßÜ', 'ü•ö', 'üç≥', 'ü•ò', 'üç≤', 'ü´ï', 'ü•£', 'ü•ó', 'üçø', 'üßà', 'üßÇ', 'ü•´', 'üçù', 'üçú', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç°', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'üçØ', 'ü•õ', 'üçº', 'ü´ñ', '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üßã', 'üç∂', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'ü•É', 'üç∏', 'üçπ', 'üßâ', 'üçæ', 'üßä', 'ü•Ñ', 'üç¥', 'üçΩÔ∏è', 'ü•¢', 'ü•°', 'üçá', 'üçà', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçë', 'üçí', 'üçì', 'ü´ê', 'ü•ù', 'üçÖ', 'ü´í', 'ü••', 'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ', 'üå∂Ô∏è', 'ü´ë', 'ü•í', 'ü•¨', 'ü•¶', 'üßÑ', 'üßÖ', 'üçÑ', 'ü•ú', 'ü´ò', 'üå∞'],
    activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõº', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è', 'ü§º', 'ü§∏', 'ü§∫', '‚õπÔ∏è', 'ü§æ', 'üèåÔ∏è', 'üèá', 'üßò', 'üèÑ', 'üèä', 'ü§Ω', 'üö£', 'üßó', 'üöµ', 'üö¥', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 'üèµÔ∏è', 'üéóÔ∏è', 'üé´', 'üéüÔ∏è', 'üé™', 'ü§π', 'üé≠', 'ü©∞', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'ü™ò', 'üé∑', 'üé∫', 'ü™ó', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è', 'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©'],
    objects: ['üí°', 'üî¶', 'üèÆ', 'ü™î', 'üì±', 'üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßÆ', 'üé•', 'üéûÔ∏è', 'üìΩÔ∏è', 'üé¨', 'üì∫', 'üì∑', 'üì∏', 'üìπ', 'üìº', 'üîç', 'üîé', 'üïØÔ∏è', 'üí∞', 'üí¥', 'üíµ', 'üí∂', 'üí∑', 'ü™ô', 'üí≥', 'üíé', '‚öñÔ∏è', 'ü™ú', 'üß∞', 'ü™õ', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'ü™ö', 'üî©', '‚öôÔ∏è', 'ü™§', 'üß±', '‚õìÔ∏è', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', 'ü™¶', '‚ö±Ô∏è', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'ü©∏', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°Ô∏è', 'üßπ', 'ü™†', 'üß∫', 'üßª', 'üöΩ', 'üö∞', 'üöø', 'üõÅ', 'üõÄ', 'üßº', 'ü™•', 'ü™í', 'üßΩ', 'ü™£', 'üß¥', 'üõéÔ∏è', 'üîë', 'üóùÔ∏è', 'üö™', 'ü™ë', 'üõãÔ∏è', 'üõèÔ∏è', 'üõå', 'üß∏', 'ü™Ü', 'üñºÔ∏è', 'ü™û', 'ü™ü', 'üõçÔ∏è', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'ü™Ñ', 'ü™Ö', 'üéä', 'üéâ', 'üéé', 'üèÆ', 'üéê', 'üßß', '‚úâÔ∏è', 'üì©', 'üì®', 'üìß', 'üíå', 'üì•', 'üì§', 'üì¶', 'üè∑Ô∏è', 'ü™ß', 'üì™', 'üì´', 'üì¨', 'üì≠', 'üìÆ', 'üìØ', 'üìú', 'üìÉ', 'üìÑ', 'üìë', 'üßæ', 'üìä', 'üìà', 'üìâ', 'üóíÔ∏è', 'üóìÔ∏è', 'üìÜ', 'üìÖ', 'üóëÔ∏è', 'üìá', 'üóÉÔ∏è', 'üó≥Ô∏è', 'üóÑÔ∏è', 'üìã', 'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üóûÔ∏è', 'üì∞', 'üìì', 'üìî', 'üìí', 'üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîñ', 'üß∑', 'üîó', 'üìé', 'üñáÔ∏è', 'üìê', 'üìè', 'üßÆ', 'üìå', 'üìç', '‚úÇÔ∏è', 'üñäÔ∏è', 'üñãÔ∏è', '‚úíÔ∏è', 'üñåÔ∏è', 'üñçÔ∏è', 'üìù', '‚úèÔ∏è', 'üîç', 'üîé', 'üîè', 'üîê', 'üîí', 'üîì'],
    symbols: ['üíØ', 'üí¢', 'üí¨', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üóØÔ∏è', 'üí≠', 'üí§', 'üíÆ', '‚ô®Ô∏è', 'üíà', 'üõë', 'üïõ', 'üïß', 'üïê', 'üïú', 'üïë', 'üïù', 'üïí', 'üïû', 'üïì', 'üïü', 'üïî', 'üï†', 'üïï', 'üï°', 'üïñ', 'üï¢', 'üïó', 'üï£', 'üïò', 'üï§', 'üïô', 'üï•', 'üïö', 'üï¶', 'üåÄ', '‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è', 'üÉè', 'üÄÑ', 'üé¥', 'üîá', 'üîà', 'üîâ', 'üîä', 'üì¢', 'üì£', 'üìØ', 'üîî', 'üîï', 'üéµ', 'üé∂', 'üíπ', 'üèß', 'üöÆ', 'üö∞', '‚ôø', 'üöπ', 'üö∫', 'üöª', 'üöº', 'üöæ', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', '‚ö†Ô∏è', 'üö∏', '‚õî', 'üö´', 'üö≥', 'üö≠', 'üöØ', 'üö±', 'üö∑', 'üìµ', 'üîû', '‚ò¢Ô∏è', '‚ò£Ô∏è', '‚¨ÜÔ∏è', '‚ÜóÔ∏è', '‚û°Ô∏è', '‚ÜòÔ∏è', '‚¨áÔ∏è', '‚ÜôÔ∏è', '‚¨ÖÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü©Ô∏è', '‚Ü™Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÉ', 'üîÑ', 'üîô', 'üîö', 'üîõ', 'üîú', 'üîù', 'üõê', '‚öõÔ∏è', 'üïâÔ∏è', '‚ú°Ô∏è', '‚ò∏Ô∏è', '‚òØÔ∏è', '‚úùÔ∏è', '‚ò¶Ô∏è', '‚ò™Ô∏è', '‚òÆÔ∏è', 'üïé', 'üîØ', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', '‚õé', 'üîÄ', 'üîÅ', 'üîÇ', '‚ñ∂Ô∏è', '‚è©', '‚è≠Ô∏è', '‚èØÔ∏è', '‚óÄÔ∏è', '‚è™', '‚èÆÔ∏è', 'üîº', '‚è´', 'üîΩ', '‚è¨', '‚è∏Ô∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚èèÔ∏è', 'üé¶', 'üîÖ', 'üîÜ', 'üì∂', 'üì≥', 'üì¥', '‚ôÄÔ∏è', '‚ôÇÔ∏è', '‚ößÔ∏è', '‚úñÔ∏è', '‚ûï', '‚ûñ', '‚ûó', 'üü∞', '‚ôæÔ∏è', '‚ÄºÔ∏è', '‚ÅâÔ∏è', '‚ùì', '‚ùî', '‚ùï', '‚ùó', '„Ä∞Ô∏è', 'üí±', 'üí≤', '‚öïÔ∏è', '‚ôªÔ∏è', '‚öúÔ∏è', 'üî±', 'üìõ', 'üî∞', '‚≠ï', '‚úÖ', '‚òëÔ∏è', '‚úîÔ∏è', '‚ùå', '‚ùé', '‚û∞', '‚ûø', '„ÄΩÔ∏è', '‚ú≥Ô∏è', '‚ú¥Ô∏è', '‚ùáÔ∏è', '¬©Ô∏è', '¬ÆÔ∏è', '‚Ñ¢Ô∏è', '#Ô∏è‚É£', '*Ô∏è‚É£', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî†', 'üî°', 'üî¢', 'üî£', 'üî§', 'üÖ∞Ô∏è', 'üÜé', 'üÖ±Ô∏è', 'üÜë', 'üÜí', 'üÜì', '‚ÑπÔ∏è', 'üÜî', '‚ìÇÔ∏è', 'üÜï', 'üÜñ', 'üÖæÔ∏è', 'üÜó', 'üÖøÔ∏è', 'üÜò', 'üÜô', 'üÜö', 'üàÅ', 'üàÇÔ∏è', 'üà∑Ô∏è', 'üà∂', 'üàØ', 'üâê', 'üàπ', 'üàö', 'üà≤', 'üâë', 'üà∏', 'üà¥', 'üà≥', '„äóÔ∏è', '„äôÔ∏è', 'üà∫', 'üàµ', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', 'üü§', '‚ö´', '‚ö™', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', 'üü´', '‚¨õ', '‚¨ú', '‚óºÔ∏è', '‚óªÔ∏è', '‚óæ', '‚óΩ', '‚ñ™Ô∏è', '‚ñ´Ô∏è', 'üî∂', 'üî∑', 'üî∏', 'üîπ', 'üî∫', 'üîª', 'üí†', 'üîò', 'üî≥', 'üî≤']
};

const stickers = [
    // Katta stikerlar
    'üéâ', 'ü•≥', 'üéä', 'üéÅ', 'üéà', 'üéÇ', 'üç∞', 'üéÉ',
    'üíñ', 'üíù', 'üíò', 'üíï', 'üíû', '‚ù§Ô∏è‚Äçüî•', 'üíó', 'üíì',
    'ü§ó', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòª', 'üíã', 'üëÑ',
    'üëç', 'üëè', 'üôå', 'üí™', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò',
    'üòÇ', 'ü§£', 'üòπ', 'üíÄ', 'ü§°', 'üëª', 'üé≠', 'üÉè',
    'üî•', '‚ö°', 'üí•', '‚ú®', 'üåü', 'üí´', 'üåà', 'ü¶ã',
    'üåπ', 'üå∏', 'üå∫', 'üåª', 'üå∑', 'üíê', 'ü™ª', 'üåº',
    'üçï', 'üçî', 'üåÆ', 'üç¶', 'üç©', 'üç™', 'üßÅ', 'üç´',
    '‚òï', 'üßã', 'üçµ', 'ü•§', 'üç∫', 'üç∑', 'ü•Ç', 'üçæ',
    'üéÆ', 'üéØ', 'üé≤', 'üé∏', 'üé§', 'üéß', 'üé¨', 'üé®',
    'üöÄ', '‚úàÔ∏è', 'üåç', 'üè†', '‚≠ê', 'üåô', '‚òÄÔ∏è', 'üå§Ô∏è',
    'üò¥', 'üí§', 'ü•±', 'üò™', 'üåõ', 'üåú', 'üõå', 'üõèÔ∏è',
    'üíª', 'üì±', '‚åö', 'üì∑', 'üé•', 'üí°', 'üîî', 'üìß',
    '‚úÖ', '‚ùå', '‚ö†Ô∏è', '‚ùì', '‚ùó', 'üíØ', 'üÜó', 'üÜí',
    'üê∂', 'üê±', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'ü¶Å',
    'ü¶Ñ', 'üê≤', 'ü¶ã', 'üêù', 'ü¶Ä', 'üêô', 'ü¶à', 'üê¨'
];

let currentEmojiCategory = 'smileys';

// Emoji picker ochish/yopish
function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.classList.toggle('show');
    if (picker.classList.contains('show')) {
        renderEmojis();
        renderStickers();
    }
}

// Tashqari bosganda yopish
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    const emojiBtn = document.querySelector('.emoji-btn');
    if (!picker.contains(e.target) && !emojiBtn.contains(e.target)) {
        picker.classList.remove('show');
    }
});

// Tab almashtirish
function switchEmojiTab(tab) {
    document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    event.target.classList.add('active');
    
    if (tab === 'emoji') {
        document.getElementById('emojiTab').classList.add('active');
    } else {
        document.getElementById('stickerTab').classList.add('active');
    }
}

// Emoji kategoriya almashtirish
function showEmojiCategory(category) {
    currentEmojiCategory = category;
    document.querySelectorAll('.emoji-category-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderEmojis();
}

// Emoji'larni render qilish
function renderEmojis() {
    const grid = document.getElementById('emojiGrid');
    const emojis = emojiCategories[currentEmojiCategory] || [];
    grid.innerHTML = emojis.map(emoji => 
        `<span class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</span>`
    ).join('');
}

// Stikerlarni render qilish
function renderStickers() {
    const grid = document.getElementById('stickerGrid');
    grid.innerHTML = stickers.map(sticker => 
        `<span class="sticker-item" onclick="sendSticker('${sticker}')">${sticker}</span>`
    ).join('');
}

// Emoji qo'shish
function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const text = input.value;
    input.value = text.substring(0, start) + emoji + text.substring(end);
    input.selectionStart = input.selectionEnd = start + emoji.length;
    input.focus();
}

// Stiker yuborish (katta emoji sifatida)
function sendSticker(sticker) {
    document.getElementById('messageInput').value = sticker;
    sendMessage();
    document.getElementById('emojiPicker').classList.remove('show');
}

// Update online status periodically
setInterval(() => {
    fetch('/api/online-status/');
}, 30000);
</script>
{% endblock %}
