{% extends "blog/boshlash.html" %}
{% load static %}

{% block title %}Xabarlar | Cloudstore{% endblock %}

{% block page_title %}Xabarlar{% endblock %}

{% block extra_styles %}
    /* ========== TELEGRAM WEB K DESIGN ========== */
    :root {
        --tg-blue: #3390ec;
        --tg-blue-light: #54a5f0;
        --tg-green: #4fae4e;
        --tg-bg-light: #f4f4f5;
        --tg-bg-chat: #e6ebee;
        --tg-sidebar-bg: #ffffff;
        --tg-msg-out: #effdde;
        --tg-msg-in: #ffffff;
        --tg-text-primary: #000000;
        --tg-text-secondary: #707579;
        --tg-border: #e5e5e5;
    }
    
    /* Dark mode */
    @media (prefers-color-scheme: dark) {
        :root {
            --tg-blue: #3390ec;
            --tg-bg-light: #212121;
            --tg-bg-chat: #0e0e0e;
            --tg-sidebar-bg: #212121;
            --tg-msg-out: #2b5278;
            --tg-msg-in: #212121;
            --tg-text-primary: #ffffff;
            --tg-text-secondary: #aaaaaa;
            --tg-border: #2f2f2f;
        }
    }
    
    /* ========== HIDE MAIN SIDEBAR ========== */
    .sidebar, .sidebar-overlay, .menu-toggle-btn, .page-header, .messages-container {
        display: none !important;
    }
    
    .app-container {
        display: block !important;
    }
    
    .main-content {
        width: 100% !important;
        margin-left: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        height: 100vh !important;
    }
    
    .content-area {
        padding: 0 !important;
        margin: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
    }
    
    /* ========== TELEGRAM CHAT LAYOUT ========== */
    .telegram-chat-container {
        display: flex;
        height: 100vh;
        background: var(--tg-bg-chat);
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }
    
    /* ========== CHAT SIDEBAR (Foydalanuvchilar ro'yxati) ========== */
    .chat-sidebar {
        width: 420px;
        max-width: 30vw;
        min-width: 320px;
        background: var(--tg-sidebar-bg);
        border-right: 1px solid var(--tg-border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    
    .chat-sidebar-header {
        padding: 8px 13px;
        border-bottom: 1px solid var(--tg-border);
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 56px;
    }
    
    .home-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: var(--tg-blue);
        border: none;
        color: white;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        flex-shrink: 0;
    }
    
    .home-btn:hover {
        background: var(--tg-blue-light);
    }
    
    .chat-search-box {
        flex: 1;
        position: relative;
    }
    
    .chat-search-box input {
        width: 100%;
        padding: 10px 15px 10px 42px;
        border: none;
        border-radius: 22px;
        background: var(--tg-bg-light);
        color: var(--tg-text-primary);
        font-size: 15px;
        transition: all 0.2s;
    }
    
    .chat-search-box input:focus {
        outline: none;
        background: var(--tg-bg-light);
        box-shadow: 0 0 0 2px rgba(51, 144, 236, 0.3);
    }
    
    .chat-search-box i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--tg-text-secondary);
        font-size: 15px;
    }
    
    .new-chat-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: transparent;
        border: none;
        color: var(--tg-text-secondary);
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.15s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .new-chat-btn:hover {
        background: rgba(51, 144, 236, 0.08);
        color: var(--tg-blue);
    }
    
    /* Search Clear Button */
    .search-clear-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--tg-text-secondary);
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        transition: all 0.15s;
    }
    
    .search-clear-btn:hover {
        background: rgba(0,0,0,0.08);
        color: var(--tg-text-primary);
    }
    
    /* Search Results Section */
    .search-results-section {
        border-bottom: 1px solid var(--tg-border);
    }
    
    .search-results-header {
        padding: 12px 16px 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .search-results-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--tg-blue);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .search-results-count {
        font-size: 12px;
        background: var(--tg-blue);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
    }
    
    .search-results-list {
        max-height: 300px;
        overflow-y: auto;
        padding: 0 8px 8px;
    }
    
    .search-result-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.15s;
        text-decoration: none;
        color: var(--tg-text-primary);
    }
    
    .search-result-item:hover {
        background: rgba(51, 144, 236, 0.08);
    }
    
    .search-result-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }
    
    .search-result-avatar.default {
        background: linear-gradient(135deg, #54a5f0 0%, #3390ec 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
        font-size: 1rem;
    }
    
    .search-result-info {
        flex: 1;
        min-width: 0;
    }
    
    .search-result-name {
        font-weight: 500;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .search-result-username {
        font-size: 13px;
        color: var(--tg-text-secondary);
    }
    
    .search-result-bio {
        font-size: 12px;
        color: var(--tg-text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
    }
    
    .search-result-stats {
        font-size: 11px;
        color: var(--tg-text-secondary);
        margin-top: 2px;
    }
    
    .search-follow-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: var(--tg-blue);
        color: white;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    
    .search-follow-btn:hover {
        background: #1c8de4;
    }
    
    .search-follow-btn.following {
        background: var(--tg-green);
    }
    
    .search-follow-btn.following:hover {
        background: #d44;
    }

    .online-indicator {
        width: 8px;
        height: 8px;
        background: var(--tg-green);
        border-radius: 50%;
    }
    
    .search-loading {
        text-align: center;
        padding: 20px;
        color: var(--tg-text-secondary);
    }
    
    .search-loading i {
        font-size: 1.5rem;
        margin-bottom: 8px;
        color: var(--tg-blue);
    }
    
    .search-no-results {
        text-align: center;
        padding: 30px 20px;
        color: var(--tg-text-secondary);
    }
    
    .search-no-results i {
        font-size: 2.5rem;
        opacity: 0.3;
        margin-bottom: 12px;
    }
    
    /* Search Filter Tabs */
    .search-filter-tabs {
        display: flex;
        overflow-x: auto;
        padding: 8px;
        gap: 6px;
        border-bottom: 1px solid var(--tg-border);
        scrollbar-width: none;
    }
    
    .search-filter-tabs::-webkit-scrollbar {
        display: none;
    }
    
    .search-filter-tab {
        flex-shrink: 0;
        padding: 6px 12px;
        border-radius: 16px;
        border: none;
        background: var(--tg-bg-light);
        color: var(--tg-text-secondary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .search-filter-tab:hover {
        background: rgba(51, 144, 236, 0.1);
        color: var(--tg-blue);
    }
    
    .search-filter-tab.active {
        background: var(--tg-blue);
        color: white;
    }
    
    .search-filter-tab i {
        font-size: 11px;
    }

    /* Settings Panel */
    .settings-panel {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--tg-sidebar-bg);
        z-index: 100;
        overflow-y: auto;
        animation: slideInRight 0.2s ease;
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    .settings-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid var(--tg-border);
        font-weight: 600;
        font-size: 17px;
    }
    
    .settings-back-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--tg-text-secondary);
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .settings-back-btn:hover {
        background: rgba(0,0,0,0.04);
        color: var(--tg-blue);
    }
    
    .settings-content {
        padding: 8px 0;
    }
    
    .settings-section {
        padding: 8px 0;
    }
    
    .settings-title {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        color: var(--tg-blue);
        text-transform: uppercase;
    }
    
    .settings-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        color: var(--tg-text-primary);
    }
    
    .settings-item.clickable {
        cursor: pointer;
        transition: background 0.15s;
    }
    
    .settings-item.clickable:hover {
        background: rgba(0,0,0,0.04);
    }
    
    .settings-item span:first-child {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .settings-item i {
        width: 20px;
        text-align: center;
        color: var(--tg-text-secondary);
    }
    
    .settings-value {
        color: var(--tg-text-secondary);
        font-size: 14px;
    }
    
    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: var(--tg-blue);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }
    
    /* Chats Section */
    .chats-section {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Chat List */
    .chat-user-list {
        flex: 1;
        overflow-y: auto;
        padding: 0 8px;
    }
    
    .chat-user-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-user-list::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.15);
        border-radius: 3px;
    }
    
    .chat-user-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 9px 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.15s;
        text-decoration: none;
        color: var(--tg-text-primary);
        margin: 0;
    }
    
    .chat-user-item:hover {
        background: rgba(0,0,0,0.04);
    }
    
    .chat-user-item.active {
        background: var(--tg-blue);
        color: white;
    }
    
    .chat-user-item.active .msg-time,
    .chat-user-item.active .last-msg {
        color: rgba(255,255,255,0.8);
    }
    
    .chat-user-item.active .unread-count {
        background: white;
        color: var(--tg-blue);
    }
    
    .user-avatar {
        width: 54px;
        height: 54px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        position: relative;
    }
    
    .user-avatar.default {
        background: linear-gradient(135deg, #54a5f0 0%, #3390ec 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
        font-size: 1.25rem;
    }
    
    .user-avatar .online-dot {
        position: absolute;
        bottom: 1px;
        right: 1px;
        width: 14px;
        height: 14px;
        background: var(--tg-green);
        border: 2px solid var(--tg-sidebar-bg);
        border-radius: 50%;
    }
    
    .user-info {
        flex: 1;
        min-width: 0;
    }
    
    .user-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2px;
    }
    
    .user-name {
        font-weight: 500;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .msg-time {
        font-size: 12px;
        color: var(--tg-text-secondary);
        flex-shrink: 0;
    }
    
    .user-bottom-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .last-msg {
        flex: 1;
        font-size: 14px;
        color: var(--tg-text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .unread-count {
        background: var(--tg-blue);
        color: white;
        font-size: 12px;
        font-weight: 500;
        padding: 2px 7px;
        border-radius: 12px;
        min-width: 22px;
        text-align: center;
    }
    
    .empty-chats {
        text-align: center;
        padding: 60px 20px;
        color: var(--tg-text-secondary);
    }
    
    .empty-chats i {
        font-size: 4rem;
        opacity: 0.15;
        margin-bottom: 20px;
        color: var(--tg-blue);
    }
    
    .empty-chats a {
        color: var(--tg-blue);
        text-decoration: none;
        margin-top: 15px;
        display: inline-block;
        font-weight: 500;
    }
    
    /* ========== MAIN CHAT AREA ========== */
    .chat-main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--tg-bg-chat);
        position: relative;
        height: 100vh;
        min-height: 0;
        overflow: hidden;
    }
    
    /* Telegram-style chat background pattern */
    .chat-main-area::before {
        content: '';
        position: absolute;
        inset: 0;
        background-color: var(--tg-bg-chat);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cdefs%3E%3Cpattern id='pattern' patternUnits='userSpaceOnUse' width='40' height='40' patternTransform='rotate(45)'%3E%3Crect width='100%25' height='100%25' fill='%23e6ebee'/%3E%3Ccircle cx='20' cy='20' r='1.5' fill='%23d9dfe6' fill-opacity='0.4'/%3E%3C/pattern%3E%3C/defs%3E%3Crect fill='url(%23pattern)' width='100%25' height='100%25'/%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 0;
    }
    
    /* Chat Header - Telegram style */
    .chat-header {
        padding: 8px 16px;
        background: var(--tg-sidebar-bg);
        border-bottom: 1px solid var(--tg-border);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 10;
        min-height: 56px;
    }
    
    .back-btn {
        display: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: transparent;
        border: none;
        color: var(--tg-text-secondary);
        font-size: 1.2rem;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }
    
    .back-btn:hover {
        background: rgba(0,0,0,0.04);
        color: var(--tg-blue);
    }
    
    .chat-partner-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .chat-partner-avatar.default {
        background: linear-gradient(135deg, #54a5f0 0%, #3390ec 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
    }
    
    .chat-partner-info {
        flex: 1;
    }
    
    .chat-partner-name {
        font-weight: 500;
        font-size: 16px;
        color: var(--tg-text-primary);
    }
    
    .chat-partner-status {
        font-size: 14px;
        color: var(--tg-blue);
    }
    
    .chat-partner-status.offline {
        color: var(--tg-text-secondary);
    }
    
    .chat-actions {
        display: flex;
        gap: 4px;
    }
    
    .chat-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--tg-text-secondary);
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.15s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chat-action-btn:hover {
        background: rgba(0,0,0,0.04);
        color: var(--tg-blue);
    }
    
    /* Messages Area - Telegram style */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 12px 8%;
        display: flex;
        flex-direction: column;
        gap: 4px;
        z-index: 1;
        min-height: 0;
        background-color: #0e0e0e;
        background-image: 
            radial-gradient(circle at 20% 80%, rgba(51, 144, 236, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(79, 174, 78, 0.06) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(51, 144, 236, 0.04) 0%, transparent 30%),
            url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%233390ec' fill-opacity='0.03'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.15);
        border-radius: 3px;
    }
    
    /* Message Bubbles - Telegram style */
    .message-bubble {
        max-width: 480px;
        padding: 7px 12px 8px;
        border-radius: 12px;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    
    .message-bubble.sent {
        align-self: flex-end;
        background: var(--tg-msg-out);
        color: var(--tg-text-primary);
        border-bottom-right-radius: 4px;
    }
    
    .message-bubble.received {
        align-self: flex-start;
        background: var(--tg-msg-in);
        color: var(--tg-text-primary);
        border-bottom-left-radius: 4px;
    }
    
    .message-content {
        font-size: 15px;
        line-height: 1.35;
    }
    
    .message-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
        margin-top: 2px;
        font-size: 12px;
        color: var(--tg-text-secondary);
    }
    
    .message-bubble.sent .message-footer {
        color: #4fae4e;
    }
    
    .message-status .read {
        color: var(--tg-green);
    }
    
    .message-bubble.sent .message-status i {
        color: var(--tg-green);
    }
    
    /* Typing Indicator */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        color: var(--tg-text-secondary);
        font-size: 14px;
        z-index: 1;
    }
    
    .typing-indicator.show {
        display: flex;
    }
    
    .typing-dots span {
        width: 7px;
        height: 7px;
        background: var(--tg-blue);
        border-radius: 50%;
        animation: typingAnim 1.4s infinite;
        display: inline-block;
        margin-right: 3px;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnim {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-6px); opacity: 1; }
    }
    
    /* ========== INPUT AREA - Telegram style ========== */
    .chat-input-area {
        padding: 8px 8% 12px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
        background: transparent;
        z-index: 100;
        flex-shrink: 0;
        position: sticky;
        bottom: 0;
    }
    
    /* File Preview */
    .file-preview-container {
        display: none;
        padding: 10px 14px;
        background: var(--tg-sidebar-bg);
        border-radius: 12px;
        margin-bottom: 8px;
        align-items: center;
        gap: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .file-preview-container.show {
        display: flex;
    }
    
    .file-preview-image {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        object-fit: cover;
    }
    
    .file-preview-icon {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        background: var(--tg-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.4rem;
    }
    
    .file-preview-info {
        flex: 1;
    }
    
    .file-preview-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 2px;
        word-break: break-all;
        color: var(--tg-text-primary);
    }
    
    .file-preview-size {
        font-size: 13px;
        color: var(--tg-text-secondary);
    }
    
    .file-preview-remove {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(244, 67, 54, 0.1);
        border: none;
        color: #f44336;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.15s;
    }
    
    .file-preview-remove:hover {
        background: rgba(244, 67, 54, 0.2);
    }
    
    .input-container {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        background: var(--tg-sidebar-bg);
        border-radius: 22px;
        padding: 4px 6px;
        box-shadow: 0 1px 8px rgba(0,0,0,0.08);
    }
    
    .input-actions {
        display: flex;
        align-items: center;
    }
    
    .input-btn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--tg-text-secondary);
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.15s;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .input-btn:hover {
        color: var(--tg-blue);
        background: rgba(51, 144, 236, 0.08);
    }
    
    .chat-textarea {
        flex: 1;
        border: none;
        background: none;
        padding: 8px 4px;
        font-size: 15px;
        color: var(--tg-text-primary);
        resize: none;
        max-height: 150px;
        line-height: 1.4;
        min-height: 38px;
    }
    
    .chat-textarea:focus {
        outline: none;
    }
    
    .chat-textarea::placeholder {
        color: var(--tg-text-secondary);
    }
    
    .send-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: var(--tg-blue);
        border: none;
        color: white;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.15s;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .send-btn:hover {
        background: var(--tg-blue-light);
    }
    
    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Message Media Styles - Telegram style */
    .message-image {
        max-width: 320px;
        max-height: 320px;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.15s;
    }
    
    .message-image:hover {
        transform: scale(1.01);
    }
    
    .message-video {
        max-width: 320px;
        max-height: 280px;
        border-radius: 10px;
    }
    
    .message-file {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: rgba(0,0,0,0.04);
        border-radius: 10px;
        text-decoration: none;
        color: inherit;
        min-width: 200px;
    }
    
    .message-bubble.sent .message-file {
        background: rgba(0,0,0,0.06);
    }
    
    .message-file-icon {
        width: 44px;
        height: 44px;
        background: var(--tg-blue);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: white;
    }
    
    .message-file-info {
        flex: 1;
    }
    
    .message-file-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 2px;
    }
    
    .message-file-size {
        font-size: 12px;
        color: var(--tg-text-secondary);
    }
    
    .message-bubble.sent .message-file-size {
        color: var(--tg-green);
        opacity: 0.8;
    }
    
    /* Image Viewer Modal */
    .image-viewer {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.92);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }
    
    .image-viewer.show {
        display: flex;
    }
    
    .image-viewer img {
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 4px;
    }
    
    .image-viewer-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        font-size: 1.4rem;
        cursor: pointer;
        transition: background 0.15s;
    }
    
    .image-viewer-close:hover {
        background: rgba(255,255,255,0.2);
    }
    
    /* ========== EMPTY CHAT STATE ========== */
    .empty-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--tg-text-secondary);
        z-index: 1;
    }
    
    .empty-chat i {
        font-size: 5rem;
        opacity: 0.15;
        margin-bottom: 25px;
        color: var(--tg-blue);
    }
    
    .empty-chat h3 {
        margin-bottom: 8px;
        font-size: 1.25rem;
        font-weight: 500;
    }
    
    .empty-chat p {
        opacity: 0.8;
        font-size: 14px;
    }
    
    /* ========== EMOJI PICKER - Telegram style ========== */
    .emoji-picker-container {
        position: absolute;
        bottom: 70px;
        right: 8%;
        width: 340px;
        max-height: 380px;
        background: var(--tg-sidebar-bg);
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        display: none;
        z-index: 100;
        overflow: hidden;
    }
    
    .emoji-picker-container.show {
        display: block;
        animation: slideUp 0.15s ease;
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .emoji-header {
        display: flex;
        border-bottom: 1px solid var(--tg-border);
    }
    
    .emoji-tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: none;
        color: var(--tg-text-secondary);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.15s;
    }
    
    .emoji-tab-btn.active {
        color: var(--tg-blue);
        border-bottom: 2px solid var(--tg-blue);
    }
    
    .emoji-category-nav {
        display: flex;
        padding: 8px;
        gap: 4px;
        border-bottom: 1px solid var(--tg-border);
        overflow-x: auto;
    }
    
    .emoji-cat-btn {
        padding: 8px;
        border: none;
        background: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.15rem;
        transition: all 0.15s;
    }
    
    .emoji-cat-btn:hover,
    .emoji-cat-btn.active {
        background: rgba(51, 144, 236, 0.1);
    }
    
    .emoji-grid-content {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        padding: 8px;
        max-height: 220px;
        overflow-y: auto;
    }
    
    .emoji-item {
        padding: 6px;
        text-align: center;
        cursor: pointer;
        border-radius: 6px;
        font-size: 1.35rem;
        transition: all 0.1s;
    }
    
    .emoji-item:hover {
        background: rgba(51, 144, 236, 0.1);
        transform: scale(1.15);
    }
    
    .sticker-grid-content {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 12px;
        max-height: 240px;
        overflow-y: auto;
    }
    
    .sticker-item {
        padding: 12px;
        text-align: center;
        cursor: pointer;
        border-radius: 10px;
        font-size: 2.2rem;
        background: rgba(51, 144, 236, 0.04);
        transition: all 0.15s;
    }
    
    .sticker-item:hover {
        background: rgba(51, 144, 236, 0.12);
        transform: scale(1.05);
    }
    
    .picker-content {
        display: none;
    }
    
    .picker-content.active {
        display: block;
    }
    
    /* ========== MOBILE RESPONSIVE - Telegram style ========== */
    @media (max-width: 768px) {
        .telegram-chat-container {
            position: relative;
        }
        
        .chat-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chat-sidebar.hidden {
            transform: translateX(-100%);
        }
        
        .chat-main-area {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100% !important;
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        .chat-main-area.active {
            transform: translateX(0);
        }
        
        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px 12px 14px;
            z-index: 1001;
            background: var(--tg-bg-chat);
        }
        
        .chat-messages {
            padding: 12px;
            padding-bottom: 80px;
        }
        
        .back-btn {
            display: flex !important;
        }
        
        .chat-header {
            padding: 8px 12px;
        }
        
        .chat-partner-name {
            font-size: 15px;
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 8px 12px;
        }
        
        .message-input-container input {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .emoji-picker-container {
            left: 12px;
            right: 12px;
            width: auto;
            bottom: 70px;
        }
        
        .chat-user-item {
            padding: 10px 12px;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
        }
        
        .input-container {
            padding: 4px;
        }
    }
    
    /* Small phones */
    @media (max-width: 380px) {
        .chat-header {
            padding: 8px 10px;
            gap: 10px;
        }
        
        .emoji-picker-container {
            height: 280px;
        }
        
        .emoji-grid-content, .sticker-grid-content {
            grid-template-columns: repeat(6, 1fr);
        }
        
        .chat-partner-avatar {
            width: 38px;
            height: 38px;
        }
    }
    
    /* ========== PWA / iOS SAFE AREA - Telegram style ========== */
    @supports (padding-top: env(safe-area-inset-top)) {
        .telegram-chat-container {
            height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            padding-top: env(safe-area-inset-top);
        }
        
        .chat-header {
            padding-top: calc(8px + env(safe-area-inset-top));
        }
        
        .chat-sidebar-header {
            padding-top: calc(8px + env(safe-area-inset-top));
        }
        
        .chat-input-area {
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
    }
    
    /* PWA standalone mode uchun */
    @media (display-mode: standalone) {
        .telegram-chat-container {
            height: 100vh;
            height: -webkit-fill-available;
        }
        
        .main-content, .content-area {
            height: 100vh !important;
            height: -webkit-fill-available !important;
        }
    }
    
    /* Klaviatura chiqganda input ko'tarilishi */
    @media (max-height: 500px) {
        .telegram-chat-container {
            height: 100%;
        }
        
        .chat-messages {
            max-height: 50vh;
        }
    }
    
    /* ========== TABLET RESPONSIVE ========== */
    @media (min-width: 769px) and (max-width: 1024px) {
        .chat-sidebar {
            width: 320px;
            min-width: 280px;
        }
        
        .chat-messages {
            padding: 12px 5%;
        }
        
        .chat-input-area {
            padding: 8px 5% 12px;
        }
        
        .emoji-picker-container {
            right: 5%;
        }
    }
{% endblock %}

{% block content %}
<div class="telegram-chat-container">
    <!-- Left: Chat Users List -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <a href="{% url 'boshlash' %}" class="home-btn" title="Bosh sahifa">
                <i class="fas fa-home"></i>
            </a>
            <div class="chat-search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Foydalanuvchilarni qidirish..." id="chatSearchInput" oninput="searchUsers(this.value)">
                <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <button class="new-chat-btn" onclick="toggleSettings()" title="Sozlamalar">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        
        <!-- Search Results Section -->
        <div class="search-results-section" id="searchResultsSection" style="display: none;">
            <div class="search-results-header">
                <span class="search-results-title">Qidiruv natijalari</span>
                <span class="search-results-count" id="searchResultsCount">0</span>
            </div>
            <!-- Filter Tabs -->
            <div class="search-filter-tabs" id="searchFilterTabs">
                <button class="search-filter-tab active" data-tab="all" onclick="setSearchTab('all')">
                    <i class="fas fa-globe"></i> Barchasi
                </button>
                {% if user.is_authenticated %}
                <button class="search-filter-tab" data-tab="discover" onclick="setSearchTab('discover')">
                    <i class="fas fa-compass"></i> Tavsiyalar
                </button>
                <button class="search-filter-tab" data-tab="followers" onclick="setSearchTab('followers')">
                    <i class="fas fa-user-friends"></i> Kuzatuvchilar
                </button>
                <button class="search-filter-tab" data-tab="following" onclick="setSearchTab('following')">
                    <i class="fas fa-heart"></i> Kuzatyapsiz
                </button>
                {% endif %}
            </div>
            <div class="search-results-list" id="searchResultsList">
                <!-- Search results will be inserted here -->
            </div>
        </div>
        
        <!-- Chats Section -->
        <div class="chats-section" id="chatsSection">
            <div class="chat-user-list" id="chatUserList">
                {% for chat in chats %}
                <a href="{% url 'telegram_chat_with_user' chat.user.username %}" 
                   class="chat-user-item {% if active_chat == chat.user.username %}active{% endif %}" 
                   data-name="{{ chat.user.first_name|default:chat.user.username }} {{ chat.user.last_name }}"
                   data-username="{{ chat.user.username }}">
                    <div class="user-avatar {% if not chat.profile.avatar %}default{% endif %}">
                        {% if chat.profile.avatar %}
                        <img src="{{ chat.profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                        {% else %}
                        {{ chat.user.username|first|upper }}
                        {% endif %}
                        {% if chat.profile.is_online %}
                        <span class="online-dot"></span>
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <div class="user-top-row">
                            <span class="user-name">{{ chat.user.first_name|default:chat.user.username }}</span>
                            <span class="msg-time">
                                {% if chat.last_message and chat.last_message.created_at %}
                                {{ chat.last_message.created_at|date:"H:i" }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="user-bottom-row">
                            <span class="last-msg">
                                {% if chat.last_message %}
                                    {% if chat.last_message.sender == user %}Siz: {% endif %}
                                    {{ chat.last_message.content|truncatechars:25 }}
                                {% else %}
                                    Suhbatni boshlang
                                {% endif %}
                            </span>
                            {% if chat.unread_count > 0 %}
                            <span class="unread-count">{{ chat.unread_count }}</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="empty-chats">
                    <i class="fas fa-comments"></i>
                    <p>Hali suhbatlar yo'q</p>
                    <p style="font-size: 13px; margin-top: 10px;">Yuqoridagi qidiruv orqali foydalanuvchi toping</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel" style="display: none;">
            <div class="settings-header">
                <button class="settings-back-btn" onclick="toggleSettings()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span>Sozlamalar</span>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="settings-title">Xabar sozlamalari</div>
                    <div class="settings-item">
                        <span><i class="fas fa-bell"></i> Bildirishnomalar</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notificationsToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <span><i class="fas fa-volume-up"></i> Ovozlar</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundsToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Maxfiylik</div>
                    <div class="settings-item">
                        <span><i class="fas fa-eye"></i> Online holatni ko'rsatish</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="onlineStatusToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <span><i class="fas fa-check-double"></i> O'qilganligini ko'rsatish</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="readReceiptsToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">Ma'lumotlar</div>
                    <div class="settings-item clickable" onclick="clearLocalFiles()">
                        <span><i class="fas fa-trash"></i> Keshni tozalash</span>
                        <span class="settings-value" id="cacheSize">0 MB</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right: Chat Area -->
    <div class="chat-main-area {% if active_user %}active{% endif %}" id="chatMainArea">
        {% if active_user %}
        <!-- Chat Header -->
        <div class="chat-header">
            <button class="back-btn" onclick="goBackToList()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-partner-avatar {% if not active_profile.avatar %}default{% endif %}">
                {% if active_profile.avatar %}
                <img src="{{ active_profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                {% else %}
                {{ active_user.username|first|upper }}
                {% endif %}
            </div>
            <div class="chat-partner-info">
                <div class="chat-partner-name">{{ active_user.first_name|default:active_user.username }} {{ active_user.last_name }}</div>
                <div class="chat-partner-status {% if not active_profile.is_online %}offline{% endif %}" id="userStatus">
                    {% if active_profile.show_online_status %}
                        {% if active_profile.is_online %}Online{% else %}{{ active_profile.get_online_status_display }}{% endif %}
                    {% else %}
                        oxirgi faollik yashirin
                    {% endif %}
                </div>
            </div>
            <div class="chat-actions">
                <a href="{% url 'user_profile' active_user.username %}" class="chat-action-btn" title="Profil">
                    <i class="fas fa-user"></i>
                </a>
            </div>
        </div>
        
        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}" data-id="{{ message.id }}">
                {% if message.message_type == 'image' and message.file %}
                <img src="{{ message.file.url }}" class="message-image" onclick="openFile({{ message.id }}, '{{ message.file.url }}', '{{ message.file_name }}', {{ message.file_size }})" alt="Rasm">
                {% elif message.message_type == 'file' and message.file %}
                <div class="message-file" onclick="openFile({{ message.id }}, '{{ message.file.url }}', '{{ message.file_name }}', {{ message.file_size }})" style="cursor: pointer;">
                    <div class="message-file-icon"><i class="fas fa-file"></i></div>
                    <div class="message-file-info">
                        <div class="message-file-name">{{ message.file_name }}</div>
                        <div class="message-file-size">{{ message.file_size|filesizeformat }}</div>
                    </div>
                    <i class="fas fa-download"></i>
                </div>
                {% endif %}
                {% if message.content %}<div class="message-content">{{ message.content }}</div>{% endif %}
                <div class="message-footer">
                    <span>{{ message.created_at|time:"H:i" }}</span>
                    {% if message.sender == user %}
                    <span class="message-status">
                        {% if message.is_read %}
                        <i class="fas fa-check-double read"></i>
                        {% else %}
                        <i class="fas fa-check"></i>
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; color: #64748b; padding: 30px;">
                <p>Suhbatni boshlang! ðŸ’¬</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <span>yozmoqda...</span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area">
            <!-- File Preview -->
            <div class="file-preview-container" id="filePreview">
                <div id="filePreviewContent"></div>
                <div class="file-preview-info">
                    <div class="file-preview-name" id="filePreviewName"></div>
                    <div class="file-preview-size" id="filePreviewSize"></div>
                </div>
                <button class="file-preview-remove" onclick="removeSelectedFile()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="input-container">
                <div class="input-actions">
                    <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="Rasm/Fayl">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="input-btn" onclick="document.getElementById('imageInput').click()" title="Rasm">
                        <i class="fas fa-image"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt,.zip,.rar">
                <input type="file" id="imageInput" style="display: none;" accept="image/*,video/*">
                
                <textarea class="chat-textarea" id="messageInput" placeholder="Xabar yozing..." rows="1"></textarea>
                
                <button class="input-btn" onclick="toggleEmojiPicker()" title="Emoji">
                    <i class="fas fa-smile"></i>
                </button>
                
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Yuborish">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <!-- Emoji Picker -->
        <div class="emoji-picker-container" id="emojiPicker">
            <div class="emoji-header">
                <button class="emoji-tab-btn active" onclick="switchPickerTab('emoji')">ðŸ˜€ Emoji</button>
                <button class="emoji-tab-btn" onclick="switchPickerTab('sticker')">ðŸŽ¨ Stiker</button>
            </div>
            <div class="picker-content active" id="emojiContent">
                <div class="emoji-category-nav">
                    <button class="emoji-cat-btn active" data-cat="smileys">ðŸ˜€</button>
                    <button class="emoji-cat-btn" data-cat="gestures">ðŸ‘‹</button>
                    <button class="emoji-cat-btn" data-cat="hearts">â¤ï¸</button>
                    <button class="emoji-cat-btn" data-cat="animals">ðŸ¶</button>
                    <button class="emoji-cat-btn" data-cat="food">ðŸ•</button>
                    <button class="emoji-cat-btn" data-cat="objects">ðŸ’¡</button>
                </div>
                <div class="emoji-grid-content" id="emojiGrid"></div>
            </div>
            <div class="picker-content" id="stickerContent">
                <div class="sticker-grid-content" id="stickerGrid"></div>
            </div>
        </div>
        
        <!-- Image Viewer Modal -->
        <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
            <button class="image-viewer-close"><i class="fas fa-times"></i></button>
            <img id="viewerImage" src="" alt="Katta rasm">
        </div>
        
        {% else %}
        <!-- Empty State -->
        <div class="empty-chat">
            <i class="fas fa-comments"></i>
            <h3>Xush kelibsiz!</h3>
            <p>Suhbat boshlash uchun chap paneldan tanlang</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// ========== VARIABLES ==========
let lastMessageId = {% if messages %}{{ messages.last.id|default:0 }}{% else %}0{% endif %};
let activeUsername = '{% if active_user %}{{ active_user.username }}{% endif %}';
let typingTimeout = null;

// ========== INDEXED DB - LOCAL FILE STORAGE ==========
let chatDB = null;
const DB_NAME = 'CloudstoreChatFiles';
const DB_VERSION = 1;

function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            chatDB = request.result;
            resolve(chatDB);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // Fayllar uchun store
            if (!db.objectStoreNames.contains('files')) {
                const fileStore = db.createObjectStore('files', { keyPath: 'id' });
                fileStore.createIndex('messageId', 'messageId', { unique: false });
                fileStore.createIndex('chatUsername', 'chatUsername', { unique: false });
            }
            
            // Metadata uchun store (fayl hajmi, nomi va h.k.)
            if (!db.objectStoreNames.contains('metadata')) {
                db.createObjectStore('metadata', { keyPath: 'id' });
            }
        };
    });
}

// Faylni local'ga saqlash
async function saveFileLocally(messageId, fileUrl, fileName, fileSize, chatUsername) {
    if (!chatDB) await initIndexedDB();
    
    try {
        // Fayl mavjudligini tekshirish
        const existing = await getLocalFile(messageId);
        if (existing) return existing;
        
        // Faylni serverdan yuklash
        const response = await fetch(fileUrl);
        const blob = await response.blob();
        
        const fileData = {
            id: `file_${messageId}`,
            messageId: messageId,
            chatUsername: chatUsername,
            fileName: fileName,
            fileSize: fileSize,
            fileType: blob.type,
            blob: blob,
            savedAt: new Date().toISOString()
        };
        
        return new Promise((resolve, reject) => {
            const transaction = chatDB.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            const request = store.put(fileData);
            
            request.onsuccess = () => {
                console.log(`ðŸ“ Fayl qurilmaga saqlandi: ${fileName}`);
                resolve(fileData);
            };
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error('Faylni saqlashda xatolik:', error);
        return null;
    }
}

// Local'dan faylni olish
async function getLocalFile(messageId) {
    if (!chatDB) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = chatDB.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.get(`file_${messageId}`);
        
        request.onsuccess = () => resolve(request.result || null);
        request.onerror = () => reject(request.error);
    });
}

// Faylni ochish (local yoki serverdan)
async function openFile(messageId, fileUrl, fileName, fileSize) {
    // Avval local'dan qidirish
    let fileData = await getLocalFile(messageId);
    
    if (fileData) {
        console.log(`ðŸ“‚ Local'dan ochildi: ${fileName}`);
        const url = URL.createObjectURL(fileData.blob);
        downloadOrOpen(url, fileName, fileData.fileType);
        return;
    }
    
    // Local'da yo'q - serverdan yuklab, local'ga saqlash
    console.log(`â¬‡ï¸ Serverdan yuklanmoqda: ${fileName}`);
    fileData = await saveFileLocally(messageId, fileUrl, fileName, fileSize, activeUsername);
    
    if (fileData) {
        const url = URL.createObjectURL(fileData.blob);
        downloadOrOpen(url, fileName, fileData.fileType);
    } else {
        // Fallback - to'g'ridan-to'g'ri serverdan
        window.open(fileUrl, '_blank');
    }
}

function downloadOrOpen(url, fileName, fileType) {
    if (fileType && fileType.startsWith('image/')) {
        openImageViewer(url);
    } else {
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
    }
}

// Chat uchun barcha local fayllarni olish
async function getChatLocalFiles(chatUsername) {
    if (!chatDB) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = chatDB.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const index = store.index('chatUsername');
        const request = index.getAll(chatUsername);
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
    });
}

// Local storage hajmini hisoblash
async function getLocalStorageSize() {
    if (!chatDB) await initIndexedDB();
    
    return new Promise((resolve) => {
        let totalSize = 0;
        const transaction = chatDB.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.openCursor();
        
        request.onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor) {
                if (cursor.value.blob) {
                    totalSize += cursor.value.blob.size;
                }
                cursor.continue();
            } else {
                resolve(totalSize);
            }
        };
        request.onerror = () => resolve(0);
    });
}

// Eski fayllarni tozalash (30 kundan eski)
async function cleanOldFiles() {
    if (!chatDB) await initIndexedDB();
    
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const transaction = chatDB.transaction(['files'], 'readwrite');
    const store = transaction.objectStore('files');
    const request = store.openCursor();
    
    request.onsuccess = (event) => {
        const cursor = event.target.result;
        if (cursor) {
            const savedAt = new Date(cursor.value.savedAt);
            if (savedAt < thirtyDaysAgo) {
                cursor.delete();
                console.log(`ðŸ—‘ï¸ Eski fayl o'chirildi: ${cursor.value.fileName}`);
            }
            cursor.continue();
        }
    };
}

// ========== EMOJI DATA ==========
const emojiData = {
    smileys: ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ˜‰', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ˜', 'ðŸ¤—', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜’', 'ðŸ™„', 'ðŸ˜¬', 'ðŸ˜Œ', 'ðŸ˜”', 'ðŸ˜ª', 'ðŸ¤¤', 'ðŸ˜´', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤¢', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ¥´', 'ðŸ˜µ', 'ðŸ¤¯', 'ðŸ¤ ', 'ðŸ¥³', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ§'],
    gestures: ['ðŸ‘‹', 'ðŸ¤š', 'ðŸ–ï¸', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤Œ', 'ðŸ¤', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ‘‡', 'â˜ï¸', 'ðŸ‘', 'ðŸ‘Ž', 'âœŠ', 'ðŸ‘Š', 'ðŸ¤›', 'ðŸ¤œ', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ‘', 'ðŸ¤²', 'ðŸ¤', 'ðŸ™', 'ðŸ’ª'],
    hearts: ['â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ¤Ž', 'ðŸ’”', 'â£ï¸', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ', 'ðŸ’Œ', 'ðŸ’', 'ðŸŒ¹', 'ðŸ¥€', 'ðŸŒ·'],
    animals: ['ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ¯', 'ðŸ¦', 'ðŸ®', 'ðŸ·', 'ðŸ¸', 'ðŸµ', 'ðŸ™ˆ', 'ðŸ™‰', 'ðŸ™Š', 'ðŸ”', 'ðŸ§', 'ðŸ¦', 'ðŸ¤', 'ðŸ¦†', 'ðŸ¦…', 'ðŸ¦‰', 'ðŸ¦‹', 'ðŸŒ', 'ðŸž'],
    food: ['ðŸ•', 'ðŸ”', 'ðŸŸ', 'ðŸŒ­', 'ðŸ¥ª', 'ðŸŒ®', 'ðŸŒ¯', 'ðŸ¥™', 'ðŸ³', 'ðŸ¥˜', 'ðŸ', 'ðŸœ', 'ðŸ›', 'ðŸ£', 'ðŸ±', 'ðŸ§', 'ðŸ°', 'ðŸŽ‚', 'ðŸ®', 'ðŸ­', 'ðŸ¬', 'ðŸ«', 'ðŸ©', 'ðŸª', 'â˜•', 'ðŸµ', 'ðŸ¥¤'],
    objects: ['ðŸ’¡', 'ðŸ”¦', 'ðŸ“±', 'ðŸ’»', 'ðŸ–¥ï¸', 'âŒ¨ï¸', 'ðŸ“·', 'ðŸ“¹', 'ðŸŽ¥', 'ðŸ“º', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸŽ¼', 'ðŸŽ¹', 'ðŸŽ¸', 'ðŸŽ®', 'ðŸŽ¯', 'ðŸŽ²', 'ðŸ”®', 'ðŸ’Ž', 'ðŸ’°', 'ðŸ“š', 'ðŸ“–', 'ðŸ”‘', 'ðŸ”’', 'âš™ï¸']
};

const stickerData = [
    'ðŸŽ‰', 'ðŸ¥³', 'ðŸŽŠ', 'ðŸŽ', 'ðŸŽˆ', 'ðŸŽ‚', 'ðŸ’–', 'ðŸ’', 'ðŸ’˜', 'ðŸ’•', 'ðŸ’ž', 'â¤ï¸â€ðŸ”¥',
    'ðŸ¤—', 'ðŸ¥°', 'ðŸ˜', 'ðŸ¤©', 'ðŸ˜˜', 'ðŸ˜»', 'ðŸ‘', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ’ª', 'âœŒï¸', 'ðŸ¤ž',
    'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜¹', 'ðŸ’€', 'ðŸ¤¡', 'ðŸ‘»', 'ðŸ”¥', 'âš¡', 'ðŸ’¥', 'âœ¨', 'ðŸŒŸ', 'ðŸ’«',
    'ðŸŒ¹', 'ðŸŒ¸', 'ðŸŒº', 'ðŸŒ»', 'ðŸŒ·', 'ðŸ’', 'ðŸš€', 'âœˆï¸', 'ðŸŒ', 'â­', 'ðŸŒ™', 'â˜€ï¸'
];

let currentEmojiCategory = 'smileys';

// ========== INIT ==========
let selectedFile = null;

document.addEventListener('DOMContentLoaded', async function() {
    // IndexedDB ni ishga tushirish
    await initIndexedDB();
    
    // Eski fayllarni tozalash
    cleanOldFiles();
    
    // Settings ni ishga tushirish
    initSettings();
    
    scrollToBottom();
    initEmojis();
    initTextarea();
    initMobileNav();
    initFileUpload();
    
    // iOS PWA: Klaviatura chiqganda scroll fix
    initIOSKeyboardFix();
    
    if (activeUsername) {
        setInterval(pollNewMessages, 2000);
        // Mobile: Show chat area if there's an active chat
        if (window.innerWidth <= 768) {
            document.getElementById('chatSidebar').classList.add('hidden');
            document.getElementById('chatMainArea').classList.add('active');
        }
    }
    
    // Category buttons
    document.querySelectorAll('.emoji-cat-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.emoji-cat-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentEmojiCategory = this.dataset.cat;
            renderEmojis();
        });
    });
});

// ========== FILE UPLOAD ==========
function initFileUpload() {
    const fileInput = document.getElementById('fileInput');
    const imageInput = document.getElementById('imageInput');
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
    if (imageInput) {
        imageInput.addEventListener('change', handleFileSelect);
    }
}

function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Max 10MB
    if (file.size > 10 * 1024 * 1024) {
        alert('Fayl hajmi 10MB dan oshmasligi kerak');
        return;
    }
    
    selectedFile = file;
    showFilePreview(file);
}

function showFilePreview(file) {
    const preview = document.getElementById('filePreview');
    const previewContent = document.getElementById('filePreviewContent');
    const previewName = document.getElementById('filePreviewName');
    const previewSize = document.getElementById('filePreviewSize');
    
    previewName.textContent = file.name;
    previewSize.textContent = formatFileSize(file.size);
    
    // Rasm yoki video
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContent.innerHTML = `<img src="${e.target.result}" class="file-preview-image">`;
        };
        reader.readAsDataURL(file);
    } else if (file.type.startsWith('video/')) {
        previewContent.innerHTML = `<div class="file-preview-icon"><i class="fas fa-video"></i></div>`;
    } else {
        const ext = file.name.split('.').pop().toLowerCase();
        let icon = 'fa-file';
        if (['pdf'].includes(ext)) icon = 'fa-file-pdf';
        else if (['doc', 'docx'].includes(ext)) icon = 'fa-file-word';
        else if (['xls', 'xlsx'].includes(ext)) icon = 'fa-file-excel';
        else if (['zip', 'rar'].includes(ext)) icon = 'fa-file-archive';
        previewContent.innerHTML = `<div class="file-preview-icon"><i class="fas ${icon}"></i></div>`;
    }
    
    preview.classList.add('show');
}

function removeSelectedFile() {
    selectedFile = null;
    document.getElementById('filePreview').classList.remove('show');
    document.getElementById('fileInput').value = '';
    document.getElementById('imageInput').value = '';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// ========== IMAGE VIEWER ==========
function openImageViewer(src) {
    const viewer = document.getElementById('imageViewer');
    const img = document.getElementById('viewerImage');
    img.src = src;
    viewer.classList.add('show');
}

function closeImageViewer() {
    document.getElementById('imageViewer').classList.remove('show');
}

// ========== iOS KEYBOARD FIX ==========
function initIOSKeyboardFix() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    if (isIOS || isPWA) {
        const messageInput = document.getElementById('messageInput');
        const chatContainer = document.querySelector('.telegram-chat-container');
        const inputArea = document.querySelector('.chat-input-area');
        
        if (messageInput && inputArea) {
            // Klaviatura ochilganda
            messageInput.addEventListener('focus', function() {
                setTimeout(() => {
                    // Scroll to bottom
                    scrollToBottom();
                    // Input ni ko'rinadigan qilish
                    inputArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 300);
            });
            
            // Visual Viewport API (zamonaviy brauzerlar uchun)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', function() {
                    const viewportHeight = window.visualViewport.height;
                    if (chatContainer) {
                        chatContainer.style.height = viewportHeight + 'px';
                    }
                    scrollToBottom();
                });
                
                window.visualViewport.addEventListener('scroll', function() {
                    if (inputArea) {
                        inputArea.style.transform = `translateY(${window.visualViewport.offsetTop}px)`;
                    }
                });
            }
        }
    }
}

// ========== MOBILE NAVIGATION ==========
function initMobileNav() {
    // Handle chat item clicks on mobile
    document.querySelectorAll('.chat-user-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                // Let the link navigate normally but also apply animation
                setTimeout(() => {
                    document.getElementById('chatSidebar').classList.add('hidden');
                    document.getElementById('chatMainArea').classList.add('active');
                }, 50);
            }
        });
    });
}

function goBackToList() {
    const sidebar = document.getElementById('chatSidebar');
    const mainArea = document.getElementById('chatMainArea');
    
    sidebar.classList.remove('hidden');
    mainArea.classList.remove('active');
    
    // Redirect to chat list on mobile
    if (window.innerWidth <= 768) {
        window.location.href = "{% url 'telegram_chat' %}";
    }
}

function scrollToBottom() {
    const area = document.getElementById('chatMessages');
    if (area) area.scrollTop = area.scrollHeight;
}

// ========== SEARCH ==========
let searchTimeout = null;
let currentSearchTab = 'all';

function setSearchTab(tab) {
    currentSearchTab = tab;
    
    // Update tab styles
    document.querySelectorAll('.search-filter-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
            btn.classList.add('active');
        }
    });
    
    // Re-search with new tab
    const query = document.getElementById('chatSearchInput').value.trim();
    performSearch(query);
}

function searchUsers(query) {
    query = query.trim();
    const clearBtn = document.getElementById('searchClearBtn');
    const searchResults = document.getElementById('searchResultsSection');
    const chatsSection = document.getElementById('chatsSection');
    
    // Show/hide clear button
    clearBtn.style.display = query ? 'block' : 'none';
    
    // If empty and tab is 'all', hide search results and show chats
    if (!query && currentSearchTab === 'all') {
        searchResults.style.display = 'none';
        chatsSection.style.display = 'block';
        return;
    }
    
    // Show search section, hide chats
    searchResults.style.display = 'block';
    chatsSection.style.display = 'none';
    
    // Debounce search
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        performSearch(query);
    }, 300);
}

function performSearch(query) {
    const searchResultsList = document.getElementById('searchResultsList');
    
    // Show loading
    searchResultsList.innerHTML = `
        <div class="search-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Qidirilmoqda...</p>
        </div>
    `;
    
    let url = `/users/?format=json&tab=${currentSearchTab}`;
    if (query) {
        url += `&q=${encodeURIComponent(query)}`;
    }
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.users.length > 0) {
            renderSearchResults(data.users, data.total_count);
        } else {
            let emptyMsg = 'Foydalanuvchi topilmadi';
            if (currentSearchTab === 'followers') {
                emptyMsg = 'Sizni hali hech kim kuzatmayapti';
            } else if (currentSearchTab === 'following') {
                emptyMsg = 'Siz hali hech kimni kuzatmayapsiz';
            } else if (currentSearchTab === 'discover') {
                emptyMsg = 'Tavsiyalar mavjud emas';
            }
            
            searchResultsList.innerHTML = `
                <div class="search-no-results">
                    <i class="fas fa-user-slash"></i>
                    <p>${emptyMsg}</p>
                </div>
            `;
            document.getElementById('searchResultsCount').textContent = '0';
        }
    })
    .catch(err => {
        console.error('Search error:', err);
        searchResultsList.innerHTML = `
            <div class="search-no-results">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Xatolik yuz berdi</p>
            </div>
        `;
    });
}

function renderSearchResults(users, totalCount) {
    const searchResultsList = document.getElementById('searchResultsList');
    const countEl = document.getElementById('searchResultsCount');
    
    countEl.textContent = totalCount;
    
    let html = '';
    users.forEach(user => {
        const initial = user.first_name ? user.first_name[0].toUpperCase() : user.username[0].toUpperCase();
        const avatarHtml = user.avatar 
            ? `<img src="${user.avatar}" class="search-result-avatar" alt="${user.username}">`
            : `<div class="search-result-avatar default">${initial}</div>`;
        
        const followBtnHtml = user.is_following 
            ? `<button class="search-follow-btn following" onclick="event.preventDefault(); toggleUserFollow('${user.username}', this)"><i class="fas fa-user-check"></i></button>`
            : `<button class="search-follow-btn" onclick="event.preventDefault(); toggleUserFollow('${user.username}', this)"><i class="fas fa-user-plus"></i></button>`;
        
        html += `
            <a href="/telegram-chat/${user.username}/" class="search-result-item">
                ${avatarHtml}
                <div class="search-result-info">
                    <div class="search-result-name">
                        ${user.first_name} ${user.last_name}
                        ${user.is_online ? '<span class="online-indicator"></span>' : ''}
                    </div>
                    <div class="search-result-username">@${user.username}</div>
                    <div class="search-result-stats">${user.followers_count || 0} kuzatuvchi</div>
                    ${user.bio ? `<div class="search-result-bio">${user.bio}</div>` : ''}
                </div>
                ${followBtnHtml}
            </a>
        `;
    });
    
    searchResultsList.innerHTML = html;
}

function toggleUserFollow(username, btn) {
    fetch(`/users/${username}/follow/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_following) {
                btn.classList.add('following');
                btn.innerHTML = '<i class="fas fa-user-check"></i>';
            } else {
                btn.classList.remove('following');
                btn.innerHTML = '<i class="fas fa-user-plus"></i>';
            }
        }
    });
}

function clearSearch() {
    const searchInput = document.getElementById('chatSearchInput');
    const searchResults = document.getElementById('searchResultsSection');
    const chatsSection = document.getElementById('chatsSection');
    
    searchInput.value = '';
    currentSearchTab = 'all';
    
    // Reset tab styles
    document.querySelectorAll('.search-filter-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === 'all') {
            btn.classList.add('active');
        }
    });
    
    // Hide search results, show chats
    searchResults.style.display = 'none';
    chatsSection.style.display = 'block';
    document.getElementById('searchClearBtn').style.display = 'none';
    searchInput.focus();
}

// ========== SETTINGS ==========
function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    const chatsSection = document.getElementById('chatsSection');
    const searchSection = document.getElementById('searchResultsSection');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        chatsSection.style.display = 'none';
        searchSection.style.display = 'none';
        loadCacheSize();
    } else {
        panel.style.display = 'none';
        chatsSection.style.display = 'block';
    }
}

async function loadCacheSize() {
    const size = await getLocalStorageSize();
    const el = document.getElementById('cacheSize');
    if (el) {
        el.textContent = formatFileSize(size);
    }
}

async function clearLocalFiles() {
    if (!chatDB) await initIndexedDB();
    
    if (confirm("Barcha keshni tozalashni xohlaysizmi?")) {
        const transaction = chatDB.transaction(['files'], 'readwrite');
        const store = transaction.objectStore('files');
        store.clear();
        
        transaction.oncomplete = () => {
            alert('Kesh tozalandi!');
            loadCacheSize();
        };
    }
}

// Initialize settings from localStorage
function initSettings() {
    // Notifications
    const notificationsToggle = document.getElementById('notificationsToggle');
    if (notificationsToggle) {
        notificationsToggle.checked = localStorage.getItem('notifications') !== 'false';
        notificationsToggle.addEventListener('change', function() {
            localStorage.setItem('notifications', this.checked);
        });
    }
    
    // Sounds
    const soundsToggle = document.getElementById('soundsToggle');
    if (soundsToggle) {
        soundsToggle.checked = localStorage.getItem('sounds') !== 'false';
        soundsToggle.addEventListener('change', function() {
            localStorage.setItem('sounds', this.checked);
        });
    }
}

// ========== TEXTAREA ==========
function initTextarea() {
    const input = document.getElementById('messageInput');
    if (!input) return;
    
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        handleTyping();
    });
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// ========== SEND MESSAGE ==========
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content && !selectedFile) return;
    if (!activeUsername) return;
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    sendBtn.disabled = true;
    
    // FormData uchun (fayl bilan)
    if (selectedFile) {
        const formData = new FormData();
        formData.append('content', content);
        formData.append('file', selectedFile);
        
        fetch(`/users/${activeUsername}/message/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            
            if (data.success) {
                appendMessage(data.message, true);
                input.value = '';
                input.style.height = 'auto';
                removeSelectedFile();
                scrollToBottom();
                lastMessageId = data.message.id;
            } else {
                alert(data.error || 'Xatolik!');
            }
        })
        .catch(err => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            console.error(err);
            alert('Yuborishda xatolik!');
        });
    } else {
        // Oddiy matn xabar
        fetch(`/users/${activeUsername}/message/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
        .then(r => r.json())
        .then(data => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            
            if (data.success) {
                appendMessage(data.message, true);
                input.value = '';
                input.style.height = 'auto';
                scrollToBottom();
                lastMessageId = data.message.id;
            } else {
                alert(data.error || 'Xatolik!');
            }
        })
        .catch(err => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            console.error(err);
        });
    }
}

function appendMessage(msg, isMine) {
    const area = document.getElementById('chatMessages');
    if (!area) return;
    
    const div = document.createElement('div');
    div.className = `message-bubble ${isMine ? 'sent' : 'received'}`;
    div.dataset.id = msg.id;
    
    let mediaHtml = '';
    if (msg.message_type === 'image' && msg.file_url) {
        mediaHtml = `<img src="${msg.file_url}" class="message-image" onclick="openFile(${msg.id}, '${msg.file_url}', '${msg.file_name || 'image'}', ${msg.file_size_bytes || 0})" alt="Rasm">`;
        // Avtomatik local'ga saqlash
        saveFileLocally(msg.id, msg.file_url, msg.file_name, msg.file_size_bytes, activeUsername);
    } else if (msg.message_type === 'file' && msg.file_url) {
        mediaHtml = `
            <div class="message-file" onclick="openFile(${msg.id}, '${msg.file_url}', '${msg.file_name || 'file'}', ${msg.file_size_bytes || 0})" style="cursor: pointer;">
                <div class="message-file-icon"><i class="fas fa-file"></i></div>
                <div class="message-file-info">
                    <div class="message-file-name">${msg.file_name || 'Fayl'}</div>
                    <div class="message-file-size">${msg.file_size || ''}</div>
                </div>
                <i class="fas fa-download"></i>
            </div>
        `;
        // Avtomatik local'ga saqlash
        saveFileLocally(msg.id, msg.file_url, msg.file_name, msg.file_size_bytes, activeUsername);
    }
    
    div.innerHTML = `
        ${mediaHtml}
        ${msg.content ? `<div class="message-content">${msg.content}</div>` : ''}
        <div class="message-footer">
            <span>${msg.created_at}</span>
            ${isMine ? '<span class="message-status"><i class="fas fa-check"></i></span>' : ''}
        </div>
    `;
    area.appendChild(div);
}

// ========== POLLING ==========
function pollNewMessages() {
    if (!activeUsername) return;
    
    fetch(`/api/chat/${activeUsername}/new/?last_id=${lastMessageId}`)
    .then(r => r.json())
    .then(data => {
        data.messages.forEach(msg => {
            appendMessage(msg, false);
            lastMessageId = Math.max(lastMessageId, msg.id);
        });
        
        if (data.messages.length > 0) scrollToBottom();
        
        // Typing
        const indicator = document.getElementById('typingIndicator');
        if (data.other_user && data.other_user.is_typing) {
            indicator.classList.add('show');
        } else {
            indicator.classList.remove('show');
        }
        
        // Status
        const status = document.getElementById('userStatus');
        if (status && data.other_user) {
            if (data.other_user.is_online) {
                status.textContent = 'Online';
                status.classList.remove('offline');
            } else if (data.other_user.last_seen) {
                status.textContent = data.other_user.last_seen;
                status.classList.add('offline');
            }
        }
    })
    .catch(err => console.log('Poll error:', err));
}

function handleTyping() {
    if (!activeUsername) return;
    
    fetch(`/api/chat/${activeUsername}/typing/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_typing: true })
    });
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        fetch(`/api/chat/${activeUsername}/typing/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_typing: false })
        });
    }, 3000);
}

// ========== EMOJI PICKER ==========
function toggleEmojiPicker() {
    document.getElementById('emojiPicker').classList.toggle('show');
}

function switchPickerTab(tab) {
    document.querySelectorAll('.emoji-tab-btn').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.picker-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    
    if (tab === 'emoji') {
        document.getElementById('emojiContent').classList.add('active');
    } else {
        document.getElementById('stickerContent').classList.add('active');
    }
}

function initEmojis() {
    renderEmojis();
    renderStickers();
}

function renderEmojis() {
    const grid = document.getElementById('emojiGrid');
    if (!grid) return;
    
    const emojis = emojiData[currentEmojiCategory] || [];
    grid.innerHTML = emojis.map(e => 
        `<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`
    ).join('');
}

function renderStickers() {
    const grid = document.getElementById('stickerGrid');
    if (!grid) return;
    
    grid.innerHTML = stickerData.map(s => 
        `<span class="sticker-item" onclick="sendSticker('${s}')">${s}</span>`
    ).join('');
}

function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    if (input) {
        input.value += emoji;
        input.focus();
    }
}

function sendSticker(sticker) {
    const input = document.getElementById('messageInput');
    if (input) {
        input.value = sticker;
        sendMessage();
    }
    document.getElementById('emojiPicker').classList.remove('show');
}

// Close picker on outside click
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    if (picker && !picker.contains(e.target) && !e.target.closest('.input-btn')) {
        picker.classList.remove('show');
    }
});

// Update online status
setInterval(() => {
    fetch('/api/online-status/').catch(() => {});
}, 30000);
</script>
{% endblock %}
