{% extends "blog/boshlash.html" %}
{% load static %}

{% block title %}Xabarlar | Cloudstore{% endblock %}

{% block page_title %}Xabarlar{% endblock %}

{% block extra_styles %}
    /* ========== HIDE MAIN SIDEBAR ========== */
    .sidebar {
        display: none !important;
    }
    
    .sidebar-overlay {
        display: none !important;
    }
    
    .app-container {
        display: block !important;
    }
    
    .main-content {
        width: 100% !important;
        margin-left: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
    }
    
    .page-header {
        display: none !important;
    }
    
    .content-area {
        padding: 0 !important;
        height: 100vh;
    }
    
    /* ========== TELEGRAM CHAT LAYOUT ========== */
    .telegram-chat-container {
        display: flex;
        height: calc(100vh - 0px);
        background: var(--bg-color);
    }
    
    /* ========== CHAT SIDEBAR (Foydalanuvchilar ro'yxati) ========== */
    .chat-sidebar {
        width: 350px;
        background: var(--card-bg);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    
    .chat-sidebar-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .home-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }
    
    .home-btn:hover {
        transform: scale(1.05);
    }
    
    .chat-search-box {
        flex: 1;
        position: relative;
    }
    
    .chat-search-box input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border: none;
        border-radius: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.95rem;
    }
    
    .chat-search-box input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }
    
    .chat-search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
    }
    
    .new-chat-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-color);
        border: none;
        color: var(--text-color);
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .new-chat-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }
    
    /* Chat List */
    .chat-user-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }
    
    .chat-user-list::-webkit-scrollbar {
        width: 5px;
    }
    
    .chat-user-list::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
    }
    
    .chat-user-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: var(--text-color);
        margin-bottom: 4px;
    }
    
    .chat-user-item:hover {
        background: rgba(102, 126, 234, 0.08);
    }
    
    .chat-user-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
    }
    
    .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        position: relative;
    }
    
    .user-avatar.default {
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .user-avatar .online-dot {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background: #22c55e;
        border: 2px solid var(--card-bg);
        border-radius: 50%;
    }
    
    .user-info {
        flex: 1;
        min-width: 0;
    }
    
    .user-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .user-name {
        font-weight: 600;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .msg-time {
        font-size: 0.75rem;
        color: #64748b;
        flex-shrink: 0;
    }
    
    .user-bottom-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .last-msg {
        flex: 1;
        font-size: 0.85rem;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .unread-count {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 3px 8px;
        border-radius: 10px;
        min-width: 20px;
        text-align: center;
    }
    
    .empty-chats {
        text-align: center;
        padding: 50px 20px;
        color: #64748b;
    }
    
    .empty-chats i {
        font-size: 4rem;
        opacity: 0.2;
        margin-bottom: 20px;
    }
    
    .empty-chats a {
        color: #667eea;
        text-decoration: none;
        margin-top: 15px;
        display: inline-block;
    }
    
    /* ========== MAIN CHAT AREA ========== */
    .chat-main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-color);
        position: relative;
    }
    
    /* Background pattern */
    .chat-main-area::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23667eea' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 0;
    }
    
    /* Chat Header */
    .chat-header {
        padding: 12px 20px;
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 10;
    }
    
    .back-btn {
        display: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(102, 126, 234, 0.1);
        border: none;
        color: #667eea;
        font-size: 1.2rem;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .back-btn:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateX(-3px);
    }
    
    .chat-partner-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .chat-partner-avatar.default {
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    .chat-partner-info {
        flex: 1;
    }
    
    .chat-partner-name {
        font-weight: 600;
        font-size: 1rem;
    }
    
    .chat-partner-status {
        font-size: 0.8rem;
        color: #22c55e;
    }
    
    .chat-partner-status.offline {
        color: #64748b;
    }
    
    .chat-actions {
        display: flex;
        gap: 5px;
    }
    
    .chat-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chat-action-btn:hover {
        background: rgba(102, 126, 234, 0.1);
    }
    
    /* Messages Area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 1;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
    }
    
    .message-bubble {
        max-width: 65%;
        padding: 10px 14px;
        border-radius: 16px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message-bubble.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message-bubble.received {
        align-self: flex-start;
        background: var(--card-bg);
        color: var(--text-color);
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message-content {
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    .message-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 5px;
        margin-top: 5px;
        font-size: 0.7rem;
        opacity: 0.7;
    }
    
    .message-bubble.sent .message-footer {
        color: rgba(255,255,255,0.8);
    }
    
    .message-status .read {
        color: #60a5fa;
    }
    
    /* Typing Indicator */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        color: #64748b;
        font-size: 0.85rem;
        z-index: 1;
    }
    
    .typing-indicator.show {
        display: flex;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        background: #667eea;
        border-radius: 50%;
        animation: typingAnim 1.4s infinite;
        display: inline-block;
        margin-right: 3px;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnim {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-5px); opacity: 1; }
    }
    
    /* ========== INPUT AREA ========== */
    .chat-input-area {
        padding: 12px 20px 15px;
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
        z-index: 10;
    }
    
    .input-container {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        background: var(--bg-color);
        border-radius: 24px;
        padding: 6px;
    }
    
    .input-btn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: none;
        border: none;
        color: #64748b;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .input-btn:hover {
        color: #667eea;
    }
    
    .chat-textarea {
        flex: 1;
        border: none;
        background: none;
        padding: 8px 5px;
        font-size: 0.95rem;
        color: var(--text-color);
        resize: none;
        max-height: 100px;
        line-height: 1.4;
    }
    
    .chat-textarea:focus {
        outline: none;
    }
    
    .chat-textarea::placeholder {
        color: #64748b;
    }
    
    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s;
        flex-shrink: 0;
    }
    
    .send-btn:hover {
        transform: scale(1.05);
    }
    
    /* ========== EMPTY CHAT STATE ========== */
    .empty-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #64748b;
        z-index: 1;
    }
    
    .empty-chat i {
        font-size: 5rem;
        opacity: 0.2;
        margin-bottom: 25px;
    }
    
    .empty-chat h3 {
        margin-bottom: 10px;
        font-size: 1.3rem;
    }
    
    .empty-chat p {
        opacity: 0.8;
    }
    
    /* ========== EMOJI PICKER ========== */
    .emoji-picker-container {
        position: absolute;
        bottom: 80px;
        right: 20px;
        width: 320px;
        max-height: 350px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        display: none;
        z-index: 100;
        overflow: hidden;
    }
    
    .emoji-picker-container.show {
        display: block;
        animation: slideUp 0.2s ease;
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .emoji-header {
        display: flex;
        border-bottom: 1px solid var(--border-color);
    }
    
    .emoji-tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: none;
        color: var(--text-color);
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .emoji-tab-btn.active {
        color: #667eea;
        border-bottom: 2px solid #667eea;
    }
    
    .emoji-category-nav {
        display: flex;
        padding: 8px;
        gap: 5px;
        border-bottom: 1px solid var(--border-color);
        overflow-x: auto;
    }
    
    .emoji-cat-btn {
        padding: 8px;
        border: none;
        background: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .emoji-cat-btn:hover,
    .emoji-cat-btn.active {
        background: rgba(102, 126, 234, 0.1);
    }
    
    .emoji-grid-content {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        padding: 8px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .emoji-item {
        padding: 6px;
        text-align: center;
        cursor: pointer;
        border-radius: 6px;
        font-size: 1.3rem;
        transition: transform 0.1s;
    }
    
    .emoji-item:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: scale(1.15);
    }
    
    .sticker-grid-content {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 12px;
        max-height: 220px;
        overflow-y: auto;
    }
    
    .sticker-item {
        padding: 12px;
        text-align: center;
        cursor: pointer;
        border-radius: 12px;
        font-size: 2.2rem;
        background: rgba(102, 126, 234, 0.05);
        transition: all 0.2s;
    }
    
    .sticker-item:hover {
        background: rgba(102, 126, 234, 0.15);
        transform: scale(1.05);
    }
    
    .picker-content {
        display: none;
    }
    
    .picker-content.active {
        display: block;
    }
    
    /* ========== MOBILE RESPONSIVE ========== */
    @media (max-width: 768px) {
        .telegram-chat-container {
            position: relative;
        }
        
        .chat-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100% !important;
            max-width: 100% !important;
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chat-sidebar.hidden {
            transform: translateX(-100%);
        }
        
        .chat-main-area {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100% !important;
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chat-main-area.active {
            transform: translateX(0);
        }
        
        .back-btn {
            display: flex !important;
        }
        
        .chat-header-info h3 {
            font-size: 1rem;
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 10px 14px;
        }
        
        .message-input-area {
            padding: 10px;
        }
        
        .message-input-container input {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .emoji-sticker-picker {
            left: 5px;
            right: 5px;
            width: auto;
        }
        
        .chat-user-item {
            padding: 10px;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
        }
    }
    
    /* Small phones */
    @media (max-width: 380px) {
        .chat-header {
            padding: 10px;
        }
        
        .emoji-sticker-picker {
            height: 250px;
        }
        
        .emoji-grid, .sticker-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }
{% endblock %}

{% block content %}
<div class="telegram-chat-container">
    <!-- Left: Chat Users List -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <a href="{% url 'boshlash' %}" class="home-btn" title="Bosh sahifa">
                <i class="fas fa-home"></i>
            </a>
            <div class="chat-search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Foydalanuvchilarni qidirish..." id="chatSearchInput" onkeyup="searchChats()">
            </div>
            <a href="{% url 'search_users' %}" class="new-chat-btn" title="Yangi suhbat">
                <i class="fas fa-plus"></i>
            </a>
        </div>
        
        <div class="chat-user-list" id="chatUserList">
            {% for chat in chats %}
            <a href="{% url 'telegram_chat_with_user' chat.user.username %}" 
               class="chat-user-item {% if active_chat == chat.user.username %}active{% endif %}" 
               data-name="{{ chat.user.first_name|default:chat.user.username }} {{ chat.user.last_name }}"
               data-username="{{ chat.user.username }}">
                <div class="user-avatar {% if not chat.profile.avatar %}default{% endif %}">
                    {% if chat.profile.avatar %}
                    <img src="{{ chat.profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                    {% else %}
                    {{ chat.user.username|first|upper }}
                    {% endif %}
                    {% if chat.profile.is_online %}
                    <span class="online-dot"></span>
                    {% endif %}
                </div>
                <div class="user-info">
                    <div class="user-top-row">
                        <span class="user-name">{{ chat.user.first_name|default:chat.user.username }}</span>
                        <span class="msg-time">
                            {% if chat.last_message and chat.last_message.created_at %}
                            {{ chat.last_message.created_at|date:"H:i" }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="user-bottom-row">
                        <span class="last-msg">
                            {% if chat.last_message %}
                                {% if chat.last_message.sender == user %}Siz: {% endif %}
                                {{ chat.last_message.content|truncatechars:25 }}
                            {% else %}
                                Suhbatni boshlang
                            {% endif %}
                        </span>
                        {% if chat.unread_count > 0 %}
                        <span class="unread-count">{{ chat.unread_count }}</span>
                        {% endif %}
                    </div>
                </div>
            </a>
            {% empty %}
            <div class="empty-chats">
                <i class="fas fa-comments"></i>
                <p>Hali suhbatlar yo'q</p>
                <a href="{% url 'search_users' %}">
                    <i class="fas fa-user-plus"></i> Yangi suhbat boshlash
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Right: Chat Area -->
    <div class="chat-main-area {% if active_user %}active{% endif %}" id="chatMainArea">
        {% if active_user %}
        <!-- Chat Header -->
        <div class="chat-header">
            <button class="back-btn" onclick="goBackToList()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-partner-avatar {% if not active_profile.avatar %}default{% endif %}">
                {% if active_profile.avatar %}
                <img src="{{ active_profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                {% else %}
                {{ active_user.username|first|upper }}
                {% endif %}
            </div>
            <div class="chat-partner-info">
                <div class="chat-partner-name">{{ active_user.first_name|default:active_user.username }} {{ active_user.last_name }}</div>
                <div class="chat-partner-status {% if not active_profile.is_online %}offline{% endif %}" id="userStatus">
                    {% if active_profile.show_online_status %}
                        {% if active_profile.is_online %}Online{% else %}{{ active_profile.get_online_status_display }}{% endif %}
                    {% else %}
                        oxirgi faollik yashirin
                    {% endif %}
                </div>
            </div>
            <div class="chat-actions">
                <a href="{% url 'user_profile' active_user.username %}" class="chat-action-btn" title="Profil">
                    <i class="fas fa-user"></i>
                </a>
            </div>
        </div>
        
        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}" data-id="{{ message.id }}">
                <div class="message-content">{{ message.content }}</div>
                <div class="message-footer">
                    <span>{{ message.created_at|time:"H:i" }}</span>
                    {% if message.sender == user %}
                    <span class="message-status">
                        {% if message.is_read %}
                        <i class="fas fa-check-double read"></i>
                        {% else %}
                        <i class="fas fa-check"></i>
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; color: #64748b; padding: 30px;">
                <p>Suhbatni boshlang! ğŸ’¬</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <span>yozmoqda...</span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area">
            <div class="input-container">
                <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="Fayl yuklash">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx">
                
                <textarea class="chat-textarea" id="messageInput" placeholder="Xabar yozing..." rows="1"></textarea>
                
                <button class="input-btn" onclick="toggleEmojiPicker()" title="Emoji">
                    <i class="fas fa-smile"></i>
                </button>
                
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Yuborish">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <!-- Emoji Picker -->
        <div class="emoji-picker-container" id="emojiPicker">
            <div class="emoji-header">
                <button class="emoji-tab-btn active" onclick="switchPickerTab('emoji')">ğŸ˜€ Emoji</button>
                <button class="emoji-tab-btn" onclick="switchPickerTab('sticker')">ğŸ¨ Stiker</button>
            </div>
            <div class="picker-content active" id="emojiContent">
                <div class="emoji-category-nav">
                    <button class="emoji-cat-btn active" data-cat="smileys">ğŸ˜€</button>
                    <button class="emoji-cat-btn" data-cat="gestures">ğŸ‘‹</button>
                    <button class="emoji-cat-btn" data-cat="hearts">â¤ï¸</button>
                    <button class="emoji-cat-btn" data-cat="animals">ğŸ¶</button>
                    <button class="emoji-cat-btn" data-cat="food">ğŸ•</button>
                    <button class="emoji-cat-btn" data-cat="objects">ğŸ’¡</button>
                </div>
                <div class="emoji-grid-content" id="emojiGrid"></div>
            </div>
            <div class="picker-content" id="stickerContent">
                <div class="sticker-grid-content" id="stickerGrid"></div>
            </div>
        </div>
        
        {% else %}
        <!-- Empty State -->
        <div class="empty-chat">
            <i class="fas fa-comments"></i>
            <h3>Xush kelibsiz!</h3>
            <p>Suhbat boshlash uchun chap paneldan tanlang</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// ========== VARIABLES ==========
let lastMessageId = {% if messages %}{{ messages.last.id|default:0 }}{% else %}0{% endif %};
let activeUsername = '{% if active_user %}{{ active_user.username }}{% endif %}';
let typingTimeout = null;

// ========== EMOJI DATA ==========
const emojiData = {
    smileys: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ˜‰', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§'],
    gestures: ['ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'ğŸ’ª'],
    hearts: ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’Œ', 'ğŸ’', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒ·'],
    animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ'],
    food: ['ğŸ•', 'ğŸ”', 'ğŸŸ', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ¥™', 'ğŸ³', 'ğŸ¥˜', 'ğŸ', 'ğŸœ', 'ğŸ›', 'ğŸ£', 'ğŸ±', 'ğŸ§', 'ğŸ°', 'ğŸ‚', 'ğŸ®', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ©', 'ğŸª', 'â˜•', 'ğŸµ', 'ğŸ¥¤'],
    objects: ['ğŸ’¡', 'ğŸ”¦', 'ğŸ“±', 'ğŸ’»', 'ğŸ–¥ï¸', 'âŒ¨ï¸', 'ğŸ“·', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“º', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¸', 'ğŸ®', 'ğŸ¯', 'ğŸ²', 'ğŸ”®', 'ğŸ’', 'ğŸ’°', 'ğŸ“š', 'ğŸ“–', 'ğŸ”‘', 'ğŸ”’', 'âš™ï¸']
};

const stickerData = [
    'ğŸ‰', 'ğŸ¥³', 'ğŸŠ', 'ğŸ', 'ğŸˆ', 'ğŸ‚', 'ğŸ’–', 'ğŸ’', 'ğŸ’˜', 'ğŸ’•', 'ğŸ’', 'â¤ï¸â€ğŸ”¥',
    'ğŸ¤—', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜»', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ’ª', 'âœŒï¸', 'ğŸ¤',
    'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜¹', 'ğŸ’€', 'ğŸ¤¡', 'ğŸ‘»', 'ğŸ”¥', 'âš¡', 'ğŸ’¥', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«',
    'ğŸŒ¹', 'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸ’', 'ğŸš€', 'âœˆï¸', 'ğŸŒ', 'â­', 'ğŸŒ™', 'â˜€ï¸'
];

let currentEmojiCategory = 'smileys';

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    initEmojis();
    initTextarea();
    initMobileNav();
    
    if (activeUsername) {
        setInterval(pollNewMessages, 2000);
        // Mobile: Show chat area if there's an active chat
        if (window.innerWidth <= 768) {
            document.getElementById('chatSidebar').classList.add('hidden');
            document.getElementById('chatMainArea').classList.add('active');
        }
    }
    
    // Category buttons
    document.querySelectorAll('.emoji-cat-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.emoji-cat-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentEmojiCategory = this.dataset.cat;
            renderEmojis();
        });
    });
});

// ========== MOBILE NAVIGATION ==========
function initMobileNav() {
    // Handle chat item clicks on mobile
    document.querySelectorAll('.chat-user-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                // Let the link navigate normally but also apply animation
                setTimeout(() => {
                    document.getElementById('chatSidebar').classList.add('hidden');
                    document.getElementById('chatMainArea').classList.add('active');
                }, 50);
            }
        });
    });
}

function goBackToList() {
    const sidebar = document.getElementById('chatSidebar');
    const mainArea = document.getElementById('chatMainArea');
    
    sidebar.classList.remove('hidden');
    mainArea.classList.remove('active');
    
    // Redirect to chat list on mobile
    if (window.innerWidth <= 768) {
        window.location.href = "{% url 'telegram_chat' %}";
    }
}

function scrollToBottom() {
    const area = document.getElementById('chatMessages');
    if (area) area.scrollTop = area.scrollHeight;
}

// ========== SEARCH ==========
function searchChats() {
    const query = document.getElementById('chatSearchInput').value.toLowerCase().trim();
    const items = document.querySelectorAll('.chat-user-item');
    
    items.forEach(item => {
        const name = (item.dataset.name || '').toLowerCase();
        const username = (item.dataset.username || '').toLowerCase();
        
        if (name.includes(query) || username.includes(query)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// ========== TEXTAREA ==========
function initTextarea() {
    const input = document.getElementById('messageInput');
    if (!input) return;
    
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        handleTyping();
    });
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// ========== SEND MESSAGE ==========
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content || !activeUsername) return;
    
    document.getElementById('sendBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/users/${activeUsername}/message/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: content })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('sendBtn').innerHTML = '<i class="fas fa-paper-plane"></i>';
        
        if (data.success) {
            appendMessage(data.message, true);
            input.value = '';
            input.style.height = 'auto';
            scrollToBottom();
            lastMessageId = data.message.id;
        } else {
            alert(data.error || 'Xatolik!');
        }
    })
    .catch(err => {
        document.getElementById('sendBtn').innerHTML = '<i class="fas fa-paper-plane"></i>';
        console.error(err);
    });
}

function appendMessage(msg, isMine) {
    const area = document.getElementById('chatMessages');
    if (!area) return;
    
    const div = document.createElement('div');
    div.className = `message-bubble ${isMine ? 'sent' : 'received'}`;
    div.dataset.id = msg.id;
    div.innerHTML = `
        <div class="message-content">${msg.content}</div>
        <div class="message-footer">
            <span>${msg.created_at}</span>
            ${isMine ? '<span class="message-status"><i class="fas fa-check"></i></span>' : ''}
        </div>
    `;
    area.appendChild(div);
}

// ========== POLLING ==========
function pollNewMessages() {
    if (!activeUsername) return;
    
    fetch(`/api/chat/${activeUsername}/new/?last_id=${lastMessageId}`)
    .then(r => r.json())
    .then(data => {
        data.messages.forEach(msg => {
            appendMessage(msg, false);
            lastMessageId = Math.max(lastMessageId, msg.id);
        });
        
        if (data.messages.length > 0) scrollToBottom();
        
        // Typing
        const indicator = document.getElementById('typingIndicator');
        if (data.other_user && data.other_user.is_typing) {
            indicator.classList.add('show');
        } else {
            indicator.classList.remove('show');
        }
        
        // Status
        const status = document.getElementById('userStatus');
        if (status && data.other_user) {
            if (data.other_user.is_online) {
                status.textContent = 'Online';
                status.classList.remove('offline');
            } else if (data.other_user.last_seen) {
                status.textContent = data.other_user.last_seen;
                status.classList.add('offline');
            }
        }
    })
    .catch(err => console.log('Poll error:', err));
}

function handleTyping() {
    if (!activeUsername) return;
    
    fetch(`/api/chat/${activeUsername}/typing/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_typing: true })
    });
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        fetch(`/api/chat/${activeUsername}/typing/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_typing: false })
        });
    }, 3000);
}

// ========== EMOJI PICKER ==========
function toggleEmojiPicker() {
    document.getElementById('emojiPicker').classList.toggle('show');
}

function switchPickerTab(tab) {
    document.querySelectorAll('.emoji-tab-btn').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.picker-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    
    if (tab === 'emoji') {
        document.getElementById('emojiContent').classList.add('active');
    } else {
        document.getElementById('stickerContent').classList.add('active');
    }
}

function initEmojis() {
    renderEmojis();
    renderStickers();
}

function renderEmojis() {
    const grid = document.getElementById('emojiGrid');
    if (!grid) return;
    
    const emojis = emojiData[currentEmojiCategory] || [];
    grid.innerHTML = emojis.map(e => 
        `<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`
    ).join('');
}

function renderStickers() {
    const grid = document.getElementById('stickerGrid');
    if (!grid) return;
    
    grid.innerHTML = stickerData.map(s => 
        `<span class="sticker-item" onclick="sendSticker('${s}')">${s}</span>`
    ).join('');
}

function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    if (input) {
        input.value += emoji;
        input.focus();
    }
}

function sendSticker(sticker) {
    const input = document.getElementById('messageInput');
    if (input) {
        input.value = sticker;
        sendMessage();
    }
    document.getElementById('emojiPicker').classList.remove('show');
}

// Close picker on outside click
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    if (picker && !picker.contains(e.target) && !e.target.closest('.input-btn')) {
        picker.classList.remove('show');
    }
});

// Update online status
setInterval(() => {
    fetch('/api/online-status/').catch(() => {});
}, 30000);
</script>
{% endblock %}
