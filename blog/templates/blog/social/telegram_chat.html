{% extends "blog/boshlash.html" %}
{% load static %}

{% block title %}Xabarlar | Cloudstore{% endblock %}

{% block page_title %}Xabarlar{% endblock %}

{% block extra_styles %}
    /* ========== HIDE MAIN SIDEBAR ========== */
    .sidebar, .sidebar-overlay, .menu-toggle-btn, .page-header, .messages-container {
        display: none !important;
    }
    
    .app-container {
        display: block !important;
    }
    
    .main-content {
        width: 100% !important;
        margin-left: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        height: 100vh !important;
    }
    
    .content-area {
        padding: 0 !important;
        margin: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
    }
    
    /* ========== TELEGRAM CHAT LAYOUT ========== */
    .telegram-chat-container {
        display: flex;
        height: 100vh;
        background: var(--bg-color);
        overflow: hidden;
    }
    
    /* ========== CHAT SIDEBAR (Foydalanuvchilar ro'yxati) ========== */
    .chat-sidebar {
        width: 350px;
        background: var(--card-bg);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    
    .chat-sidebar-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .home-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }
    
    .home-btn:hover {
        transform: scale(1.05);
    }
    
    .chat-search-box {
        flex: 1;
        position: relative;
    }
    
    .chat-search-box input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border: none;
        border-radius: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        font-size: 0.95rem;
    }
    
    .chat-search-box input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }
    
    .chat-search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
    }
    
    .new-chat-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-color);
        border: none;
        color: var(--text-color);
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .new-chat-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }
    
    /* Chat List */
    .chat-user-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }
    
    .chat-user-list::-webkit-scrollbar {
        width: 5px;
    }
    
    .chat-user-list::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
    }
    
    .chat-user-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: var(--text-color);
        margin-bottom: 4px;
    }
    
    .chat-user-item:hover {
        background: rgba(102, 126, 234, 0.08);
    }
    
    .chat-user-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
    }
    
    .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        position: relative;
    }
    
    .user-avatar.default {
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .user-avatar .online-dot {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background: #22c55e;
        border: 2px solid var(--card-bg);
        border-radius: 50%;
    }
    
    .user-info {
        flex: 1;
        min-width: 0;
    }
    
    .user-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .user-name {
        font-weight: 600;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .msg-time {
        font-size: 0.75rem;
        color: #64748b;
        flex-shrink: 0;
    }
    
    .user-bottom-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .last-msg {
        flex: 1;
        font-size: 0.85rem;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .unread-count {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 3px 8px;
        border-radius: 10px;
        min-width: 20px;
        text-align: center;
    }
    
    .empty-chats {
        text-align: center;
        padding: 50px 20px;
        color: #64748b;
    }
    
    .empty-chats i {
        font-size: 4rem;
        opacity: 0.2;
        margin-bottom: 20px;
    }
    
    .empty-chats a {
        color: #667eea;
        text-decoration: none;
        margin-top: 15px;
        display: inline-block;
    }
    
    /* ========== MAIN CHAT AREA ========== */
    .chat-main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-color);
        position: relative;
        height: 100vh;
        min-height: 0;
        overflow: hidden;
    }
    
    /* Background pattern */
    .chat-main-area::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23667eea' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 0;
    }
    
    /* Chat Header */
    .chat-header {
        padding: 12px 20px;
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 10;
    }
    
    .back-btn {
        display: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(102, 126, 234, 0.1);
        border: none;
        color: #667eea;
        font-size: 1.2rem;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .back-btn:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateX(-3px);
    }
    
    .chat-partner-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .chat-partner-avatar.default {
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    .chat-partner-info {
        flex: 1;
    }
    
    .chat-partner-name {
        font-weight: 600;
        font-size: 1rem;
    }
    
    .chat-partner-status {
        font-size: 0.8rem;
        color: #22c55e;
    }
    
    .chat-partner-status.offline {
        color: #64748b;
    }
    
    .chat-actions {
        display: flex;
        gap: 5px;
    }
    
    .chat-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chat-action-btn:hover {
        background: rgba(102, 126, 234, 0.1);
    }
    
    /* Messages Area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 1;
        min-height: 0;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
    }
    
    .message-bubble {
        max-width: 65%;
        padding: 10px 14px;
        border-radius: 16px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message-bubble.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message-bubble.received {
        align-self: flex-start;
        background: var(--card-bg);
        color: var(--text-color);
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message-content {
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    .message-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 5px;
        margin-top: 5px;
        font-size: 0.7rem;
        opacity: 0.7;
    }
    
    .message-bubble.sent .message-footer {
        color: rgba(255,255,255,0.8);
    }
    
    .message-status .read {
        color: #60a5fa;
    }
    
    /* Typing Indicator */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        color: #64748b;
        font-size: 0.85rem;
        z-index: 1;
    }
    
    .typing-indicator.show {
        display: flex;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        background: #667eea;
        border-radius: 50%;
        animation: typingAnim 1.4s infinite;
        display: inline-block;
        margin-right: 3px;
    }
    
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnim {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-5px); opacity: 1; }
    }
    
    /* ========== INPUT AREA ========== */
    .chat-input-area {
        padding: 10px 15px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
        z-index: 100;
        flex-shrink: 0;
        position: sticky;
        bottom: 0;
    }
    
    /* File Preview */
    .file-preview-container {
        display: none;
        padding: 10px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 12px;
        margin-bottom: 10px;
        align-items: center;
        gap: 10px;
    }
    
    .file-preview-container.show {
        display: flex;
    }
    
    .file-preview-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
    }
    
    .file-preview-icon {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }
    
    .file-preview-info {
        flex: 1;
    }
    
    .file-preview-name {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 3px;
        word-break: break-all;
    }
    
    .file-preview-size {
        font-size: 0.8rem;
        color: #64748b;
    }
    
    .file-preview-remove {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(239, 68, 68, 0.1);
        border: none;
        color: #ef4444;
        cursor: pointer;
        font-size: 1rem;
    }
    
    .input-container {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        background: var(--bg-color);
        border-radius: 24px;
        padding: 5px 8px;
    }
    
    .input-actions {
        display: flex;
        align-items: center;
    }
    
    .input-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: none;
        border: none;
        color: #64748b;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .input-btn:hover {
        color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }
    
    .chat-textarea {
        flex: 1;
        border: none;
        background: none;
        padding: 8px 5px;
        font-size: 0.95rem;
        color: var(--text-color);
        resize: none;
        max-height: 100px;
        line-height: 1.4;
        min-height: 36px;
    }
    
    .chat-textarea:focus {
        outline: none;
    }
    
    .chat-textarea::placeholder {
        color: #64748b;
    }
    
    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .send-btn:hover {
        transform: scale(1.05);
    }
    
    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Message Media Styles */
    .message-image {
        max-width: 250px;
        max-height: 300px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .message-image:hover {
        transform: scale(1.02);
    }
    
    .message-video {
        max-width: 300px;
        max-height: 250px;
        border-radius: 12px;
    }
    
    .message-file {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        text-decoration: none;
        color: inherit;
    }
    
    .message-file-icon {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .message-file-info {
        flex: 1;
    }
    
    .message-file-name {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 2px;
    }
    
    .message-file-size {
        font-size: 0.75rem;
        opacity: 0.7;
    }
    
    /* Image Viewer Modal */
    .image-viewer {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.95);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }
    
    .image-viewer.show {
        display: flex;
    }
    
    .image-viewer img {
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
    }
    
    .image-viewer-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    /* ========== EMPTY CHAT STATE ========== */
    .empty-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #64748b;
        z-index: 1;
    }
    
    .empty-chat i {
        font-size: 5rem;
        opacity: 0.2;
        margin-bottom: 25px;
    }
    
    .empty-chat h3 {
        margin-bottom: 10px;
        font-size: 1.3rem;
    }
    
    .empty-chat p {
        opacity: 0.8;
    }
    
    /* ========== EMOJI PICKER ========== */
    .emoji-picker-container {
        position: absolute;
        bottom: 80px;
        right: 20px;
        width: 320px;
        max-height: 350px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        display: none;
        z-index: 100;
        overflow: hidden;
    }
    
    .emoji-picker-container.show {
        display: block;
        animation: slideUp 0.2s ease;
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .emoji-header {
        display: flex;
        border-bottom: 1px solid var(--border-color);
    }
    
    .emoji-tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: none;
        color: var(--text-color);
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .emoji-tab-btn.active {
        color: #667eea;
        border-bottom: 2px solid #667eea;
    }
    
    .emoji-category-nav {
        display: flex;
        padding: 8px;
        gap: 5px;
        border-bottom: 1px solid var(--border-color);
        overflow-x: auto;
    }
    
    .emoji-cat-btn {
        padding: 8px;
        border: none;
        background: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .emoji-cat-btn:hover,
    .emoji-cat-btn.active {
        background: rgba(102, 126, 234, 0.1);
    }
    
    .emoji-grid-content {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        padding: 8px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .emoji-item {
        padding: 6px;
        text-align: center;
        cursor: pointer;
        border-radius: 6px;
        font-size: 1.3rem;
        transition: transform 0.1s;
    }
    
    .emoji-item:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: scale(1.15);
    }
    
    .sticker-grid-content {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 12px;
        max-height: 220px;
        overflow-y: auto;
    }
    
    .sticker-item {
        padding: 12px;
        text-align: center;
        cursor: pointer;
        border-radius: 12px;
        font-size: 2.2rem;
        background: rgba(102, 126, 234, 0.05);
        transition: all 0.2s;
    }
    
    .sticker-item:hover {
        background: rgba(102, 126, 234, 0.15);
        transform: scale(1.05);
    }
    
    .picker-content {
        display: none;
    }
    
    .picker-content.active {
        display: block;
    }
    
    /* ========== MOBILE RESPONSIVE ========== */
    @media (max-width: 768px) {
        .telegram-chat-container {
            position: relative;
        }
        
        .chat-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 100% !important;
            max-width: 100% !important;
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chat-sidebar.hidden {
            transform: translateX(-100%);
        }
        
        .chat-main-area {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100% !important;
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        .chat-main-area.active {
            transform: translateX(0);
        }
        
        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px 15px 15px;
            z-index: 1001;
        }
        
        .chat-messages {
            padding-bottom: 80px;
        }
        
        .back-btn {
            display: flex !important;
        }
        
        .chat-header-info h3 {
            font-size: 1rem;
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 10px 14px;
        }
        
        .message-input-area {
            padding: 10px;
        }
        
        .message-input-container input {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .emoji-sticker-picker {
            left: 5px;
            right: 5px;
            width: auto;
        }
        
        .chat-user-item {
            padding: 10px;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
        }
    }
    
    /* Small phones */
    @media (max-width: 380px) {
        .chat-header {
            padding: 10px;
        }
        
        .emoji-sticker-picker {
            height: 250px;
        }
        
        .emoji-grid, .sticker-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }
    
    /* ========== PWA / iOS SAFE AREA ========== */
    @supports (padding-top: env(safe-area-inset-top)) {
        .telegram-chat-container {
            height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            padding-top: env(safe-area-inset-top);
        }
        
        .chat-header {
            padding-top: calc(10px + env(safe-area-inset-top));
        }
        
        .chat-sidebar-header {
            padding-top: calc(15px + env(safe-area-inset-top));
        }
        
        .chat-input-area {
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
    }
    
    /* PWA standalone mode uchun */
    @media (display-mode: standalone) {
        .telegram-chat-container {
            height: 100vh;
            height: -webkit-fill-available;
        }
        
        .main-content, .content-area {
            height: 100vh !important;
            height: -webkit-fill-available !important;
        }
    }
    
    /* Klaviatura chiqganda input ko'tarilishi */
    @media (max-height: 500px) {
        .telegram-chat-container {
            height: 100%;
        }
        
        .chat-messages {
            max-height: 50vh;
        }
    }
{% endblock %}

{% block content %}
<div class="telegram-chat-container">
    <!-- Left: Chat Users List -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header">
            <a href="{% url 'boshlash' %}" class="home-btn" title="Bosh sahifa">
                <i class="fas fa-home"></i>
            </a>
            <div class="chat-search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Foydalanuvchilarni qidirish..." id="chatSearchInput" onkeyup="searchChats()">
            </div>
            <a href="{% url 'search_users' %}" class="new-chat-btn" title="Yangi suhbat">
                <i class="fas fa-plus"></i>
            </a>
        </div>
        
        <div class="chat-user-list" id="chatUserList">
            {% for chat in chats %}
            <a href="{% url 'telegram_chat_with_user' chat.user.username %}" 
               class="chat-user-item {% if active_chat == chat.user.username %}active{% endif %}" 
               data-name="{{ chat.user.first_name|default:chat.user.username }} {{ chat.user.last_name }}"
               data-username="{{ chat.user.username }}">
                <div class="user-avatar {% if not chat.profile.avatar %}default{% endif %}">
                    {% if chat.profile.avatar %}
                    <img src="{{ chat.profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                    {% else %}
                    {{ chat.user.username|first|upper }}
                    {% endif %}
                    {% if chat.profile.is_online %}
                    <span class="online-dot"></span>
                    {% endif %}
                </div>
                <div class="user-info">
                    <div class="user-top-row">
                        <span class="user-name">{{ chat.user.first_name|default:chat.user.username }}</span>
                        <span class="msg-time">
                            {% if chat.last_message and chat.last_message.created_at %}
                            {{ chat.last_message.created_at|date:"H:i" }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="user-bottom-row">
                        <span class="last-msg">
                            {% if chat.last_message %}
                                {% if chat.last_message.sender == user %}Siz: {% endif %}
                                {{ chat.last_message.content|truncatechars:25 }}
                            {% else %}
                                Suhbatni boshlang
                            {% endif %}
                        </span>
                        {% if chat.unread_count > 0 %}
                        <span class="unread-count">{{ chat.unread_count }}</span>
                        {% endif %}
                    </div>
                </div>
            </a>
            {% empty %}
            <div class="empty-chats">
                <i class="fas fa-comments"></i>
                <p>Hali suhbatlar yo'q</p>
                <a href="{% url 'search_users' %}">
                    <i class="fas fa-user-plus"></i> Yangi suhbat boshlash
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Right: Chat Area -->
    <div class="chat-main-area {% if active_user %}active{% endif %}" id="chatMainArea">
        {% if active_user %}
        <!-- Chat Header -->
        <div class="chat-header">
            <button class="back-btn" onclick="goBackToList()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-partner-avatar {% if not active_profile.avatar %}default{% endif %}">
                {% if active_profile.avatar %}
                <img src="{{ active_profile.avatar.url }}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                {% else %}
                {{ active_user.username|first|upper }}
                {% endif %}
            </div>
            <div class="chat-partner-info">
                <div class="chat-partner-name">{{ active_user.first_name|default:active_user.username }} {{ active_user.last_name }}</div>
                <div class="chat-partner-status {% if not active_profile.is_online %}offline{% endif %}" id="userStatus">
                    {% if active_profile.show_online_status %}
                        {% if active_profile.is_online %}Online{% else %}{{ active_profile.get_online_status_display }}{% endif %}
                    {% else %}
                        oxirgi faollik yashirin
                    {% endif %}
                </div>
            </div>
            <div class="chat-actions">
                <a href="{% url 'user_profile' active_user.username %}" class="chat-action-btn" title="Profil">
                    <i class="fas fa-user"></i>
                </a>
            </div>
        </div>
        
        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}" data-id="{{ message.id }}">
                {% if message.message_type == 'image' and message.file %}
                <img src="{{ message.file.url }}" class="message-image" onclick="openFile({{ message.id }}, '{{ message.file.url }}', '{{ message.file_name }}', {{ message.file_size }})" alt="Rasm">
                {% elif message.message_type == 'file' and message.file %}
                <div class="message-file" onclick="openFile({{ message.id }}, '{{ message.file.url }}', '{{ message.file_name }}', {{ message.file_size }})" style="cursor: pointer;">
                    <div class="message-file-icon"><i class="fas fa-file"></i></div>
                    <div class="message-file-info">
                        <div class="message-file-name">{{ message.file_name }}</div>
                        <div class="message-file-size">{{ message.file_size|filesizeformat }}</div>
                    </div>
                    <i class="fas fa-download"></i>
                </div>
                {% endif %}
                {% if message.content %}<div class="message-content">{{ message.content }}</div>{% endif %}
                <div class="message-footer">
                    <span>{{ message.created_at|time:"H:i" }}</span>
                    {% if message.sender == user %}
                    <span class="message-status">
                        {% if message.is_read %}
                        <i class="fas fa-check-double read"></i>
                        {% else %}
                        <i class="fas fa-check"></i>
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; color: #64748b; padding: 30px;">
                <p>Suhbatni boshlang! üí¨</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <span>yozmoqda...</span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area">
            <!-- File Preview -->
            <div class="file-preview-container" id="filePreview">
                <div id="filePreviewContent"></div>
                <div class="file-preview-info">
                    <div class="file-preview-name" id="filePreviewName"></div>
                    <div class="file-preview-size" id="filePreviewSize"></div>
                </div>
                <button class="file-preview-remove" onclick="removeSelectedFile()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="input-container">
                <div class="input-actions">
                    <button class="input-btn" onclick="document.getElementById('fileInput').click()" title="Rasm/Fayl">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="input-btn" onclick="document.getElementById('imageInput').click()" title="Rasm">
                        <i class="fas fa-image"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt,.zip,.rar">
                <input type="file" id="imageInput" style="display: none;" accept="image/*,video/*">
                
                <textarea class="chat-textarea" id="messageInput" placeholder="Xabar yozing..." rows="1"></textarea>
                
                <button class="input-btn" onclick="toggleEmojiPicker()" title="Emoji">
                    <i class="fas fa-smile"></i>
                </button>
                
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Yuborish">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <!-- Emoji Picker -->
        <div class="emoji-picker-container" id="emojiPicker">
            <div class="emoji-header">
                <button class="emoji-tab-btn active" onclick="switchPickerTab('emoji')">üòÄ Emoji</button>
                <button class="emoji-tab-btn" onclick="switchPickerTab('sticker')">üé® Stiker</button>
            </div>
            <div class="picker-content active" id="emojiContent">
                <div class="emoji-category-nav">
                    <button class="emoji-cat-btn active" data-cat="smileys">üòÄ</button>
                    <button class="emoji-cat-btn" data-cat="gestures">üëã</button>
                    <button class="emoji-cat-btn" data-cat="hearts">‚ù§Ô∏è</button>
                    <button class="emoji-cat-btn" data-cat="animals">üê∂</button>
                    <button class="emoji-cat-btn" data-cat="food">üçï</button>
                    <button class="emoji-cat-btn" data-cat="objects">üí°</button>
                </div>
                <div class="emoji-grid-content" id="emojiGrid"></div>
            </div>
            <div class="picker-content" id="stickerContent">
                <div class="sticker-grid-content" id="stickerGrid"></div>
            </div>
        </div>
        
        <!-- Image Viewer Modal -->
        <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
            <button class="image-viewer-close"><i class="fas fa-times"></i></button>
            <img id="viewerImage" src="" alt="Katta rasm">
        </div>
        
        {% else %}
        <!-- Empty State -->
        <div class="empty-chat">
            <i class="fas fa-comments"></i>
            <h3>Xush kelibsiz!</h3>
            <p>Suhbat boshlash uchun chap paneldan tanlang</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// ========== VARIABLES ==========
let lastMessageId = {% if messages %}{{ messages.last.id|default:0 }}{% else %}0{% endif %};
let activeUsername = '{% if active_user %}{{ active_user.username }}{% endif %}';
let typingTimeout = null;

// ========== INDEXED DB - LOCAL FILE STORAGE ==========
let chatDB = null;
const DB_NAME = 'CloudstoreChatFiles';
const DB_VERSION = 1;

function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            chatDB = request.result;
            resolve(chatDB);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // Fayllar uchun store
            if (!db.objectStoreNames.contains('files')) {
                const fileStore = db.createObjectStore('files', { keyPath: 'id' });
                fileStore.createIndex('messageId', 'messageId', { unique: false });
                fileStore.createIndex('chatUsername', 'chatUsername', { unique: false });
            }
            
            // Metadata uchun store (fayl hajmi, nomi va h.k.)
            if (!db.objectStoreNames.contains('metadata')) {
                db.createObjectStore('metadata', { keyPath: 'id' });
            }
        };
    });
}

// Faylni local'ga saqlash
async function saveFileLocally(messageId, fileUrl, fileName, fileSize, chatUsername) {
    if (!chatDB) await initIndexedDB();
    
    try {
        // Fayl mavjudligini tekshirish
        const existing = await getLocalFile(messageId);
        if (existing) return existing;
        
        // Faylni serverdan yuklash
        const response = await fetch(fileUrl);
        const blob = await response.blob();
        
        const fileData = {
            id: `file_${messageId}`,
            messageId: messageId,
            chatUsername: chatUsername,
            fileName: fileName,
            fileSize: fileSize,
            fileType: blob.type,
            blob: blob,
            savedAt: new Date().toISOString()
        };
        
        return new Promise((resolve, reject) => {
            const transaction = chatDB.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            const request = store.put(fileData);
            
            request.onsuccess = () => {
                console.log(`üìÅ Fayl qurilmaga saqlandi: ${fileName}`);
                resolve(fileData);
            };
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error('Faylni saqlashda xatolik:', error);
        return null;
    }
}

// Local'dan faylni olish
async function getLocalFile(messageId) {
    if (!chatDB) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = chatDB.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.get(`file_${messageId}`);
        
        request.onsuccess = () => resolve(request.result || null);
        request.onerror = () => reject(request.error);
    });
}

// Faylni ochish (local yoki serverdan)
async function openFile(messageId, fileUrl, fileName, fileSize) {
    // Avval local'dan qidirish
    let fileData = await getLocalFile(messageId);
    
    if (fileData) {
        console.log(`üìÇ Local'dan ochildi: ${fileName}`);
        const url = URL.createObjectURL(fileData.blob);
        downloadOrOpen(url, fileName, fileData.fileType);
        return;
    }
    
    // Local'da yo'q - serverdan yuklab, local'ga saqlash
    console.log(`‚¨áÔ∏è Serverdan yuklanmoqda: ${fileName}`);
    fileData = await saveFileLocally(messageId, fileUrl, fileName, fileSize, activeUsername);
    
    if (fileData) {
        const url = URL.createObjectURL(fileData.blob);
        downloadOrOpen(url, fileName, fileData.fileType);
    } else {
        // Fallback - to'g'ridan-to'g'ri serverdan
        window.open(fileUrl, '_blank');
    }
}

function downloadOrOpen(url, fileName, fileType) {
    if (fileType && fileType.startsWith('image/')) {
        openImageViewer(url);
    } else {
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
    }
}

// Chat uchun barcha local fayllarni olish
async function getChatLocalFiles(chatUsername) {
    if (!chatDB) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = chatDB.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const index = store.index('chatUsername');
        const request = index.getAll(chatUsername);
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
    });
}

// Local storage hajmini hisoblash
async function getLocalStorageSize() {
    if (!chatDB) await initIndexedDB();
    
    return new Promise((resolve) => {
        let totalSize = 0;
        const transaction = chatDB.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.openCursor();
        
        request.onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor) {
                if (cursor.value.blob) {
                    totalSize += cursor.value.blob.size;
                }
                cursor.continue();
            } else {
                resolve(totalSize);
            }
        };
        request.onerror = () => resolve(0);
    });
}

// Eski fayllarni tozalash (30 kundan eski)
async function cleanOldFiles() {
    if (!chatDB) await initIndexedDB();
    
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const transaction = chatDB.transaction(['files'], 'readwrite');
    const store = transaction.objectStore('files');
    const request = store.openCursor();
    
    request.onsuccess = (event) => {
        const cursor = event.target.result;
        if (cursor) {
            const savedAt = new Date(cursor.value.savedAt);
            if (savedAt < thirtyDaysAgo) {
                cursor.delete();
                console.log(`üóëÔ∏è Eski fayl o'chirildi: ${cursor.value.fileName}`);
            }
            cursor.continue();
        }
    };
}

// ========== EMOJI DATA ==========
const emojiData = {
    smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üòâ', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê'],
    gestures: ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', 'üí™'],
    hearts: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', 'üíå', 'üíê', 'üåπ', 'ü•Ä', 'üå∑'],
    animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶ã', 'üêå', 'üêû'],
    food: ['üçï', 'üçî', 'üçü', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü•ô', 'üç≥', 'ü•ò', 'üçù', 'üçú', 'üçõ', 'üç£', 'üç±', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üç©', 'üç™', '‚òï', 'üçµ', 'ü•§'],
    objects: ['üí°', 'üî¶', 'üì±', 'üíª', 'üñ•Ô∏è', '‚å®Ô∏è', 'üì∑', 'üìπ', 'üé•', 'üì∫', 'üé§', 'üéß', 'üéº', 'üéπ', 'üé∏', 'üéÆ', 'üéØ', 'üé≤', 'üîÆ', 'üíé', 'üí∞', 'üìö', 'üìñ', 'üîë', 'üîí', '‚öôÔ∏è']
};

const stickerData = [
    'üéâ', 'ü•≥', 'üéä', 'üéÅ', 'üéà', 'üéÇ', 'üíñ', 'üíù', 'üíò', 'üíï', 'üíû', '‚ù§Ô∏è‚Äçüî•',
    'ü§ó', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòª', 'üëç', 'üëè', 'üôå', 'üí™', '‚úåÔ∏è', 'ü§û',
    'üòÇ', 'ü§£', 'üòπ', 'üíÄ', 'ü§°', 'üëª', 'üî•', '‚ö°', 'üí•', '‚ú®', 'üåü', 'üí´',
    'üåπ', 'üå∏', 'üå∫', 'üåª', 'üå∑', 'üíê', 'üöÄ', '‚úàÔ∏è', 'üåç', '‚≠ê', 'üåô', '‚òÄÔ∏è'
];

let currentEmojiCategory = 'smileys';

// ========== INIT ==========
let selectedFile = null;

document.addEventListener('DOMContentLoaded', async function() {
    // IndexedDB ni ishga tushirish
    await initIndexedDB();
    
    // Eski fayllarni tozalash
    cleanOldFiles();
    
    scrollToBottom();
    initEmojis();
    initTextarea();
    initMobileNav();
    initFileUpload();
    
    // iOS PWA: Klaviatura chiqganda scroll fix
    initIOSKeyboardFix();
    
    if (activeUsername) {
        setInterval(pollNewMessages, 2000);
        // Mobile: Show chat area if there's an active chat
        if (window.innerWidth <= 768) {
            document.getElementById('chatSidebar').classList.add('hidden');
            document.getElementById('chatMainArea').classList.add('active');
        }
    }
    
    // Category buttons
    document.querySelectorAll('.emoji-cat-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.emoji-cat-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentEmojiCategory = this.dataset.cat;
            renderEmojis();
        });
    });
});

// ========== FILE UPLOAD ==========
function initFileUpload() {
    const fileInput = document.getElementById('fileInput');
    const imageInput = document.getElementById('imageInput');
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
    if (imageInput) {
        imageInput.addEventListener('change', handleFileSelect);
    }
}

function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Max 10MB
    if (file.size > 10 * 1024 * 1024) {
        alert('Fayl hajmi 10MB dan oshmasligi kerak');
        return;
    }
    
    selectedFile = file;
    showFilePreview(file);
}

function showFilePreview(file) {
    const preview = document.getElementById('filePreview');
    const previewContent = document.getElementById('filePreviewContent');
    const previewName = document.getElementById('filePreviewName');
    const previewSize = document.getElementById('filePreviewSize');
    
    previewName.textContent = file.name;
    previewSize.textContent = formatFileSize(file.size);
    
    // Rasm yoki video
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContent.innerHTML = `<img src="${e.target.result}" class="file-preview-image">`;
        };
        reader.readAsDataURL(file);
    } else if (file.type.startsWith('video/')) {
        previewContent.innerHTML = `<div class="file-preview-icon"><i class="fas fa-video"></i></div>`;
    } else {
        const ext = file.name.split('.').pop().toLowerCase();
        let icon = 'fa-file';
        if (['pdf'].includes(ext)) icon = 'fa-file-pdf';
        else if (['doc', 'docx'].includes(ext)) icon = 'fa-file-word';
        else if (['xls', 'xlsx'].includes(ext)) icon = 'fa-file-excel';
        else if (['zip', 'rar'].includes(ext)) icon = 'fa-file-archive';
        previewContent.innerHTML = `<div class="file-preview-icon"><i class="fas ${icon}"></i></div>`;
    }
    
    preview.classList.add('show');
}

function removeSelectedFile() {
    selectedFile = null;
    document.getElementById('filePreview').classList.remove('show');
    document.getElementById('fileInput').value = '';
    document.getElementById('imageInput').value = '';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// ========== IMAGE VIEWER ==========
function openImageViewer(src) {
    const viewer = document.getElementById('imageViewer');
    const img = document.getElementById('viewerImage');
    img.src = src;
    viewer.classList.add('show');
}

function closeImageViewer() {
    document.getElementById('imageViewer').classList.remove('show');
}

// ========== iOS KEYBOARD FIX ==========
function initIOSKeyboardFix() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    if (isIOS || isPWA) {
        const messageInput = document.getElementById('messageInput');
        const chatContainer = document.querySelector('.telegram-chat-container');
        const inputArea = document.querySelector('.chat-input-area');
        
        if (messageInput && inputArea) {
            // Klaviatura ochilganda
            messageInput.addEventListener('focus', function() {
                setTimeout(() => {
                    // Scroll to bottom
                    scrollToBottom();
                    // Input ni ko'rinadigan qilish
                    inputArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 300);
            });
            
            // Visual Viewport API (zamonaviy brauzerlar uchun)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', function() {
                    const viewportHeight = window.visualViewport.height;
                    if (chatContainer) {
                        chatContainer.style.height = viewportHeight + 'px';
                    }
                    scrollToBottom();
                });
                
                window.visualViewport.addEventListener('scroll', function() {
                    if (inputArea) {
                        inputArea.style.transform = `translateY(${window.visualViewport.offsetTop}px)`;
                    }
                });
            }
        }
    }
}

// ========== MOBILE NAVIGATION ==========
function initMobileNav() {
    // Handle chat item clicks on mobile
    document.querySelectorAll('.chat-user-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                // Let the link navigate normally but also apply animation
                setTimeout(() => {
                    document.getElementById('chatSidebar').classList.add('hidden');
                    document.getElementById('chatMainArea').classList.add('active');
                }, 50);
            }
        });
    });
}

function goBackToList() {
    const sidebar = document.getElementById('chatSidebar');
    const mainArea = document.getElementById('chatMainArea');
    
    sidebar.classList.remove('hidden');
    mainArea.classList.remove('active');
    
    // Redirect to chat list on mobile
    if (window.innerWidth <= 768) {
        window.location.href = "{% url 'telegram_chat' %}";
    }
}

function scrollToBottom() {
    const area = document.getElementById('chatMessages');
    if (area) area.scrollTop = area.scrollHeight;
}

// ========== SEARCH ==========
function searchChats() {
    const query = document.getElementById('chatSearchInput').value.toLowerCase().trim();
    const items = document.querySelectorAll('.chat-user-item');
    
    items.forEach(item => {
        const name = (item.dataset.name || '').toLowerCase();
        const username = (item.dataset.username || '').toLowerCase();
        
        if (name.includes(query) || username.includes(query)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// ========== TEXTAREA ==========
function initTextarea() {
    const input = document.getElementById('messageInput');
    if (!input) return;
    
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        handleTyping();
    });
    
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// ========== SEND MESSAGE ==========
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content && !selectedFile) return;
    if (!activeUsername) return;
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    sendBtn.disabled = true;
    
    // FormData uchun (fayl bilan)
    if (selectedFile) {
        const formData = new FormData();
        formData.append('content', content);
        formData.append('file', selectedFile);
        
        fetch(`/users/${activeUsername}/message/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            
            if (data.success) {
                appendMessage(data.message, true);
                input.value = '';
                input.style.height = 'auto';
                removeSelectedFile();
                scrollToBottom();
                lastMessageId = data.message.id;
            } else {
                alert(data.error || 'Xatolik!');
            }
        })
        .catch(err => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            console.error(err);
            alert('Yuborishda xatolik!');
        });
    } else {
        // Oddiy matn xabar
        fetch(`/users/${activeUsername}/message/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
        .then(r => r.json())
        .then(data => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            
            if (data.success) {
                appendMessage(data.message, true);
                input.value = '';
                input.style.height = 'auto';
                scrollToBottom();
                lastMessageId = data.message.id;
            } else {
                alert(data.error || 'Xatolik!');
            }
        })
        .catch(err => {
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.disabled = false;
            console.error(err);
        });
    }
}

function appendMessage(msg, isMine) {
    const area = document.getElementById('chatMessages');
    if (!area) return;
    
    const div = document.createElement('div');
    div.className = `message-bubble ${isMine ? 'sent' : 'received'}`;
    div.dataset.id = msg.id;
    
    let mediaHtml = '';
    if (msg.message_type === 'image' && msg.file_url) {
        mediaHtml = `<img src="${msg.file_url}" class="message-image" onclick="openFile(${msg.id}, '${msg.file_url}', '${msg.file_name || 'image'}', ${msg.file_size_bytes || 0})" alt="Rasm">`;
        // Avtomatik local'ga saqlash
        saveFileLocally(msg.id, msg.file_url, msg.file_name, msg.file_size_bytes, activeUsername);
    } else if (msg.message_type === 'file' && msg.file_url) {
        mediaHtml = `
            <div class="message-file" onclick="openFile(${msg.id}, '${msg.file_url}', '${msg.file_name || 'file'}', ${msg.file_size_bytes || 0})" style="cursor: pointer;">
                <div class="message-file-icon"><i class="fas fa-file"></i></div>
                <div class="message-file-info">
                    <div class="message-file-name">${msg.file_name || 'Fayl'}</div>
                    <div class="message-file-size">${msg.file_size || ''}</div>
                </div>
                <i class="fas fa-download"></i>
            </div>
        `;
        // Avtomatik local'ga saqlash
        saveFileLocally(msg.id, msg.file_url, msg.file_name, msg.file_size_bytes, activeUsername);
    }
    
    div.innerHTML = `
        ${mediaHtml}
        ${msg.content ? `<div class="message-content">${msg.content}</div>` : ''}
        <div class="message-footer">
            <span>${msg.created_at}</span>
            ${isMine ? '<span class="message-status"><i class="fas fa-check"></i></span>' : ''}
        </div>
    `;
    area.appendChild(div);
}

// ========== POLLING ==========
function pollNewMessages() {
    if (!activeUsername) return;
    
    fetch(`/api/chat/${activeUsername}/new/?last_id=${lastMessageId}`)
    .then(r => r.json())
    .then(data => {
        data.messages.forEach(msg => {
            appendMessage(msg, false);
            lastMessageId = Math.max(lastMessageId, msg.id);
        });
        
        if (data.messages.length > 0) scrollToBottom();
        
        // Typing
        const indicator = document.getElementById('typingIndicator');
        if (data.other_user && data.other_user.is_typing) {
            indicator.classList.add('show');
        } else {
            indicator.classList.remove('show');
        }
        
        // Status
        const status = document.getElementById('userStatus');
        if (status && data.other_user) {
            if (data.other_user.is_online) {
                status.textContent = 'Online';
                status.classList.remove('offline');
            } else if (data.other_user.last_seen) {
                status.textContent = data.other_user.last_seen;
                status.classList.add('offline');
            }
        }
    })
    .catch(err => console.log('Poll error:', err));
}

function handleTyping() {
    if (!activeUsername) return;
    
    fetch(`/api/chat/${activeUsername}/typing/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_typing: true })
    });
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        fetch(`/api/chat/${activeUsername}/typing/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_typing: false })
        });
    }, 3000);
}

// ========== EMOJI PICKER ==========
function toggleEmojiPicker() {
    document.getElementById('emojiPicker').classList.toggle('show');
}

function switchPickerTab(tab) {
    document.querySelectorAll('.emoji-tab-btn').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.picker-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    
    if (tab === 'emoji') {
        document.getElementById('emojiContent').classList.add('active');
    } else {
        document.getElementById('stickerContent').classList.add('active');
    }
}

function initEmojis() {
    renderEmojis();
    renderStickers();
}

function renderEmojis() {
    const grid = document.getElementById('emojiGrid');
    if (!grid) return;
    
    const emojis = emojiData[currentEmojiCategory] || [];
    grid.innerHTML = emojis.map(e => 
        `<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`
    ).join('');
}

function renderStickers() {
    const grid = document.getElementById('stickerGrid');
    if (!grid) return;
    
    grid.innerHTML = stickerData.map(s => 
        `<span class="sticker-item" onclick="sendSticker('${s}')">${s}</span>`
    ).join('');
}

function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    if (input) {
        input.value += emoji;
        input.focus();
    }
}

function sendSticker(sticker) {
    const input = document.getElementById('messageInput');
    if (input) {
        input.value = sticker;
        sendMessage();
    }
    document.getElementById('emojiPicker').classList.remove('show');
}

// Close picker on outside click
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    if (picker && !picker.contains(e.target) && !e.target.closest('.input-btn')) {
        picker.classList.remove('show');
    }
});

// Update online status
setInterval(() => {
    fetch('/api/online-status/').catch(() => {});
}, 30000);
</script>
{% endblock %}
